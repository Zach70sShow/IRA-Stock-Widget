<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Roth IRA Widget</title>

<style>
:root{
  color-scheme: dark;
  --bg:#0b1020;
  --card:rgba(255,255,255,.06);
  --stroke:rgba(255,255,255,.12);
  --text:#e9eefc;
  --muted:rgba(233,238,252,.7);
  --teal:#33e6d1;
  --green:#77ffb5;
  --red:#ff7a7a;
  --radius:18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  height:100vh;
  background:linear-gradient(180deg,#060b14,#0a1020);
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
}

.wrap{
  height:100%;
  padding:12px;
  display:flex;
}

.card{
  width:100%;
  border-radius:var(--radius);
  background:var(--card);
  border:1px solid var(--stroke);
  padding:18px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.symbol{
  font-size:48px;
  font-weight:900;
  letter-spacing:1px;
}

.sub{
  font-size:13px;
  color:var(--muted);
  margin-top:6px;
}

.priceBox{
  text-align:right;
}

.price{
  font-size:52px;
  font-weight:900;
}

.change{
  font-size:15px;
  font-weight:800;
}

.pos{color:var(--green)}
.neg{color:var(--red)}

/* STATUS BAR */
.statusRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:14px;
}

.pills{
  display:flex;
  gap:10px;
}

.pill{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
}

.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--teal);
  animation:breathe 1.6s ease-in-out infinite;
}

@keyframes breathe{
  0%{transform:scale(1);opacity:.7}
  50%{transform:scale(1.4);opacity:1}
  100%{transform:scale(1);opacity:.7}
}

.market.open{border-color:rgba(119,255,181,.4)}
.market.open .mDot{background:var(--green)}
.market.closed{border-color:rgba(255,122,122,.4)}
.market.closed .mDot{background:var(--red)}

.mDot{
  width:8px;
  height:8px;
  border-radius:50%;
}

/* FOOTER */
.footer{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div>
      <div class="header">
        <div>
          <div class="symbol" id="sym">—</div>
          <div class="sub" id="meta">—</div>
        </div>
        <div class="priceBox">
          <div class="price" id="price">—</div>
          <div class="change" id="change">—</div>
        </div>
      </div>

      <div class="statusRow">
        <div class="pills">
          <div class="pill"><span class="dot"></span>LIVE</div>
          <div class="pill market" id="market">
            <span class="mDot"></span><span id="marketText">—</span>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div id="total">—</div>
      <div id="next">—</div>
    </div>
  </div>
</div>

<script>
let config, quotes={}, seq=[], pos=0;

async function load(){
  config = await fetch("portfolio.json").then(r=>r.json());
  await fetchQuotes();
  buildWeighted();
  render();
  setInterval(fetchQuotes,30000);
  setInterval(nextItem, config.cycleSeconds*1000 || 5000);
  updateMarket();
  setInterval(updateMarket,60000);
}

async function fetchQuotes(){
  const syms = config.holdings.map(h=>h.symbol).join(",");
  const r = await fetch("/api/quotes?symbols="+syms);
  quotes = (await r.json()).quotes || {};
}

function buildWeighted(){
  seq=[];
  config.holdings.forEach((h,i)=>{
    const n = Math.max(1,Math.round(h.weight*100));
    for(let k=0;k<n;k++) seq.push(i);
  });
  seq.sort(()=>Math.random()-.5);
}

function nextItem(){
  pos=(pos+1)%seq.length;
  render();
}

function render(){
  const h = config.holdings[seq[pos]];
  const q = quotes[h.symbol];
  if(!q) return;

  document.getElementById("sym").textContent=h.symbol;
  document.getElementById("meta").textContent=`Weight ${h.weight}% · Qty ${h.qty}`;
  document.getElementById("price").textContent="$"+q.price.toFixed(2);

  const c = q.change;
  const el=document.getElementById("change");
  el.textContent=(c>=0?"+":"")+c.toFixed(2)+" ("+q.changesPercentage.toFixed(2)+"%)";
  el.className="change "+(c>=0?"pos":"neg");

  document.getElementById("total").textContent=
    "Est. total value: $"+config.total.toLocaleString();
  document.getElementById("next").textContent=
    "Next: "+config.holdings[seq[(pos+1)%seq.length]].symbol;
}

function updateMarket(){
  const b=document.getElementById("market");
  const t=document.getElementById("marketText");
  const et=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const d=et.getDay(), m=et.getHours()*60+et.getMinutes();
  const open=d>=1&&d<=5&&m>=570&&m<960;
  b.className="pill market "+(open?"open":"closed");
  t.textContent=open?"MARKET OPEN":"MARKET CLOSED";
}

load();
</script>
</body>
</html>
