<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phoenix Weather Radar (RadarV2)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg0:#070a0f; --bg1:#0b111a;
      --stroke: rgba(255,255,255,.09);
      --stroke2: rgba(255,255,255,.07);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --dim: rgba(255,255,255,.55);
      --teal: #28d7c3;
      --shadow: 0 16px 45px rgba(0,0,0,.45);
      --radius: 24px; --radius2: 18px;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; overflow:hidden;
      background:
        radial-gradient(1400px 900px at 65% 35%, rgba(40,215,195,.12), transparent 55%),
        radial-gradient(1200px 800px at 25% 80%, rgba(64,120,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body::before{
      content:""; position:fixed; inset:0;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,.045) 0px, rgba(255,255,255,.045) 2px, transparent 2px, transparent 10px);
      opacity:.25; pointer-events:none; mix-blend-mode: overlay;
    }

    .frame{
      position:fixed; inset:14px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      height:72px; display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      background:
        radial-gradient(900px 300px at 55% 30%, rgba(40,215,195,.20), transparent 60%),
        linear-gradient(180deg, rgba(10,18,26,.85), rgba(10,18,26,.55));
      border-bottom:1px solid var(--stroke2);
      backdrop-filter: blur(10px);
    }
    .left{ display:flex; align-items:baseline; gap:14px; min-width:0; }
    .clock{
      font-size:40px; font-weight:800; letter-spacing:.5px; line-height:1; white-space:nowrap;
      text-shadow: 0 2px 14px rgba(0,0,0,.35);
    }
    .meta{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .meta .line1{ font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 52vw; }
    .meta .line2{ font-size:12px; color:var(--dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 52vw; }
    .right{ display:flex; align-items:center; gap:10px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(10, 18, 26, .55);
      border:1px solid var(--stroke);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      user-select:none;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--teal); box-shadow: 0 0 0 3px rgba(40,215,195,.16); }
    .pill b{font-size:12px}
    .updated{ font-size:12px; color:var(--muted); }

    .content{
      position:absolute; left:12px; right:12px; top:84px; bottom:12px;
      border-radius: var(--radius2);
      background: rgba(5, 8, 12, .30);
      border:1px solid var(--stroke2);
      overflow:hidden;
    }

    .panelhead{
      position:absolute; left:0; right:0; top:0;
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.00));
      border-bottom:1px solid var(--stroke2);
      z-index: 500;
      pointer-events:none;
    }
    .paneltitle{ font-size:18px; font-weight:800; letter-spacing:.4px; }
    .modes{ display:flex; gap:8px; pointer-events:auto; }
    .btn{
      cursor:pointer;
      font-size:12px;
      color: rgba(255,255,255,.85);
      background: rgba(10,18,26,.55);
      border:1px solid rgba(40,215,195,.35);
      border-radius: 999px;
      padding: 6px 10px;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(40,215,195,.55); }
    .btn.active{
      background: rgba(40,215,195,.16);
      border-color: rgba(40,215,195,.75);
      box-shadow: 0 0 0 3px rgba(40,215,195,.10);
    }

    #map{ position:absolute; left:0; right:0; top:48px; bottom:0; }

    .leaflet-control-zoom a{
      background: rgba(10,18,26,.55) !important;
      color: rgba(255,255,255,.9) !important;
      border:1px solid var(--stroke) !important;
      backdrop-filter: blur(8px);
    }
    .leaflet-control-attribution{
      background: rgba(10,18,26,.35) !important;
      color: rgba(255,255,255,.6) !important;
      border-radius: 10px !important;
      border: 1px solid rgba(255,255,255,.06) !important;
      padding: 2px 8px !important;
    }

    .scanner{
      position:absolute; inset:48px 0 0 0;
      pointer-events:none; z-index: 450;
      mix-blend-mode: screen; opacity: .55;
      background:
        radial-gradient(circle at center, rgba(40,215,195,.13) 0%, rgba(40,215,195,.06) 25%, transparent 55%),
        repeating-radial-gradient(circle at center, rgba(255,255,255,.035) 0px, rgba(255,255,255,.035) 1px, transparent 1px, transparent 26px),
        repeating-linear-gradient(135deg, rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px, transparent 1px, transparent 10px);
    }
    .sweep{
      position:absolute; inset:48px 0 0 0;
      pointer-events:none; z-index: 460;
      opacity:.55; mix-blend-mode: screen;
      background: conic-gradient(from 0deg at 50% 50%, rgba(40,215,195,.00) 0deg, rgba(40,215,195,.00) 300deg, rgba(40,215,195,.30) 330deg, rgba(40,215,195,.00) 360deg);
      animation: sweep 4.8s linear infinite;
    }
    @keyframes sweep{ from{ transform: rotate(0deg); } to{ transform: rotate(360deg); } }
    .cleanOverlay .scanner,.cleanOverlay .sweep{ opacity:.35; }

    .statusbar{
      position:absolute; left:14px; bottom:14px;
      z-index: 600; display:flex; gap:10px;
      pointer-events:none;
    }
    .badge{
      display:flex; align-items:center; gap:8px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(10,18,26,.55);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      font-size:12px; color: rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .badge .dot{ width:7px; height:7px; }

    .toast{
      position:absolute; left:14px; right:14px;
      bottom:60px; z-index: 800;
      background: rgba(10,18,26,.72);
      border:1px solid rgba(255,99,99,.35);
      border-radius: 16px;
      padding: 12px 14px;
      display:none;
      backdrop-filter: blur(10px);
    }
    .toast b{ display:block; font-size:12px; color: rgba(255,255,255,.7); margin-bottom:4px;}
    .toast .small{ font-size:12px; color: rgba(255,255,255,.70); }

    .footer{ position:absolute; left:18px; bottom:10px; z-index: 650; font-size:12px; color: rgba(255,255,255,.55); pointer-events:none; }
    .footerR{ position:absolute; right:18px; bottom:10px; z-index: 650; font-size:12px; color: rgba(255,255,255,.60); pointer-events:none; }
  </style>
</head>

<body>
  <div class="frame">
    <div class="topbar">
      <div class="left">
        <div class="clock" id="clock">--:--</div>
        <div class="meta">
          <div class="line1" id="line1">Phoenix • Radar</div>
          <div class="line2" id="line2">Live radar overlay • RainViewer</div>
        </div>
      </div>
      <div class="right">
        <div class="updated" id="updated">Updated --:--</div>
        <div class="pill"><span class="dot"></span><b>LIVE</b></div>
      </div>
    </div>

    <div class="content" id="content">
      <div class="panelhead">
        <div class="paneltitle">PHOENIX WEATHER RADAR</div>
        <div class="modes">
          <div class="btn" id="btnMetro">Metro</div>
          <div class="btn" id="btnValley">Valley</div>
          <div class="btn active" id="btnRegional">Regional</div>
          <div class="btn" id="btnClean">Cleaner</div>
        </div>
      </div>

      <div id="map"></div>
      <div class="scanner"></div>
      <div class="sweep"></div>

      <div class="toast" id="toast">
        <b>RADAR NOTE</b>
        <div class="small" id="toastMsg"></div>
      </div>

      <div class="statusbar">
        <div class="badge"><span class="dot"></span>PHX LIVE RADAR</div>
        <div class="badge" id="frameBadge">Frame: -- • Zoom --</div>
      </div>

      <div class="footer">Edge Dashboard</div>
      <div class="footerR" id="footerR">Updated --:--</div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const PHX = { lat: 33.4484, lon: -112.0740 };

    // Use safer defaults (tiles are MUCH more consistently available here)
    const VIEWS = {
      metro:   { center: [PHX.lat, PHX.lon], zoom: 10.5 },
      valley:  { center: [PHX.lat, PHX.lon], zoom: 10.0 },
      regional:{ center: [PHX.lat, PHX.lon], zoom: 9.0  }
    };

    const RADAR = { color: 2, smooth: 1, snow: 1, opacity: 0.55 };

    // Animation like your earlier version
    const ANIM = { enabled: true, msPerFrame: 850, refreshFramesMs: 120000 };

    // When tiles fail, how hard we try to recover
    const RECOVERY = {
      tileErrorsBeforeFallback: 12,   // number of tileerror events
      fallbackZoomStep: 1,            // zoom out 1 step
      maxFallbackZoomOut: 2,          // at most 2 zoom-out steps
      fallbackFrameStepsBack: 2,      // step back a couple frames if latest has holes
      coolDownMs: 2500                // don't spam recovery
    };

    // === UI helpers ===
    function pad(n){ return (n<10?'0':'')+n; }
    function fmtTime(d){
      let h = d.getHours();
      const m = pad(d.getMinutes());
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;
      return `${h}:${m} ${ampm}`;
    }
    function setUpdatedNow(){
      const now = new Date();
      document.getElementById('updated').textContent = `Updated ${fmtTime(now)}`;
      document.getElementById('footerR').textContent = `Updated ${fmtTime(now)}`;
    }
    function tickClock(){
      const now = new Date();
      const h = now.getHours();
      const m = pad(now.getMinutes());
      const ampm = h >= 12 ? 'PM' : 'AM';
      let hh = h % 12; if (hh === 0) hh = 12;
      document.getElementById('clock').textContent = `${pad(hh)}:${m} ${ampm}`;
    }
    function showToast(msg, isError=false){
      const toast = document.getElementById('toast');
      document.getElementById('toastMsg').textContent = msg;
      toast.style.borderColor = isError ? 'rgba(255,99,99,.40)' : 'rgba(40,215,195,.35)';
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display='none', 4200);
    }

    // === Map ===
    const map = L.map('map', { zoomControl:true, attributionControl:true, zoomSnap:0.25, zoomDelta:0.5 });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      subdomains:'abcd', maxZoom:19, attribution:'&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    L.circleMarker([PHX.lat, PHX.lon], { radius:5, color:'#28d7c3', weight:2, opacity:0.9, fillOpacity:0.08 }).addTo(map);
    map.setView(VIEWS.regional.center, VIEWS.regional.zoom);

    // === RainViewer ===
    let frames = [];          // [{ts, kind}]
    let idx = 0;
    let animTimer = null;
    let radarLayer = null;

    let tileErrCount = 0;
    let lastRecoveryAt = 0;
    let zoomFallbacksUsed = 0;

    function radarUrl(ts){
      return `https://tilecache.rainviewer.com/v2/radar/${ts}/{z}/{x}/{y}/${RADAR.color}/${RADAR.smooth}_${RADAR.snow}.png`;
    }

    function setFrameBadge(ts){
      const z = map.getZoom().toFixed(1);
      const d = new Date(ts * 1000);
      document.getElementById('frameBadge').textContent = `Frame: ${fmtTime(d)} • Zoom ${z}`;
    }

    function applyFrame(ts){
      if (!radarLayer){
        radarLayer = L.tileLayer(radarUrl(ts), {
          opacity: RADAR.opacity,
          zIndex: 250,
          maxZoom: 19,
          updateWhenIdle: true,
          keepBuffer: 2
        }).addTo(map);

        // Listen for tile loading failures and auto-recover
        radarLayer.on('tileerror', onTileError);
        radarLayer.on('tileload', () => { /* successful loads happen constantly */ });
      } else {
        radarLayer.setUrl(radarUrl(ts));
      }
      setFrameBadge(ts);
      setUpdatedNow();
    }

    async function loadFrames(){
      const res = await fetch('https://api.rainviewer.com/public/weather-maps.json', { cache:'no-store' });
      if (!res.ok) throw new Error(`Frames request failed (${res.status})`);
      const data = await res.json();

      const past = (data?.radar?.past || []).map(x => ({ ts:x.time, kind:'past' }));
      const nowc = (data?.radar?.nowcast || []).map(x => ({ ts:x.time, kind:'nowcast' }));

      const recentPast = past.slice(Math.max(0, past.length - 10));
      const recentNow  = nowc.slice(0, 6);

      frames = [...recentPast, ...recentNow];
      if (!frames.length) throw new Error('No frames returned by RainViewer');
      idx = frames.length - 1; // newest
    }

    function startAnim(){
      stopAnim();
      if (!ANIM.enabled) return;
      if (frames.length <= 1) return;
      animTimer = setInterval(() => {
        idx = (idx + 1) % frames.length;
        tileErrCount = 0; // reset per frame change
        applyFrame(frames[idx].ts);
      }, ANIM.msPerFrame);
    }

    function stopAnim(){
      if (animTimer) clearInterval(animTimer);
      animTimer = null;
    }

    function onTileError(e){
      tileErrCount++;

      const now = Date.now();
      if (now - lastRecoveryAt < RECOVERY.coolDownMs) return;

      if (tileErrCount >= RECOVERY.tileErrorsBeforeFallback){
        lastRecoveryAt = now;

        // 1) Try stepping back a frame (often fixes “holey” newest frame)
        const back = Math.max(0, idx - RECOVERY.fallbackFrameStepsBack);
        if (back !== idx){
          idx = back;
          tileErrCount = 0;
          showToast('Radar tile missing — switching to a nearby frame…', false);
          applyFrame(frames[idx].ts);
          return;
        }

        // 2) If still bad, zoom out (tiles more likely at lower zoom)
        if (zoomFallbacksUsed < RECOVERY.maxFallbackZoomOut){
          zoomFallbacksUsed++;
          tileErrCount = 0;
          showToast('Radar tiles spotty at this zoom — zooming out for reliability…', false);
          map.setZoom(map.getZoom() - RECOVERY.fallbackZoomStep);
          return;
        }

        // 3) Give user a helpful note (but don’t kill the radar)
        tileErrCount = 0;
        showToast('Radar tiles are temporarily unavailable for this area/zoom. Try Regional or wait a minute.', true);
      }
    }

    // Buttons
    function setActive(id){
      ['btnMetro','btnValley','btnRegional'].forEach(x => {
        document.getElementById(x).classList.toggle('active', x === id);
      });
      zoomFallbacksUsed = 0; // new view = reset fallback budget
      tileErrCount = 0;
    }
    function setView(key){
      const v = VIEWS[key];
      map.setView(v.center, v.zoom, { animate:true, duration:0.55 });
      setUpdatedNow();
    }
    document.getElementById('btnMetro').addEventListener('click', ()=>{ setActive('btnMetro'); setView('metro'); });
    document.getElementById('btnValley').addEventListener('click', ()=>{ setActive('btnValley'); setView('valley'); });
    document.getElementById('btnRegional').addEventListener('click', ()=>{ setActive('btnRegional'); setView('regional'); });

    document.getElementById('btnClean').addEventListener('click', (e)=>{
      const on = document.getElementById('content').classList.toggle('cleanOverlay');
      e.currentTarget.classList.toggle('active', on);
    });

    // Boot
    tickClock();
    setUpdatedNow();
    setInterval(tickClock, 1000);
    setInterval(setUpdatedNow, 30000);

    (async function init(){
      try{
        await loadFrames();
        applyFrame(frames[idx].ts);
        startAnim();
      }catch(err){
        console.error(err);
        showToast(`Radar failed to initialize: ${err.message}`, true);
      }
    })();

    setInterval(async ()=>{
      try{
        await loadFrames();
        // keep viewing "near newest" after refresh
        idx = Math.max(0, frames.length - 1);
        tileErrCount = 0;
        applyFrame(frames[idx].ts);
        startAnim();
      }catch(e){
        console.warn('Frame refresh failed:', e);
      }
    }, ANIM.refreshFramesMs);
  </script>
</body>
</html>
