<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phoenix Weather Radar (RadarV2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b111a;
      --glass: rgba(18, 30, 40, .55);
      --glass2: rgba(14, 22, 32, .65);
      --stroke: rgba(255,255,255,.09);
      --stroke2: rgba(255,255,255,.07);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --dim: rgba(255,255,255,.55);
      --teal: #28d7c3;
      --teal2:#1aa79a;
      --good:#39e58c;
      --warn:#ffcc66;
      --bad:#ff6363;
      --shadow: 0 16px 45px rgba(0,0,0,.45);
      --radius: 24px;
      --radius2: 18px;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:
        radial-gradient(1400px 900px at 65% 35%, rgba(40,215,195,.12), transparent 55%),
        radial-gradient(1200px 800px at 25% 80%, rgba(64,120,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow:hidden;
    }

    /* subtle diagonal texture like old tiles */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        repeating-linear-gradient(135deg, rgba(255,255,255,.045) 0px, rgba(255,255,255,.045) 2px, transparent 2px, transparent 10px);
      opacity:.25;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .frame{
      position:fixed;
      inset:14px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      background:
        radial-gradient(900px 300px at 55% 30%, rgba(40,215,195,.20), transparent 60%),
        linear-gradient(180deg, rgba(10,18,26,.85), rgba(10,18,26,.55));
      border-bottom:1px solid var(--stroke2);
      backdrop-filter: blur(10px);
    }
    .left{
      display:flex; align-items:baseline; gap:14px; min-width:0;
    }
    .clock{
      font-size:40px;
      font-weight:800;
      letter-spacing:.5px;
      line-height:1;
      white-space:nowrap;
      text-shadow: 0 2px 14px rgba(0,0,0,.35);
    }
    .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .meta .line1{
      font-size:13px;
      color:var(--muted);
      letter-spacing:.25px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 52vw;
    }
    .meta .line2{
      font-size:12px;
      color:var(--dim);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 52vw;
    }
    .right{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(10, 18, 26, .55);
      border:1px solid var(--stroke);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--teal);
      box-shadow: 0 0 0 3px rgba(40,215,195,.16);
    }
    .pill b{font-size:12px; letter-spacing:.3px}
    .updated{
      font-size:12px;
      color:var(--muted);
    }

    /* Main content */
    .content{
      position:absolute;
      left:12px; right:12px;
      top:84px; bottom:12px;
      border-radius: var(--radius2);
      background: rgba(5, 8, 12, .30);
      border:1px solid var(--stroke2);
      overflow:hidden;
    }

    /* Panel header inside content */
    .panelhead{
      position:absolute;
      left:0; right:0; top:0;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.00));
      border-bottom:1px solid var(--stroke2);
      z-index: 500; /* above map */
      pointer-events:none;
    }
    .paneltitle{
      font-size:18px;
      font-weight:800;
      letter-spacing:.4px;
      pointer-events:none;
    }
    .modes{
      display:flex; gap:8px;
      pointer-events:auto;
    }
    .btn{
      cursor:pointer;
      font-size:12px;
      color: rgba(255,255,255,.85);
      background: rgba(10,18,26,.55);
      border:1px solid rgba(40,215,195,.35);
      border-radius: 999px;
      padding: 6px 10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(40,215,195,.55); }
    .btn:active{ transform: translateY(0px); }
    .btn.active{
      background: rgba(40,215,195,.16);
      border-color: rgba(40,215,195,.75);
      box-shadow: 0 0 0 3px rgba(40,215,195,.10);
    }

    /* Map area */
    #map{
      position:absolute;
      left:0; right:0;
      top:48px; bottom:0;
    }

    /* Make Leaflet controls match the “Edge” vibe */
    .leaflet-control-zoom a{
      background: rgba(10,18,26,.55) !important;
      color: rgba(255,255,255,.9) !important;
      border:1px solid var(--stroke) !important;
      backdrop-filter: blur(8px);
    }
    .leaflet-control-zoom a:hover{
      background: rgba(20,34,48,.65) !important;
    }
    .leaflet-control-attribution{
      background: rgba(10,18,26,.35) !important;
      color: rgba(255,255,255,.6) !important;
      border-radius: 10px !important;
      border: 1px solid rgba(255,255,255,.06) !important;
      padding: 2px 8px !important;
    }

    /* Radar overlay “scanner” vibe */
    .scanner{
      position:absolute;
      inset:48px 0 0 0; /* align with map top */
      pointer-events:none;
      z-index: 450;
      mix-blend-mode: screen;
      opacity: .55;
      background:
        radial-gradient(circle at center, rgba(40,215,195,.13) 0%, rgba(40,215,195,.06) 25%, transparent 55%),
        repeating-radial-gradient(circle at center, rgba(255,255,255,.035) 0px, rgba(255,255,255,.035) 1px, transparent 1px, transparent 26px),
        repeating-linear-gradient(135deg, rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px, transparent 1px, transparent 10px);
    }
    .sweep{
      position:absolute;
      inset:48px 0 0 0;
      pointer-events:none;
      z-index: 460;
      opacity:.55;
      mix-blend-mode: screen;
      background: conic-gradient(from 0deg at 50% 50%, rgba(40,215,195,.00) 0deg, rgba(40,215,195,.00) 300deg, rgba(40,215,195,.30) 330deg, rgba(40,215,195,.00) 360deg);
      animation: sweep 4.8s linear infinite;
      filter: blur(.2px);
    }
    @keyframes sweep{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    /* Bottom-left status */
    .statusbar{
      position:absolute;
      left:14px;
      bottom:14px;
      z-index: 600;
      display:flex;
      align-items:center;
      gap:10px;
      pointer-events:none;
    }
    .badge{
      pointer-events:none;
      display:flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(10,18,26,.55);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.20);
      font-size:12px;
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .badge .dot{ width:7px; height:7px; }

    /* Error toast */
    .toast{
      position:absolute;
      left:14px;
      right:14px;
      bottom:60px;
      z-index: 800;
      background: rgba(10,18,26,.72);
      border:1px solid rgba(255,99,99,.35);
      color: rgba(255,255,255,.92);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 18px 44px rgba(0,0,0,.45);
      display:none;
      backdrop-filter: blur(10px);
    }
    .toast b{ display:block; font-size:12px; letter-spacing:.35px; color: rgba(255,255,255,.7); margin-bottom:4px;}
    .toast .small{ font-size:12px; color: rgba(255,255,255,.70); }

    /* Footer */
    .footer{
      position:absolute;
      left:18px;
      bottom:10px;
      z-index: 650;
      font-size:12px;
      color: rgba(255,255,255,.55);
      pointer-events:none;
    }
    .footerR{
      position:absolute;
      right:18px;
      bottom:10px;
      z-index: 650;
      font-size:12px;
      color: rgba(255,255,255,.60);
      pointer-events:none;
    }

    /* Help: reduce overlay intensity when user wants cleaner look */
    .cleanOverlay .scanner,
    .cleanOverlay .sweep{
      opacity:.35;
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="topbar">
      <div class="left">
        <div class="clock" id="clock">--:--</div>
        <div class="meta">
          <div class="line1" id="line1">Phoenix • Radar</div>
          <div class="line2" id="line2">Live radar overlay • RainViewer</div>
        </div>
      </div>

      <div class="right">
        <div class="updated" id="updated">Updated --:--</div>
        <div class="pill"><span class="dot"></span><b>LIVE</b></div>
      </div>
    </div>

    <div class="content" id="content">
      <div class="panelhead">
        <div class="paneltitle">PHOENIX WEATHER RADAR</div>
        <div class="modes">
          <div class="btn" id="btnMetro">Metro</div>
          <div class="btn" id="btnValley">Valley</div>
          <div class="btn active" id="btnRegional">Regional</div>
          <div class="btn" id="btnClean" title="Reduce scanner intensity">Cleaner</div>
        </div>
      </div>

      <div id="map"></div>

      <!-- “Old vibe” scanner overlays -->
      <div class="scanner"></div>
      <div class="sweep"></div>

      <div class="toast" id="toast">
        <b>RADAR NOTE</b>
        <div class="small" id="toastMsg"></div>
      </div>

      <div class="statusbar">
        <div class="badge" id="statusBadge"><span class="dot"></span>PHX LIVE RADAR</div>
        <div class="badge" id="frameBadge">Frame: -- • Zoom --</div>
      </div>

      <div class="footer">Edge Dashboard</div>
      <div class="footerR" id="footerR">Updated --:--</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // Phoenix (downtown-ish)
    const PHX = { lat: 33.4484, lon: -112.0740 };

    // Preset views:
    // - You said default zoom often had "no data" until you zoomed out.
    //   So we make REGIONAL the default (more likely to show incoming precip),
    //   and keep Metro/Valley as quick toggles.
    const VIEWS = {
      metro:   { center: [PHX.lat, PHX.lon], zoom: 11.0 },
      valley:  { center: [PHX.lat, PHX.lon], zoom: 10.0 },
      regional:{ center: [PHX.lat, PHX.lon], zoom: 9.0  } // default
    };

    // Radar overlay tuning:
    // RainViewer v2 tile format observed:
    // https://tilecache.rainviewer.com/v2/radar/{ts}/{z}/{x}/{y}/{color}/{smooth}_{snow}.png
    // We'll keep a “cleaner” look by:
    // - slightly lower opacity
    // - normal blend (scanner overlays add the vibe)
    const RADAR = {
      color: 2,        // palette id (works well + matches what you were getting)
      smooth: 1,       // 1 = smoother blobs
      snow: 1,         // 1 = include snow layer logic (fine to keep on)
      opacity: 0.55    // lower => map more readable
    };

    // Animation:
    const ANIM = {
      enabled: true,
      msPerFrame: 850,       // not “smooth”, but readable movement
      refreshFramesMs: 120000 // re-fetch available frames every 2 minutes
    };

    // ====== UI HELPERS ======
    function pad(n){ return (n<10?'0':'')+n; }
    function fmtTime(d){
      let h = d.getHours();
      const m = pad(d.getMinutes());
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;
      return `${h}:${m} ${ampm}`;
    }
    function setUpdatedNow(){
      const now = new Date();
      document.getElementById('updated').textContent = `Updated ${fmtTime(now)}`;
      document.getElementById('footerR').textContent = `Updated ${fmtTime(now)}`;
    }
    function tickClock(){
      const now = new Date();
      const h = now.getHours();
      const m = pad(now.getMinutes());
      const ampm = h >= 12 ? 'PM' : 'AM';
      let hh = h % 12; if (hh === 0) hh = 12;
      document.getElementById('clock').textContent = `${pad(hh)}:${m} ${ampm}`;
    }

    function showToast(msg, isError=false){
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      toastMsg.textContent = msg;
      toast.style.borderColor = isError ? 'rgba(255,99,99,.40)' : 'rgba(40,215,195,.35)';
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display='none', 5200);
    }

    // ====== MAP ======
    // Dark base map to match your Edge panels:
    // (CartoDB Dark Matter tiles)
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true,
      zoomSnap: 0.25,  // smoother steps
      zoomDelta: 0.5,
      wheelPxPerZoomLevel: 120
    });

    const base = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      { subdomains: 'abcd', maxZoom: 19, attribution: '&copy; OpenStreetMap &copy; CARTO' }
    ).addTo(map);

    // Center marker (subtle)
    const centerMarker = L.circleMarker([PHX.lat, PHX.lon], {
      radius: 5, color: '#28d7c3', weight: 2, opacity: 0.9, fillOpacity: 0.08
    }).addTo(map);

    // ====== RAINVIEWER FRAMES + RADAR LAYER ======
    let frames = [];          // array of { ts, kind } where kind = 'past' | 'nowcast'
    let frameIndex = 0;
    let animTimer = null;
    let radarLayer = null;

    function radarTileUrl(ts){
      // v2 format (the one you were using earlier)
      // /v2/radar/{ts}/{z}/{x}/{y}/{color}/{smooth}_{snow}.png
      return `https://tilecache.rainviewer.com/v2/radar/${ts}/{z}/{x}/{y}/${RADAR.color}/${RADAR.smooth}_${RADAR.snow}.png`;
    }

    function setFrameBadge(ts){
      const z = map.getZoom().toFixed(1);
      const d = new Date(ts * 1000);
      document.getElementById('frameBadge').textContent = `Frame: ${fmtTime(d)} • Zoom ${z}`;
    }

    function applyRadarFrame(ts){
      if (!radarLayer){
        radarLayer = L.tileLayer(radarTileUrl(ts), {
          opacity: RADAR.opacity,
          zIndex: 250,
          maxZoom: 19,
          // keep it crisp but not noisy
          updateWhenIdle: true,
          keepBuffer: 2
        }).addTo(map);

        radarLayer.on('tileerror', (e) => {
          // The user saw “tile failed to load” for some frames/zoom cells.
          // That’s normal when a specific (ts, z, x, y) is missing.
          // We'll auto-skip frames if we hit this repeatedly.
          showToast(
            `A radar tile was missing for this zoom/frame. Switching to the next available frame…`,
            false
          );
          // advance once to recover quickly
          if (frames.length > 1) nextFrame(true);
        });

      } else {
        radarLayer.setUrl(radarTileUrl(ts));
      }

      setFrameBadge(ts);
      setUpdatedNow();
    }

    async function fetchFrames(){
      // RainViewer public frames list
      const url = 'https://api.rainviewer.com/public/weather-maps.json';
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`RainViewer frames request failed (${res.status})`);
      const data = await res.json();

      const past = (data?.radar?.past || []).map(x => ({ ts: x.time, kind: 'past' }));
      const nowcast = (data?.radar?.nowcast || []).map(x => ({ ts: x.time, kind: 'nowcast' }));

      // Combine: keep recent past + nowcast (so you can see it “coming in”)
      // Take last ~8 past frames + all nowcast frames (usually a handful)
      const pastTail = past.slice(Math.max(0, past.length - 8));
      frames = [...pastTail, ...nowcast];

      // Pick a “best default frame”:
      // - Prefer the latest past frame (more likely to have data than nowcast sometimes)
      // - But if nowcast exists, start at the first nowcast so you see motion forward.
      const firstNowcastIdx = frames.findIndex(f => f.kind === 'nowcast');
      frameIndex = firstNowcastIdx >= 0 ? firstNowcastIdx : Math.max(0, frames.length - 1);

      if (!frames.length) throw new Error('No radar frames returned.');
      applyRadarFrame(frames[frameIndex].ts);

      // Helpful hint if you *see rain outside* but radar looks empty:
      // could be drizzle below reflectivity threshold / blocked by clutter / very localized.
      // We'll only mention once.
      if (!fetchFrames._hinted){
        fetchFrames._hinted = true;
        showToast('Tip: If radar looks “light” but it’s raining, it may be very light/drizzle or low reflectivity. Try Valley/Regional view.', false);
      }
    }

    function nextFrame(fromError=false){
      if (!frames.length) return;
      frameIndex = (frameIndex + 1) % frames.length;
      applyRadarFrame(frames[frameIndex].ts);

      // If we’re bouncing from errors, slow down briefly so tiles can load.
      if (fromError && animTimer){
        clearInterval(animTimer);
        animTimer = setInterval(()=> nextFrame(false), ANIM.msPerFrame + 250);
      }
    }

    function startAnimation(){
      stopAnimation();
      if (!ANIM.enabled) return;
      if (frames.length <= 1) return;
      animTimer = setInterval(()=> nextFrame(false), ANIM.msPerFrame);
    }

    function stopAnimation(){
      if (animTimer) clearInterval(animTimer);
      animTimer = null;
    }

    // ====== VIEW BUTTONS ======
    function setActive(btn){
      ['btnMetro','btnValley','btnRegional'].forEach(id => {
        const el = document.getElementById(id);
        el.classList.toggle('active', el.id === btn.id);
      });
    }

    function setView(key){
      const v = VIEWS[key];
      map.setView(v.center, v.zoom, { animate: true, duration: 0.55 });
      setUpdatedNow();
    }

    document.getElementById('btnMetro').addEventListener('click', (e)=>{
      setActive(e.currentTarget);
      setView('metro');
    });
    document.getElementById('btnValley').addEventListener('click', (e)=>{
      setActive(e.currentTarget);
      setView('valley');
    });
    document.getElementById('btnRegional').addEventListener('click', (e)=>{
      setActive(e.currentTarget);
      setView('regional');
    });

    // Cleaner toggle: keeps live radar functionality, just dials back scanner layers
    document.getElementById('btnClean').addEventListener('click', (e)=>{
      const on = document.getElementById('content').classList.toggle('cleanOverlay');
      e.currentTarget.classList.toggle('active', on);
    });

    map.on('zoomend', ()=>{
      if (frames.length) setFrameBadge(frames[frameIndex].ts);
    });

    // ====== BOOT ======
    // Default view = Regional (more likely to show precip at a glance)
    map.setView(VIEWS.regional.center, VIEWS.regional.zoom);

    tickClock();
    setUpdatedNow();
    setInterval(tickClock, 1000);
    setInterval(setUpdatedNow, 30000);

    // Load frames + start animation
    (async function init(){
      try{
        await fetchFrames();
        startAnimation();
      }catch(err){
        console.error(err);
        showToast(`Radar failed to initialize: ${err.message}`, true);
      }
    })();

    // Refresh frames periodically (keeps tiles from “expiring” on long-running Edge sessions)
    setInterval(async ()=>{
      try{
        const currentTs = frames?.[frameIndex]?.ts;
        await fetchFrames();
        // try to keep roughly same time position if possible
        if (currentTs){
          const idx = frames.findIndex(f=> f.ts === currentTs);
          if (idx >= 0) frameIndex = idx;
        }
        startAnimation();
      }catch(e){
        // silent-ish; we don’t want spam
        console.warn('Frame refresh failed:', e);
      }
    }, ANIM.refreshFramesMs);
  </script>
</body>
</html>
