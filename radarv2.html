<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phoenix Weather Radar (Edge)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg0:#081015;
      --bg1:#0b141a;
      --panel:#0b141acc;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(0,255,210,.18);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --teal:#2ef5d6;

      /* radar look */
      --radar-opacity: .55;
      --radar-filter: saturate(1.05) contrast(1.08) brightness(.95);
      --radar-blend: screen;

      /* cleaner mode */
      --radar-opacity-clean: .40;
      --radar-filter-clean: saturate(.85) contrast(1.15) brightness(.92) blur(.35px);
      --radar-blend-clean: screen;

      /* scanner */
      --scanline-opacity:.10;
      --beam-opacity:.18;
      --beam-softness: 42%;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 900px at 50% -10%, #10303a 0%, var(--bg0) 55%, #05080b 100%);
      color:var(--text);
      overflow:hidden;
    }

    /* Edge-like frame */
    .frame{
      position:fixed;
      inset:0;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topbar{
      height:64px;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(20,35,42,.86), rgba(10,18,23,.82));
      border:1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 16px;
      position:relative;
      overflow:hidden;
    }
    .topbar:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 240px at 50% 0%, rgba(46,245,214,.16), transparent 55%),
        radial-gradient(900px 340px at 20% 0%, rgba(80,180,255,.10), transparent 60%);
      pointer-events:none;
    }

    .left{
      display:flex; align-items:baseline; gap:12px;
      position:relative;
      z-index:1;
    }
    .clock{
      font-weight:800;
      letter-spacing:.5px;
      font-size:38px;
      line-height:1;
      text-shadow:0 2px 12px rgba(0,0,0,.35);
    }
    .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-top:2px;
    }
    .meta .loc{
      font-size:13px;
      color:var(--muted);
    }
    .meta .sub{
      font-size:12px;
      color:rgba(255,255,255,.48);
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      z-index:1;
      position:relative;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      background: rgba(7,16,20,.55);
      border: 1px solid rgba(46,245,214,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      font-size:12px;
      color:rgba(255,255,255,.75);
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--teal);
      box-shadow:0 0 0 4px rgba(46,245,214,.12);
    }

    .content{
      flex:1;
      border-radius:26px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(20,35,42,.36), rgba(10,18,23,.38));
      box-shadow: 0 18px 45px rgba(0,0,0,.40);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .headerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px 10px 16px;
    }
    .title{
      font-weight:800;
      letter-spacing:.8px;
      font-size:18px;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      height:32px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(8,14,18,.42);
      color: rgba(255,255,255,.80);
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .btn:hover{ border-color: rgba(46,245,214,.28); }
    .btn.active{
      border-color: rgba(46,245,214,.55);
      color: rgba(255,255,255,.92);
      background: rgba(46,245,214,.12);
    }

    .mapWrap{
      position:relative;
      flex:1;
      margin: 0 12px 12px 12px;
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: #070c10;
    }

    #map{ position:absolute; inset:0; }

    /* --- Radar styling hooks --- */
    .radarPane .leaflet-tile{
      opacity: var(--radar-opacity);
      filter: var(--radar-filter);
      mix-blend-mode: var(--radar-blend);
    }
    .cleaner .radarPane .leaflet-tile{
      opacity: var(--radar-opacity-clean);
      filter: var(--radar-filter-clean);
      mix-blend-mode: var(--radar-blend-clean);
    }

    /* Extra darkening so it matches Edge tiles */
    .leaflet-container{
      background:#060a0d;
      filter: saturate(.95) contrast(1.05) brightness(.92);
    }

    /* --- Scanner overlay (visual only) --- */
    .scanner{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:600; /* above tiles, below leaflet controls is OK */
      mix-blend-mode: screen;
    }

    .scanlines{
      position:absolute; inset:0;
      opacity: var(--scanline-opacity);
      background:
        repeating-linear-gradient(
          135deg,
          rgba(46,245,214,.22) 0px,
          rgba(46,245,214,.22) 2px,
          rgba(0,0,0,0) 2px,
          rgba(0,0,0,0) 12px
        );
    }
    .vignette{
      position:absolute; inset:-1px;
      background:
        radial-gradient(1200px 700px at 50% 60%, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 65%, rgba(0,0,0,.78) 100%),
        radial-gradient(800px 500px at 50% 40%, rgba(46,245,214,.08), transparent 60%);
      opacity:.9;
    }

    /* sweeping beam */
    .beam{
      position:absolute;
      inset:-30%;
      opacity: var(--beam-opacity);
      background:
        conic-gradient(from 0deg at 50% 52%,
          rgba(46,245,214,0) 0deg,
          rgba(46,245,214,0) calc(360deg - var(--beam-softness)),
          rgba(46,245,214,.38) 360deg
        );
      animation: sweep 5.4s linear infinite;
      filter: blur(0.6px);
      transform-origin: 50% 52%;
    }
    @keyframes sweep{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    /* footer badges */
    .badgeRow{
      position:absolute;
      left:14px;
      bottom:14px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index:700;
      pointer-events:none;
    }
    .badge{
      pointer-events:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(8,14,18,.55);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      font-size:12px;
      color: rgba(255,255,255,.78);
    }
    .badge .dot{ width:10px; height:10px; }

    /* note / error toast */
    .toast{
      position:absolute;
      left:14px;
      right:14px;
      bottom:64px;
      z-index:800;
      border-radius:18px;
      padding:14px 16px;
      background: rgba(8,14,18,.75);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      color: rgba(255,255,255,.82);
      font-size:13px;
      display:none;
    }
    .toast strong{ display:block; letter-spacing:.6px; margin-bottom:4px; }
    .toast.warn{ border-color: rgba(255,120,120,.35); }
    .toast.ok{ border-color: rgba(46,245,214,.30); }

    /* Leaflet control tweaks */
    .leaflet-control-zoom a{
      background: rgba(8,14,18,.45) !important;
      color: rgba(255,255,255,.82) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      backdrop-filter: blur(10px);
    }
    .leaflet-control-attribution{
      background: rgba(0,0,0,.28) !important;
      color: rgba(255,255,255,.55) !important;
      border-radius: 10px;
      padding: 4px 8px !important;
      margin: 0 10px 10px 0 !important;
    }
  </style>
</head>

<body>
  <div class="frame" id="root">
    <div class="topbar">
      <div class="left">
        <div class="clock" id="clock">--:--</div>
        <div class="meta">
          <div class="loc" id="locLine">Phoenix • Radar</div>
          <div class="sub" id="subLine">Live radar overlay • RainViewer</div>
        </div>
      </div>
      <div class="right">
        <div class="pill" title="Live">
          <span class="dot"></span>
          LIVE
        </div>
        <div class="pill" title="Last updated">
          Updated <span id="updated">--:--</span>
        </div>
      </div>
    </div>

    <div class="content" id="content">
      <div class="headerRow">
        <div class="title">PHOENIX WEATHER RADAR</div>
        <div class="controls">
          <div class="btn active" id="btnMetro">Metro</div>
          <div class="btn" id="btnValley">Valley</div>
          <div class="btn" id="btnRegional">Regional</div>

          <div class="btn" id="btnCleaner" title="Reduce speckle / make precip softer">Cleaner</div>
          <div class="btn active" id="btnPlay">⏸ Pause</div>
        </div>
      </div>

      <div class="mapWrap">
        <div id="map"></div>

        <!-- Scanner overlay -->
        <div class="scanner">
          <div class="beam"></div>
          <div class="scanlines"></div>
          <div class="vignette"></div>
        </div>

        <div class="toast" id="toast">
          <strong id="toastTitle">RADAR NOTE</strong>
          <div id="toastMsg">—</div>
        </div>

        <div class="badgeRow">
          <div class="badge">
            <span class="dot"></span>
            PHX LIVE RADAR
          </div>
          <div class="badge" id="frameBadge">Frame: -- • Zoom --</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /**********************
     * CONFIG
     **********************/
    const PHX = { lat: 33.4484, lon: -112.0740 };

    // View presets (tuned so you usually see something without being ridiculously zoomed out)
    const VIEWS = {
      metro:   { center:[PHX.lat, PHX.lon], zoom: 10.6 },
      valley:  { center:[PHX.lat, PHX.lon], zoom:  9.4 },
      regional:{ center:[PHX.lat, PHX.lon], zoom:  8.2 }
    };

    // RainViewer public weather maps JSON (frames list)
    const RV_INDEX = "https://api.rainviewer.com/public/weather-maps.json";

    // Radar tile URL template. RainViewer radar tiles are time-based.
    function radarUrl(ts){
      // The "256" part is standard tile size, the trailing "2/1_1.png" are RainViewer style params.
      // Keep this EXACT; it matches the common public RainViewer tile format.
      return `https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`;
    }

    /**********************
     * UI helpers
     **********************/
    const $ = (id)=>document.getElementById(id);
    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtTime(d){
      let h=d.getHours(), m=d.getMinutes();
      const ap = h>=12 ? "PM":"AM";
      h = h%12; if(h===0) h=12;
      return `${h}:${pad2(m)} ${ap}`;
    }
    function setClock(){
      const now = new Date();
      $("clock").textContent = fmtTime(now);
    }
    function setUpdatedNow(){
      $("updated").textContent = fmtTime(new Date());
    }
    setClock();
    setInterval(setClock, 1000);

    function showToast(msg, warn=false, title="RADAR NOTE"){
      const t = $("toast");
      $("toastTitle").textContent = title;
      $("toastMsg").textContent = msg;
      t.classList.toggle("warn", !!warn);
      t.classList.toggle("ok", !warn);
      t.style.display = "block";
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(()=>{ t.style.display="none"; }, warn ? 5000 : 2600);
    }

    /**********************
     * Map init (dark basemap)
     **********************/
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true,
      preferCanvas: true
    });

    // Dark basemap (no key). CARTO dark tiles.
    const base = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      {
        subdomains: "abcd",
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap &copy; CARTO'
      }
    ).addTo(map);

    // Put radar tiles in their own pane so we can style them via CSS (radarPane class)
    map.createPane("radar");
    map.getPane("radar").classList.add("radarPane");
    map.getPane("radar").style.zIndex = 350;

    map.setView(VIEWS.metro.center, VIEWS.metro.zoom);

    /**********************
     * Radar animation engine
     **********************/
    let frames = [];     // [{ts:number}]
    let idx = 0;
    let playing = true;
    let radarLayer = null;
    let timer = null;

    function setFrameBadge(ts){
      const z = map.getZoom();
      const d = new Date(ts * 1000);
      $("frameBadge").textContent = `Frame: ${fmtTime(d)} • Zoom ${z.toFixed(1)}`;
    }

    // Try to advance to next frame if a tile errors a lot
    let tileErrorsInWindow = 0;
    let tileErrorReset = null;

    function bumpTileError(){
      tileErrorsInWindow++;
      clearTimeout(tileErrorReset);
      tileErrorReset = setTimeout(()=>{ tileErrorsInWindow = 0; }, 2000);

      // If we’re seeing lots of errors quickly, assume this frame is partially missing at this zoom
      if (tileErrorsInWindow >= 5){
        tileErrorsInWindow = 0;
        // jump to next frame (very common "expired frame" symptom)
        idx = (idx + 1) % frames.length;
        applyFrame(frames[idx].ts, { silent:true });
        showToast("A radar tile was missing for this zoom/frame. Switching to next available frame…", false);
      }
    }

    function applyFrame(ts, {silent=false} = {}){
      if (!frames.length) return;

      if (!radarLayer){
        radarLayer = L.tileLayer(radarUrl(ts), {
          pane: "radar",
          opacity: 1, // actual opacity controlled by CSS on tiles
          maxZoom: 19,
          updateWhenIdle: true,
          keepBuffer: 2
        }).addTo(map);

        radarLayer.on("tileerror", () => {
          bumpTileError();
        });
      } else {
        radarLayer.setUrl(radarUrl(ts));
      }

      setFrameBadge(ts);
      setUpdatedNow();
      if (!silent) showToast("Radar frame updated.", false, "LIVE");
    }

    function step(){
      if (!frames.length) return;
      idx = (idx + 1) % frames.length;
      applyFrame(frames[idx].ts, { silent:true });
    }

    function start(){
      stop();
      timer = setInterval(step, 900); // speed: change for smoother/slower
    }

    function stop(){
      if (timer){ clearInterval(timer); timer = null; }
    }

    async function loadFrames(){
      try{
        const res = await fetch(RV_INDEX, { cache: "no-store" });
        if (!res.ok) throw new Error(`Index HTTP ${res.status}`);
        const json = await res.json();

        const radar = json?.radar?.past || [];
        if (!radar.length) throw new Error("No radar frames in index.");

        // Use last ~12 frames for a “recent motion” loop (feels like animated incoming weather)
        const take = radar.slice(-12);
        frames = take.map(x => ({ ts: x.time }));
        idx = frames.length - 1;

        applyFrame(frames[idx].ts, { silent:true });
        if (playing) start();

        showToast("Radar loaded.", false, "LIVE");
      }catch(err){
        console.error(err);
        showToast("Could not load radar frames. Check RainViewer availability or try again shortly.", true);
      }
    }

    /**********************
     * Controls
     **********************/
    function setActive(btnId){
      ["btnMetro","btnValley","btnRegional"].forEach(id=>{
        $(id).classList.toggle("active", id===btnId);
      });
    }
    $("btnMetro").addEventListener("click", ()=>{
      setActive("btnMetro");
      map.setView(VIEWS.metro.center, VIEWS.metro.zoom, { animate:true });
    });
    $("btnValley").addEventListener("click", ()=>{
      setActive("btnValley");
      map.setView(VIEWS.valley.center, VIEWS.valley.zoom, { animate:true });
    });
    $("btnRegional").addEventListener("click", ()=>{
      setActive("btnRegional");
      map.setView(VIEWS.regional.center, VIEWS.regional.zoom, { animate:true });
    });

    $("btnCleaner").addEventListener("click", (e)=>{
      const on = $("content").classList.toggle("cleaner");
      e.currentTarget.classList.toggle("active", on);
      showToast(on ? "Cleaner overlay enabled." : "Cleaner overlay disabled.", false);
    });

    $("btnPlay").addEventListener("click", (e)=>{
      playing = !playing;
      e.currentTarget.classList.toggle("active", playing);
      e.currentTarget.textContent = playing ? "⏸ Pause" : "▶ Play";
      if (playing) start(); else stop();
    });

    // Keep badge updated when zoom changes
    map.on("zoomend", ()=>{
      if (frames[idx]) setFrameBadge(frames[idx].ts);
    });

    /**********************
     * Boot
     **********************/
    loadFrames();

    // Refresh frames periodically so "expired frame" issues reduce over time
    setInterval(loadFrames, 1000 * 60 * 5);
  </script>
</body>
</html>
