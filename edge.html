<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edge Dashboard</title>
  <style>
    :root{
      color-scheme: dark;

      --bg0:#060b14;
      --bg1:#0a1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.04);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.10);
      --text: #e9eefc;
      --muted: rgba(233,238,252,0.72);

      --teal: #33e6d1;
      --teal2: rgba(51,230,209,0.18);

      --pos:#77ffb5;
      --neg:#ff7a7a;

      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      height:100%;
      overflow:hidden;
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 70% 30%, rgba(51,230,209,0.10), transparent 60%),
        radial-gradient(1000px 650px at 20% 80%, rgba(120,170,255,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 44px 44px;
      opacity:0.12;
      mask-image: radial-gradient(circle at 55% 45%, black 55%, transparent 78%);
    }

    .wrap{
      height:100%;
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    /* Top strip */
    .topstrip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 12px 34px rgba(0,0,0,0.28);
      min-height: 56px;
    }
    .time{
      font-weight: 950;
      letter-spacing: 0.5px;
      font-size: clamp(22px, 4.2vw, 34px);
      line-height: 1;
      white-space:nowrap;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      color: rgba(233,238,252,0.84);
      font-size: clamp(12px, 2.2vw, 14px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
      min-width:0;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      background: rgba(51,230,209,0.10);
      border: 1px solid rgba(51,230,209,0.22);
      color: rgba(233,238,252,0.92);
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: var(--teal);
      box-shadow: 0 0 12px rgba(51,230,209,0.5);
    }

    /* Main panel card */
    .card{
      flex:1;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--stroke);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }
    .hLeft{
      font-weight: 950;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 14px;
      opacity:0.92;
      white-space:nowrap;
    }
    .hRight{
      font-weight: 900;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(233,238,252,0.70);
      white-space:nowrap;
    }

    .cardBody{
      flex:1;
      padding: 14px 16px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .footer{
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size: 12px;
      color: rgba(233,238,252,0.75);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    /* Layout helpers */
    .row{ display:flex; gap:12px; min-height:0; }
    .col{ flex:1; min-width:0; min-height:0; }

    .box{
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 12px 12px 10px 12px;
      min-height: 0;
      position: relative;
      overflow:hidden;
    }
    .boxTitle{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: rgba(233,238,252,0.70);
      margin-bottom: 8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .big{
      font-size: clamp(34px, 6.4vw, 64px);
      font-weight: 950;
      line-height: 1;
      letter-spacing: 0.2px;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin-top: 6px;
      font-size: 13px;
      color: rgba(233,238,252,0.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pos{ color: var(--pos); }
    .neg{ color: var(--neg); }

    /* Headlines list */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:hidden;
    }
    .item{
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 12px 12px 10px 12px;
      min-height: 0;
      overflow:hidden;
    }
    .itemTitle{
      font-weight: 900;
      font-size: clamp(14px, 2.3vw, 18px);
      line-height: 1.15;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .itemSource{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(233,238,252,0.62);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Cities rows */
    .rows{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
      min-height:0;
    }
    .cityRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .cityName{
      font-weight: 950;
      letter-spacing: 0.2px;
      font-size: clamp(14px, 2.5vw, 18px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:1;
    }
    .cityRight{
      display:flex;
      align-items:baseline;
      gap:14px;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    .cityTime{
      font-size: clamp(14px, 2.6vw, 18px);
      color: rgba(233,238,252,0.85);
      font-weight: 900;
    }
    .cityTemp{
      font-size: clamp(16px, 3.0vw, 20px);
      font-weight: 950;
    }

    /* Radar placeholder */
    .radar{
      flex:1;
      border-radius: 18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
      overflow:hidden;
      min-height: 140px;
    }
    .radar:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 50%, rgba(51,230,209,0.10), transparent 58%),
        repeating-radial-gradient(circle at 50% 50%,
          rgba(233,238,252,0.05) 0px,
          rgba(233,238,252,0.05) 1px,
          transparent 16px,
          transparent 26px
        );
      opacity:0.55;
    }
    .sweep{
      position:absolute;
      inset:-40% -40%;
      background: conic-gradient(from 0deg,
        rgba(51,230,209,0.0),
        rgba(51,230,209,0.18),
        rgba(51,230,209,0.0)
      );
      animation: spin 3.8s linear infinite;
      opacity:0.55;
      mix-blend-mode: screen;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .radarLabel{
      position:absolute;
      left:12px; bottom:10px;
      font-size: 12px;
      color: rgba(233,238,252,0.70);
      font-weight: 800;
    }

    /* Panel error */
    .err{
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .errTop{
      font-size: 12px;
      letter-spacing: 0.6px;
      font-weight: 950;
      text-transform: uppercase;
      color: rgba(233,238,252,0.70);
      margin-bottom: 8px;
    }
    .errMsg{
      font-weight: 950;
      font-size: 16px;
      line-height: 1.25;
      margin-bottom: 6px;
    }
    .errSub{
      font-size: 12px;
      color: rgba(233,238,252,0.70);
      line-height: 1.35;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Small screen safety */
    @media (max-height: 480px){
      .topstrip{ min-height: 50px; padding: 8px 12px; }
      .cardHeader{ padding: 10px 12px; }
      .cardBody{ padding: 10px 12px; gap:10px; }
      .footer{ padding: 8px 10px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topstrip">
      <div class="time" id="clock">—:—</div>
      <div class="meta" id="topmeta">Loading…</div>
      <div class="pill"><span class="dot"></span><span id="liveLabel">LIVE</span></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div class="hLeft" id="panelTitle">—</div>
        <div class="hRight" id="panelHint">—</div>
      </div>

      <div class="cardBody" id="panelBody">
        <!-- content injected -->
      </div>

      <div class="footer">
        <div>Edge Dashboard</div>
        <div id="stamp">Updated —</div>
      </div>
    </div>
  </div>

<script>
  // ==========
  // Settings
  // ==========
  const ROTATE_SECONDS = 18;   // how long each panel stays on screen
  const REFRESH_SECONDS = 60;  // how often we refresh data per panel (cache-friendly)

  // Panels in cycle order
  // NOTE: All endpoints are absolute (/api/...) to avoid “HTML instead of JSON” from bad relative paths.
  const PANELS = [
    { key:"market",  title:"MARKET",     hint:"SPY + VXX + SECTORS + HEADLINES", endpoint:"/api/market",  render: renderMarket },
    { key:"weather", title:"WEATHER",    hint:"NOW + TOMORROW + RADAR",          endpoint:"/api/weather", render: renderWeather },
    { key:"news",    title:"HEADLINES",  hint:"US + WORLD + BUSINESS",           endpoint:"/api/news",    render: renderNews },
    { key:"net",     title:"SERVER INFO",hint:"LATENCY CHECKS",                  endpoint:"/api/net",     render: renderNet },
    { key:"cities",  title:"CITIES",     hint:"TIME + TEMP",                     endpoint:"/api/cities",  render: renderCities },
  ];

  // ==========
  // Utils
  // ==========
  const el = (id) => document.getElementById(id);

  function fmtUsd(n, digits=2){
    if(n==null || !isFinite(n)) return "—";
    return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:digits});
  }
  function fmtPct(n){
    if(n==null || !isFinite(n)) return "—";
    const s = (n>=0?"+":"") + Number(n).toFixed(2) + "%";
    return s;
  }
  function clsFor(n){ return n>0 ? "pos" : (n<0 ? "neg" : ""); }

  function setStamp(){
    el("stamp").textContent = "Updated " + new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  }

  // Safe JSON fetch:
  // - shows the URL that failed
  // - detects HTML (starts with "<" or contains "<!doctype")
  async function fetchJson(url){
    const r = await fetch(url + (url.includes("?") ? "&" : "?") + "t=" + Date.now(), { cache:"no-store" });
    const text = await r.text();

    const looksHtml = /^\s*</.test(text) || text.toLowerCase().includes("<!doctype");
    const ct = (r.headers.get("content-type") || "").toLowerCase();

    if(!r.ok){
      throw new Error(`HTTP ${r.status} from ${url} • ${looksHtml ? "returned HTML" : "returned text"}`);
    }
    if(looksHtml){
      // This is the classic “Unexpected token <” root cause
      const snip = text.slice(0, 120).replace(/\s+/g," ").trim();
      throw new Error(`HTML returned from ${url} • "${snip}…"`);
    }

    // If content-type isn't JSON, still try parse; if it fails we'll show useful error
    try { return JSON.parse(text); }
    catch(e){
      const snip = text.slice(0, 140).replace(/\s+/g," ").trim();
      throw new Error(`Invalid JSON from ${url} • "${snip}…"`);
    }
  }

  function showError(panel, err){
    el("panelTitle").textContent = panel.title;
    el("panelHint").textContent  = panel.hint;
    el("panelBody").innerHTML = `
      <div class="err">
        <div class="errTop">Panel error</div>
        <div class="errMsg">${escapeHtml(String(err.message || err))}</div>
        <div class="errSub">
          This almost always means the endpoint returned HTML (404/redirect) or the JSON shape changed.
          <br/>Endpoint: <strong>${escapeHtml(panel.endpoint)}</strong>
        </div>
      </div>
    `;
    setStamp();
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ==========
  // Renderers (tolerant to JSON shape)
  // ==========
  function renderMarket(data){
    // Accept multiple shapes:
    // data.spy: {price, pct}
    // data.vxx: {price, pct}
    // data.sectors: [{symbol, pct}]
    // data.headlines: [{title, source}]
    const spy = data.spy || data.SPY || (data.quotes && (data.quotes.SPY || data.quotes.spy)) || null;
    const vxx = data.vxx || data.VXX || (data.quotes && (data.quotes.VXX || data.quotes.vxx)) || null;
    const sectors = data.sectors || data.tinyMovers || data.movers || [];
    const headlines = data.headlines || data.items || data.articles || [];

    const sectorText = Array.isArray(sectors)
      ? sectors.slice(0, 10).map(x => {
          const sym = x.symbol || x.ticker || x.name || "—";
          const pct = x.pct ?? x.changePercent ?? x.changesPercentage ?? x.change_percentage;
          return `${sym} ${fmtPct(pct)}`;
        }).join("  ·  ")
      : "—";

    const h = (Array.isArray(headlines) && headlines[0]) ? headlines[0] : null;
    const hTitle = h ? (h.title || h.headline || "—") : "—";
    const hSource = h ? (h.source || h.publisher || h.site || "") : "";

    el("panelBody").innerHTML = `
      <div class="row">
        <div class="col box">
          <div class="boxTitle">
            <span>S&amp;P 500 Proxy (SPY)</span>
          </div>
          <div class="big">${fmtUsd(spy?.price ?? spy?.last ?? spy?.close ?? spy, 2)}</div>
          <div class="sub ${clsFor(spy?.pct ?? spy?.changePercent ?? spy?.changesPercentage)}">
            ${fmtPct(spy?.pct ?? spy?.changePercent ?? spy?.changesPercentage)} today
          </div>
        </div>

        <div class="col box" style="text-align:right;">
          <div class="boxTitle">
            <span>Vol Proxy (VXX)</span>
          </div>
          <div class="big">${fmtUsd(vxx?.price ?? vxx?.last ?? vxx?.close ?? vxx, 2)}</div>
          <div class="sub ${clsFor(vxx?.pct ?? vxx?.changePercent ?? vxx?.changesPercentage)}">
            ${fmtPct(vxx?.pct ?? vxx?.changePercent ?? vxx?.changesPercentage)} today
          </div>
        </div>
      </div>

      <div class="row" style="flex:1;">
        <div class="col box" style="flex:1.05;">
          <div class="boxTitle"><span>Sectors (bigger + readable)</span></div>
          <div style="font-size:clamp(12px,2.25vw,16px);line-height:1.35;color:rgba(233,238,252,0.84);overflow:hidden;display:-webkit-box;-webkit-line-clamp:6;-webkit-box-orient:vertical;">
            ${escapeHtml(sectorText || "—")}
          </div>
          <div class="sub" style="margin-top:10px;color:rgba(233,238,252,0.55);">
            (If you want a true sentiment bar here, we can replace this with Fear &amp; Greed / breadth.)
          </div>
        </div>

        <div class="col box" style="flex:0.95;">
          <div class="boxTitle"><span>Market headline</span></div>
          <div class="itemTitle" style="-webkit-line-clamp:3;">${escapeHtml(hTitle)}</div>
          <div class="itemSource">${escapeHtml(hSource)}</div>
          <div class="sub" style="margin-top:10px;color:rgba(233,238,252,0.55);">
            (Room for more — we can show 2–3 here if you want.)
          </div>
        </div>
      </div>
    `;
  }

  function renderWeather(data){
    // Shapes accepted:
    // data.now: {temp, windMph, rainPct, aqi, sunrise, sunset}
    // data.tomorrow: {hi, lo}
    // data.radar: {imageUrl} optional
    const now = data.now || data.current || data.today || data;
    const tmr = data.tomorrow || data.nextDay || data.forecastTomorrow || {};
    const temp = now.temp ?? now.temperature ?? now.tempF;
    const wind = now.windMph ?? now.wind ?? now.wind_speed;
    const rain = now.rainPct ?? now.precipPct ?? now.pop ?? now.precip_probability;
    const aqi  = now.aqi ?? now.airQualityIndex;
    const sunrise = now.sunrise ?? now.sunriseTime;
    const sunset  = now.sunset ?? now.sunsetTime;

    const hi = tmr.hi ?? tmr.high ?? tmr.max;
    const lo = tmr.lo ?? tmr.low  ?? tmr.min;

    el("panelBody").innerHTML = `
      <div class="row">
        <div class="col box">
          <div class="boxTitle"><span>Phoenix weather</span></div>
          <div class="big">${(temp!=null && isFinite(temp)) ? `${Math.round(temp)}°` : "—"}</div>
          <div class="sub">
            Wind ${wind!=null ? `${Math.round(wind)} mph` : "—"} • Rain ${rain!=null ? `${Math.round(rain)}%` : "—"}
          </div>
          <div class="sub" style="margin-top:10px;">
            Sunrise ${escapeHtml(sunrise || "—")} • Sunset ${escapeHtml(sunset || "—")} • AQI ${aqi!=null ? `${aqi}` : "—"}
          </div>
        </div>

        <div class="col box" style="text-align:right;">
          <div class="boxTitle"><span>Tomorrow</span></div>
          <div class="big">${(hi!=null && lo!=null) ? `${Math.round(hi)}° / ${Math.round(lo)}°` : "—"}</div>
          <div class="sub">High / Low</div>
        </div>
      </div>

      <!-- Radar area (even when empty, it "feels alive") -->
      <div class="radar">
        <div class="sweep"></div>
        <div class="radarLabel">Radar (scan placeholder)</div>
      </div>
    `;
  }

  function renderNews(data){
    // Accept: {items:[{title,source}]} or {articles:[...]} etc.
    const items = data.items || data.articles || data.headlines || data.news || [];
    const list = Array.isArray(items) ? items.slice(0, 5) : [];

    if(!list.length){
      el("panelBody").innerHTML = `
        <div class="err">
          <div class="errTop">No headlines</div>
          <div class="errMsg">No items returned</div>
          <div class="errSub">If your /api/news works in a browser, this usually means the JSON keys are different than expected.</div>
        </div>
      `;
      return;
    }

    el("panelBody").innerHTML = `
      <div class="list">
        ${list.map(x => {
          const title = x.title || x.headline || x.name || "—";
          const source = x.source || x.publisher || x.site || x.domain || "";
          return `
            <div class="item">
              <div class="itemTitle">${escapeHtml(title)}</div>
              <div class="itemSource">${escapeHtml(source)}</div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  function renderNet(data){
    // Accept: {cloudflareMs, googleMs} OR {checks:{cloudflare:{ms}, google:{ms}}} etc.
    const cf = data.cloudflareMs ?? data.cfMs ?? data.cloudflare?.ms ?? data.checks?.cloudflare?.ms;
    const gg = data.googleMs ?? data.ggMs ?? data.google?.ms ?? data.checks?.google?.ms;

    const status = (data.status || data.health || (data.ok ? "Healthy" : null)) ?? "Healthy";
    const statusSub = data.statusDetail || data.detail || "All good";

    el("panelBody").innerHTML = `
      <div class="row">
        <div class="col box">
          <div class="boxTitle"><span>Cloudflare</span></div>
          <div class="big">${(cf!=null && isFinite(cf)) ? `${Math.round(cf)}ms` : "—"}</div>
          <div class="sub">OK</div>
        </div>
        <div class="col box">
          <div class="boxTitle"><span>Google</span></div>
          <div class="big">${(gg!=null && isFinite(gg)) ? `${Math.round(gg)}ms` : "—"}</div>
          <div class="sub">OK</div>
        </div>
      </div>

      <div class="box" style="flex:1;">
        <div class="boxTitle"><span>Status</span></div>
        <div class="big pos">${escapeHtml(String(status))}</div>
        <div class="sub">${escapeHtml(String(statusSub))}</div>
        <div class="sub" style="margin-top:10px;color:rgba(233,238,252,0.55);">
          This is checking *server reachability*, not your Wi-Fi speed.
        </div>
      </div>
    `;
  }

  function renderCities(data){
    // Accept: {cities:[{name,time,temp}]} OR {items:[...]} etc.
    const arr = data.cities || data.items || data.list || [];
    const list = Array.isArray(arr) ? arr : [];

    if(!list.length){
      el("panelBody").innerHTML = `
        <div class="err">
          <div class="errTop">Cities</div>
          <div class="errMsg">No cities returned</div>
          <div class="errSub">
            Your /api/cities function is returning an empty list (or different keys).
            Open <strong>/api/cities</strong> in the browser and see what keys it returns.
          </div>
        </div>
      `;
      return;
    }

    el("panelBody").innerHTML = `
      <div class="rows">
        ${list.slice(0, 7).map(c => {
          const name = c.name || c.city || c.label || "—";
          const time = c.time || c.localTime || c.clock || "—";
          const temp = c.temp ?? c.temperature ?? c.tempF;
          return `
            <div class="cityRow">
              <div class="cityName">${escapeHtml(String(name))}</div>
              <div class="cityRight">
                <div class="cityTime">${escapeHtml(String(time))}</div>
                <div class="cityTemp">${(temp!=null && isFinite(temp)) ? `${Math.round(temp)}°` : "—"}</div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  // ==========
  // Top strip updater
  // ==========
  function updateClock(){
    el("clock").textContent = new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  }

  async function updateTopStrip(){
    // If you already have /api/topstrip, use it.
    // If not, we’ll gracefully fall back to just “Phoenix”.
    const url = "/api/topstrip";
    try{
      const data = await fetchJson(url);
      // Accept shapes:
      // {city:"Phoenix", temp:67, wind:2, aqi:64, aqiLabel:"Moderate"}
      const city = data.city || data.location || "Phoenix";
      const temp = data.temp ?? data.temperature ?? null;
      const wind = data.wind ?? data.windMph ?? null;
      const aqi  = data.aqi ?? null;
      const aqiLabel = data.aqiLabel || data.aqiCategory || "";
      const parts = [
        city,
        (temp!=null && isFinite(temp)) ? `${Math.round(temp)}°` : null,
        (wind!=null && isFinite(wind)) ? `Wind ${Math.round(wind)} mph` : null,
        (aqi!=null && isFinite(aqi)) ? `AQI ${aqi}${aqiLabel ? ` (${aqiLabel})` : ""}` : null
      ].filter(Boolean);

      el("topmeta").textContent = parts.join(" • ");
    }catch(e){
      // quiet fallback
      el("topmeta").textContent = "Phoenix";
    }
  }

  // ==========
  // Panel rotation + caching
  // ==========
  let panelIdx = 0;
  const cache = new Map(); // key -> {data, ts}

  async function loadPanel(panel){
    el("panelTitle").textContent = panel.title;
    el("panelHint").textContent  = panel.hint;

    const now = Date.now();
    const cached = cache.get(panel.key);
    const freshMs = REFRESH_SECONDS * 1000;

    try{
      let data;
      if(cached && (now - cached.ts) < freshMs){
        data = cached.data;
      }else{
        data = await fetchJson(panel.endpoint);
        cache.set(panel.key, { data, ts: now });
      }
      panel.render(data);
      setStamp();
    }catch(err){
      showError(panel, err);
    }
  }

  function nextPanel(){
    panelIdx = (panelIdx + 1) % PANELS.length;
    loadPanel(PANELS[panelIdx]);
  }

  // ==========
  // Init
  // ==========
  (async function init(){
    updateClock();
    setInterval(updateClock, 1000 * 15);

    await updateTopStrip();
    setInterval(updateTopStrip, 1000 * 60);

    await loadPanel(PANELS[panelIdx]);
    setInterval(nextPanel, ROTATE_SECONDS * 1000);
  })();
</script>
</body>
</html>
