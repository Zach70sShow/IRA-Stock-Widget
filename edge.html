<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edge Dashboard</title>
  <style>
    :root{
      color-scheme: dark;
      --bg0:#060b14; --bg1:#0a1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.045);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.10);
      --text:#e9eefc;
      --muted: rgba(233,238,252,0.72);
      --teal:#33e6d1;
      --teal2: rgba(51,230,209,0.25);
      --pos:#77ffb5;
      --neg:#ff7a7a;
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; overflow:hidden;
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 70% 30%, rgba(51,230,209,0.10), transparent 60%),
        radial-gradient(1000px 650px at 20% 80%, rgba(120,170,255,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 44px 44px;
      opacity:0.12;
      mask-image: radial-gradient(circle at 55% 45%, black 55%, transparent 78%);
    }

    .wrap{height:100%; padding:10px 12px; display:flex; flex-direction:column; gap:10px;}

    /* Top strip */
    .topstrip{
      border-radius: 999px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      backdrop-filter: blur(10px);
    }
    .time{
      font-weight:950;
      font-size: 34px;
      letter-spacing: 0.5px;
      line-height:1;
      white-space:nowrap;
    }
    .metaLine{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      color: rgba(233,238,252,0.85);
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      background: rgba(51,230,209,0.10);
      border: 1px solid rgba(51,230,209,0.22);
      color: rgba(233,238,252,0.92);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--teal);box-shadow:0 0 12px rgba(51,230,209,0.5);}

    /* Panel shell */
    .panel{
      flex:1;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--stroke);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panelHeader{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      font-weight: 950;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 13px;
      color: rgba(233,238,252,0.88);
    }
    .panelHeader .right{
      color: rgba(233,238,252,0.60);
      font-weight:900;
      font-size: 12px;
      white-space:nowrap;
    }
    .panelBody{
      flex:1;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
    }

    /* Cards inside */
    .row{display:flex; gap:12px; min-height:0;}
    .col{flex:1; min-width:0; min-height:0;}
    .card{
      height:100%;
      border-radius: 18px;
      background: var(--card2);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-80px -80px auto auto;
      width:220px;height:220px;
      background: radial-gradient(circle, rgba(51,230,209,0.16), transparent 65%);
      transform: rotate(25deg);
      pointer-events:none;
    }
    .label{font-size:12px;font-weight:900;letter-spacing:0.5px;color:rgba(233,238,252,0.70);text-transform:uppercase;}
    .big{font-size:56px;font-weight:950;line-height:1;letter-spacing:0.3px;margin-top:8px;}
    .sub{margin-top:8px;color:rgba(233,238,252,0.72);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .pos{color:var(--pos)} .neg{color:var(--neg)}

    /* Headlines list */
    .list{display:flex;flex-direction:column;gap:10px;min-height:0;}
    .item{
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 12px 12px;
      min-height: 0;
    }
    .itemTitle{
      font-size: 16px;
      font-weight: 900;
      line-height: 1.2;
      max-height: 2.4em; /* 2 lines */
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .itemSrc{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(233,238,252,0.65);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Radar placeholder animation */
    .radar{
      border-radius: 18px;
      background:
        radial-gradient(circle at center, rgba(51,230,209,0.16), transparent 60%),
        repeating-radial-gradient(circle at center, rgba(255,255,255,0.06) 0 2px, transparent 2px 26px),
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
      overflow:hidden;
      flex:1;
      min-height: 0;
    }
    .sweep{
      position:absolute;
      inset:-40%;
      background: conic-gradient(from 0deg, transparent 0 300deg, rgba(51,230,209,0.16) 330deg, transparent 360deg);
      animation: spin 4s linear infinite;
      filter: blur(0.3px);
      opacity:0.9;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .radarLabel{
      position:absolute;
      left:12px; bottom:10px;
      font-size:12px;
      color: rgba(233,238,252,0.70);
      font-weight: 800;
    }

    .footer{
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 12px;
      color: rgba(233,238,252,0.70);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topstrip">
      <div class="time" id="time">—:—</div>
      <div class="metaLine" id="topMeta">Loading…</div>
      <div class="pill"><span class="dot"></span><span id="topStatus">LIVE</span></div>
    </div>

    <div class="panel">
      <div class="panelHeader">
        <div id="panelTitle">WEATHER</div>
        <div class="right" id="panelHint">NOW + TOMORROW + RADAR</div>
      </div>
      <div class="panelBody" id="panelBody">
        <!-- injected -->
      </div>
      <div class="footer">
        <div>Edge Dashboard</div>
        <div id="stamp">—</div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let config = null;
  let pageIdx = 0;
  let cycleTimer = null;
  let refreshTimer = null;

  const pages = [
    { key:"weather", title:"WEATHER", hint:"NOW + TOMORROW + RADAR" },
    { key:"market", title:"MARKET", hint:"SPY + VXX + SECTORS + HEADLINES" },
    { key:"news",   title:"HEADLINES", hint:"US + WORLD + BUSINESS" },
  ];

  async function loadConfig(){
    const r = await fetch("./edge.config.json", { cache:"no-store" });
    config = await r.json();
  }

  function fmtTime(d){
    return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  }

  function setStamp(){
    $("stamp").textContent = "Updated " + fmtTime(new Date());
  }

  async function getJSON(url){
    const r = await fetch(url + (url.includes("?") ? "&" : "?") + "t=" + Date.now(), { cache:"no-store" });
    const ct = r.headers.get("content-type") || "";
    if(!ct.includes("application/json")){
      const text = await r.text();
      return { ok:false, error:`Non-JSON response (${r.status}). First chars: ${text.slice(0,80)}` };
    }
    const data = await r.json().catch(() => null);
    if(!data) return { ok:false, error:`Invalid JSON (${r.status})` };
    if(!r.ok && data.ok !== true) data.ok = false;
    return data;
  }

  function renderError(title, msg){
    $("panelBody").innerHTML = `
      <div class="card" style="height:auto">
        <div class="label">PANEL ERROR</div>
        <div style="margin-top:10px;font-weight:950;font-size:20px;line-height:1.2">${title}</div>
        <div style="margin-top:8px;color:rgba(233,238,252,0.70);font-size:13px">${msg}</div>
      </div>
    `;
  }

  function clsFor(n){ return n > 0 ? "pos" : (n < 0 ? "neg" : ""); }

  function renderWeather(data){
    const now = data.now || {};
    const tom = data.tomorrow || {};
    const aqi = data.aqi || null;

    $("panelBody").innerHTML = `
      <div class="row" style="height:180px">
        <div class="col">
          <div class="card">
            <div class="label">${(config.locationName || "Local").toUpperCase()} WEATHER</div>
            <div class="big">${now.tempF ?? "—"}°</div>
            <div class="sub">Wind ${now.windMph ?? "—"} mph • Rain ${now.rainChancePct ?? "—"}%</div>
            <div class="sub">Sunrise ${now.sunrise ?? "—"} • Sunset ${now.sunset ?? "—"} • AQI ${aqi?.value ?? "—"}${aqi?.label ? ` (${aqi.label})` : ""}</div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="label">TOMORROW</div>
            <div class="big" style="font-size:44px">${tom.highF ?? "—"}° / ${tom.lowF ?? "—"}°</div>
            <div class="sub">Summary: ${tom.summary ?? "—"}</div>
            <div class="sub">AQI: ${aqi?.value ?? "—"}${aqi?.label ? ` (${aqi.label})` : ""}</div>
          </div>
        </div>
      </div>

      <div class="radar">
        <div class="sweep"></div>
        <div class="radarLabel">Radar (scan placeholder)</div>
      </div>
    `;
  }

  function renderMarket(data){
    const spy = data.spy || {};
    const vxx = data.vxx || {};
    const sectors = data.sectors || [];
    const headline = data.headline || null;

    const sectorLines = sectors.slice(0,8).map(s =>
      `<span class="${clsFor(s.pct)}">${s.symbol} ${s.pct>0?"+":""}${(s.pct ?? 0).toFixed(2)}%</span>`
    );

    $("panelBody").innerHTML = `
      <div class="row" style="height:180px">
        <div class="col">
          <div class="card">
            <div class="label">S&amp;P 500 Proxy (SPY)</div>
            <div class="big">${spy.price ?? "—"}</div>
            <div class="sub ${clsFor(spy.pct)}">${spy.pct != null ? `${spy.pct>0?"+":""}${spy.pct.toFixed(2)}% today` : "—"}</div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="label">Vol Proxy (VXX)</div>
            <div class="big">${vxx.price ? `VXX ${vxx.price}` : "—"}</div>
            <div class="sub ${clsFor(vxx.pct)}">${vxx.pct != null ? `${vxx.pct>0?"+":""}${vxx.pct.toFixed(2)}% today` : "—"}</div>
          </div>
        </div>
      </div>

      <div class="row" style="flex:1; min-height:0">
        <div class="col">
          <div class="card">
            <div class="label">Sectors (bigger + readable)</div>
            <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; font-weight:900; color:rgba(233,238,252,0.90)">
              ${sectorLines.length ? sectorLines.join("") : `<span style="color:rgba(233,238,252,0.55)">—</span>`}
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="label">Market Headline</div>
            <div style="margin-top:10px; font-weight:950; font-size:18px; line-height:1.2; max-height:3.6em; overflow:hidden">
              ${headline?.title ? headline.title : "—"}
            </div>
            <div class="sub">${headline?.source || "—"}</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderNews(data){
    const items = (data.items || []).slice(0,5);
    $("panelBody").innerHTML = `
      <div class="list">
        ${items.length ? items.map(it => `
          <div class="item">
            <div class="itemTitle">${it.title || "—"}</div>
            <div class="itemSrc">${it.source || "—"}</div>
          </div>
        `).join("") : `
          <div class="item">
            <div class="itemTitle">No headlines returned</div>
            <div class="itemSrc">—</div>
          </div>
        `}
      </div>
    `;
  }

  async function refreshTopstrip(){
    const d = new Date();
    $("time").textContent = fmtTime(d);

    const data = await getJSON(`/api/topstrip?lat=${encodeURIComponent(config.lat)}&lon=${encodeURIComponent(config.lon)}&name=${encodeURIComponent(config.locationName)}`);
    if(data.ok){
      $("topMeta").textContent = `${data.location} • ${data.tempF}° • Wind ${data.windMph} mph • AQI ${data.aqiValue}${data.aqiLabel ? ` (${data.aqiLabel})` : ""}`;
      $("topStatus").textContent = "LIVE";
    } else {
      $("topMeta").textContent = `Top strip unavailable • ${data.error || "—"}`;
      $("topStatus").textContent = "SYNC";
    }
  }

  async function refreshPanel(){
    const p = pages[pageIdx];
    $("panelTitle").textContent = p.title;
    $("panelHint").textContent = p.hint;

    let url = "";
    if(p.key === "weather"){
      url = `/api/weather?lat=${encodeURIComponent(config.lat)}&lon=${encodeURIComponent(config.lon)}&name=${encodeURIComponent(config.locationName)}`;
    } else if(p.key === "market"){
      url = `/api/market`;
    } else if(p.key === "news"){
      url = `/api/news?mode=${encodeURIComponent(config.newsMode || "")}`;
    }

    const data = await getJSON(url);
    if(!data.ok){
      renderError(`${p.title}: data missing`, data.error || "Unknown error");
      return;
    }

    if(p.key === "weather") renderWeather(data);
    if(p.key === "market") renderMarket(data);
    if(p.key === "news") renderNews(data);

    setStamp();
  }

  function startCycle(){
    const cycleMs = (config.cycleSeconds ?? 12) * 1000;
    if(cycleTimer) clearInterval(cycleTimer);
    cycleTimer = setInterval(async () => {
      pageIdx = (pageIdx + 1) % pages.length;
      await refreshPanel();
    }, cycleMs);
  }

  function startRefresh(){
    const refreshMs = (config.refreshSeconds ?? 120) * 1000;
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(async () => {
      await refreshTopstrip();
      await refreshPanel();
    }, refreshMs);
  }

  (async function init(){
    await loadConfig();
    await refreshTopstrip();
    await refreshPanel();
    startCycle();
    startRefresh();
    setInterval(refreshTopstrip, 1000); // keep clock alive
  })();
</script>
</body>
</html>
