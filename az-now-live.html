<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AZ NOW — Live Traffic + Cams</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#0d1230; --bg1:#171a3b;
      --ink:#f7f3ff; --muted:#d7d2ff;
      --line:#ffffff22; --shadow: 0 10px 30px #00000066;

      --peach:#ffb48a; --mint:#89f0d1; --sky:#86b7ff; --lav:#c3a1ff; --pink:#ff8fd1; --lemon:#ffe27a; --teal:#2bd9ff;
      --danger:#ff5b6e; --warn:#ffbf4a; --ok:#60ffb0;

      --radius: 18px; --radius2: 14px;
      --hdrH: 60px; --tickerH: 56px;
      --pad: 14px;

      --font-ui: "IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-retro: "VT323", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;

      /* === NEW: Edge tuning knobs === */
      --camScale: 1;            /* 1 = normal (big monitor). Smaller = zoom OUT camera */
      --tickerSeconds: 65;      /* slower ticker (bigger = slower) */
    }

    *{ box-sizing:border-box; }
    html,body{ width:100%; height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 500px at 20% 30%, #7b6cff30, transparent 55%),
        radial-gradient(900px 420px at 75% 20%, #2bd9ff24, transparent 60%),
        radial-gradient(900px 500px at 60% 80%, #ff8fd124, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
      font-family:var(--font-ui);
    }

    /* Fullscreen bar */
    .bar{
      width:100vw;
      height:100vh;
      border-radius:0;
      position:relative;
      overflow:hidden;
      box-shadow:none;
      border:0;
      background:
        linear-gradient(90deg, #ffffff14, #ffffff08 40%, #ffffff12),
        radial-gradient(700px 280px at 20% 30%, #ffb48a18, transparent 60%),
        radial-gradient(600px 260px at 75% 35%, #89f0d118, transparent 60%),
        radial-gradient(700px 300px at 50% 120%, #c3a1ff14, transparent 55%),
        linear-gradient(180deg, #13163a, #0f1232);
    }

    /* CRT scanlines */
    .bar::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.04),
        rgba(255,255,255,0.04) 1px,
        rgba(0,0,0,0.0) 2px,
        rgba(0,0,0,0.0) 4px
      );
      opacity:.40;
      pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 4;
    }

    /* Header */
    .header{
      height:var(--hdrH);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      padding: 10px 14px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, #ffb48a66, #c3a1ff55 35%, #86b7ff55 60%, #89f0d155),
        linear-gradient(180deg, #ffffff12, #0000);
      z-index: 5;
      position:relative;
    }
    .brand{ display:flex; align-items:baseline; gap:12px; }
    .logo{
      font-family:var(--font-retro);
      font-size:42px;
      letter-spacing:2px;
      text-shadow:0 2px 0 #0007;
      line-height:1;
    }
    .sub{
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      opacity:.9;
    }
    .meta{
      display:flex; align-items:center; gap:14px;
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      background:#0003; border:1px solid #fff3;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px #fff2, 0 0 16px var(--ok);
    }

    /* Main grid */
    .main{
      height: calc(100% - var(--hdrH) - var(--tickerH));
      padding: var(--pad);
      display:grid;
      grid-template-columns: 1.05fr 1.35fr 1.6fr; /* Left | Center | Right */
      gap: 12px;
      position:relative;
      z-index: 2;
      min-height: 0;
    }

    .panel{
      background: linear-gradient(180deg, #ffffff14, #ffffff08);
      border: 1px solid #ffffff20;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px #0003;
      position:relative;
      min-height: 0;
    }
    .panelTitle{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid #ffffff22;
      background:
        linear-gradient(90deg, #86b7ff30, #c3a1ff24, #ff8fd120),
        linear-gradient(180deg, #ffffff14, #0000);
    }
    .panelTitle h3{
      margin:0;
      font-family:var(--font-retro);
      font-size:26px;
      letter-spacing:1px;
    }
    .panelTitle small{
      font-family:var(--font-retro);
      font-size:18px;
      opacity:.85;
      letter-spacing:.5px;
      white-space:nowrap;
    }

    /* Alerts */
    .alerts{
      padding: 10px 12px 12px;
      display:flex; flex-direction:column; gap:10px;
      height: calc(100% - 52px);
      overflow:auto;
    }
    .alert{
      display:grid;
      grid-template-columns: 34px 1fr auto;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: var(--radius2);
      background:#0002;
      border:1px solid #ffffff1e;
    }
    .icon{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      font-family:var(--font-retro);
      font-size:22px;
      color:#0b0f2a;
      box-shadow: inset 0 0 0 1px #0002;
    }
    .text .top{ font-weight:900; font-size:14px; line-height:1.1; }
    .text .sub{ opacity:.85; font-size:12px; margin-top:2px; }
    .tag{
      font-family:var(--font-retro);
      font-size:18px;
      padding: 6px 8px;
      border-radius:12px;
      border:1px solid #ffffff26;
      background:#0002;
      letter-spacing:1px;
      white-space:nowrap;
    }
    .a-danger .icon{ background:var(--danger); }
    .a-warn .icon{ background:var(--warn); }
    .a-ok .icon{ background:var(--mint); }

    /* === NEW CENTER PANEL: CITY STATUS (replaces fake map) === */
    .statusWrap{
      padding: 10px 12px 12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto 1fr;
      gap:10px;
      min-height: 0;
    }

    .bigStats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }

    .statCard{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      padding:10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height: 0;
    }
    .statCard .k{
      font-family:var(--font-retro);
      font-size:18px;
      letter-spacing:1px;
      opacity:.9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .statCard .v{
      display:flex;
      align-items: baseline;
      gap:10px;
    }
    .statCard .num{
      font-family:var(--font-retro);
      font-size:44px;
      letter-spacing:2px;
      color: var(--lemon);
      text-shadow:0 2px 0 #0007;
      line-height:1;
    }
    .statCard .sub{
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      opacity:.9;
    }
    .chipRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #ffffff24;
      background:#0002;
      font-family:var(--font-retro);
      font-size:18px;
      letter-spacing:1px;
      white-space:nowrap;
    }
    .chip i{
      width:10px;height:10px;border-radius:50%;
      display:inline-block;
      box-shadow: 0 0 0 3px #ffffff12, 0 0 14px currentColor;
    }
    .chip .t{ opacity:.9; }
    .chip .n{ color: var(--lemon); }

    .statusLower{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height: 0;
    }
    .card{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .cardHead{
      padding:10px 10px 8px;
      border-bottom:1px solid #ffffff1f;
      background: linear-gradient(90deg, #86b7ff1f, #c3a1ff18, #ff8fd112);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .cardHead .title{
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
    }
    .cardHead .small{
      font-family:var(--font-retro);
      font-size:18px;
      opacity:.85;
      letter-spacing:.5px;
      white-space:nowrap;
    }
    .list{
      padding:10px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 0;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      border-radius: 12px;
      border: 1px solid #ffffff1f;
      background:#0002;
      padding:10px 10px;
    }
    .row .name{
      font-weight:900;
      font-size:14px;
      line-height:1.1;
    }
    .row .desc{
      opacity:.85;
      font-size:12px;
      margin-top:3px;
    }
    .row .count{
      font-family:var(--font-retro);
      font-size:24px;
      letter-spacing:1px;
      color: var(--mint);
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }

    /* Live cam panel */
    .camWrap{
      padding:10px 12px 12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto 1fr;
      gap:10px;
      min-height: 0;
    }
    .camMeta{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      min-height: 0;
    }
    .camMeta .left{
      display:flex; align-items:center; gap:10px;
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:12px;
      padding:6px 10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .livePip{ display:inline-flex; align-items:center; gap:6px; }
    .livePip .dot{
      width:8px; height:8px;
      background:var(--danger);
      box-shadow:0 0 14px #ff5b6ecc;
    }
    .camMeta .right{
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:12px;
      padding:6px 10px;
      white-space:nowrap;
    }

    .camBox{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      overflow:hidden;
      background:#0002;
      position:relative;
      min-height: 0;
    }
    .camFrame, .camFallback{
      position:absolute; inset:0;
      border:0;
    }

    /* === NEW: “Zoom out” iframe content for small screens === */
    .camFrame{
      transform: scale(var(--camScale));
      transform-origin: 0 0;
      width: calc(100% / var(--camScale));
      height: calc(100% / var(--camScale));
    }
    .camFallback{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      padding:16px;
      text-align:center;
      color: var(--muted);
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
      background:
        radial-gradient(900px 260px at 60% 70%, #ffb48a22, transparent 55%),
        radial-gradient(700px 240px at 30% 50%, #86b7ff1f, transparent 60%),
        linear-gradient(180deg, #0b0f2b, #070a1d);
      display:none; /* start hidden; show on block */
    }
    .camFallback small{
      display:block;
      font-size:18px;
      opacity:.85;
      margin-top:10px;
      font-family: var(--font-ui);
      letter-spacing:0;
    }

    /* Ticker */
    .ticker{
      height:var(--tickerH);
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      background:
        linear-gradient(90deg, #86b7ff2a, #ff8fd124 45%, #89f0d124),
        linear-gradient(180deg, #0000, #0002);
      position:relative;
      z-index:5;
    }
    .tickerBrand{
      font-family:var(--font-retro);
      font-size:34px;
      letter-spacing:2px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .tickerLine{
      overflow:hidden;
      white-space:nowrap;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      height:100%;
      display:flex;
      align-items:center;
      position:relative;
      min-width: 0;
    }
    .tickerLine span{
      display:inline-block;
      padding-left: 100%;
      font-family:var(--font-retro);
      font-size:24px;
      letter-spacing:1px;
      animation: scroll var(--tickerSeconds) linear infinite; /* NEW: slower ticker */
      text-shadow:0 2px 0 #0007;
      will-change: transform;
    }
    @keyframes scroll{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }
    .clockBox{
      font-family:var(--font-retro);
      font-size:34px;
      letter-spacing:2px;
      padding:6px 12px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      color:var(--lemon);
      white-space:nowrap;
    }

    /* BREAKING overlay */
    .breaking{
      position:absolute; inset:0;
      display:none;
      z-index: 20;
      background: linear-gradient(180deg, #000000aa, #00000055);
      backdrop-filter: blur(4px);
    }
    .breaking .box{
      position:absolute;
      left: 18px;
      right: 18px;
      top: 80px;
      border-radius: 18px;
      border: 1px solid #ffffff26;
      background:
        linear-gradient(90deg, #ff5b6e88, #ffbf4a55 40%, #86b7ff55),
        linear-gradient(180deg, #00000022, #00000066);
      box-shadow: 0 20px 50px #0008;
      padding: 16px 16px 14px;
      overflow:hidden;
    }
    .breaking .label{
      font-family: var(--font-retro);
      font-size: 34px;
      letter-spacing: 2px;
      display:flex;
      align-items:center;
      gap:10px;
      color:#0b0f2a;
      text-shadow:none;
    }
    .breaking .label .pulse{
      width: 12px; height: 12px;
      border-radius: 50%;
      background: #0b0f2a;
      box-shadow: 0 0 0 0 rgba(11,15,42,0.0);
      animation: pulse 0.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity: 0.9; }
      50%{ transform: scale(1.45); opacity: 1; }
      100%{ transform: scale(1); opacity: 0.9; }
    }
    .breaking .msg{
      margin-top: 8px;
      color: #0b0f2a;
      font-weight: 900;
      font-size: 18px;
    }
    .breaking .submsg{
      margin-top: 4px;
      color: #0b0f2a;
      opacity: .9;
      font-size: 14px;
    }

    /* === Edge / short-height tuning === */
    @media (max-height: 820px){
      :root{
        --camScale: 0.31;       /* zoom OUT camera on Xeneon Edge */
        --tickerSeconds: 85;    /* even slower ticker on the small screen */
      }
      .statCard .num{ font-size: 40px; }
      .camMeta .left, .camMeta .right{ font-size: 18px; }
    }
  </style>
</head>

<body>
  <div class="bar" role="img" aria-label="AZ NOW live traffic and cams dashboard">
    <div class="header">
      <div class="brand">
        <div class="logo">AZ NOW</div>
        <div class="sub">LIVE TRAFFIC + CAMS</div>
      </div>

      <div class="meta">
        <div class="pill"><span class="dot"></span><span>LIVE</span></div>
        <div class="pill" id="datePill">—</div>
        <!-- Removed: RETRO 8s LIVE -->
      </div>
    </div>

    <div class="main">
      <!-- LEFT: ALERTS -->
      <section class="panel">
        <div class="panelTitle">
          <h3>TRAFFIC INCIDENTS</h3>
          <small id="alertsCount">—</small>
        </div>
        <div class="alerts" id="alertsList">
          <div class="alert a-ok">
            <div class="icon">…</div>
            <div class="text">
              <div class="top">LOADING</div>
              <div class="sub">Waiting for AZ511 events…</div>
            </div>
            <div class="tag">LIVE</div>
          </div>
        </div>
      </section>

      <!-- CENTER: CITY STATUS (replaces fake map) -->
      <section class="panel">
        <div class="panelTitle">
          <h3>CITY STATUS</h3>
          <small>LAST UPDATE: <span id="statusUpdated">—</span></small>
        </div>

        <div class="statusWrap">
          <div class="bigStats">
            <div class="statCard">
              <div class="k">ACTIVE EVENTS</div>
              <div class="v">
                <div class="num" id="statEventsBig">—</div>
                <div class="sub">TOTAL</div>
              </div>
              <div class="chipRow" id="sevChips">
                <!-- injected -->
              </div>
            </div>

            <div class="statCard">
              <div class="k">CAMERAS ONLINE</div>
              <div class="v">
                <div class="num" id="statCamsBig">—</div>
                <div class="sub">FEEDS</div>
              </div>
              <div class="chipRow" id="typeChips">
                <!-- injected -->
              </div>
            </div>

            <div class="statCard">
              <div class="k">NEXT CAM ROTATE</div>
              <div class="v">
                <div class="num" id="statNextBig">—</div>
                <div class="sub">SEC</div>
              </div>
              <div class="chipRow">
                <span class="chip"><i style="color:var(--danger);background:var(--danger)"></i><span class="t">BREAKING</span> <span class="n" id="breakingCount">0</span></span>
                <span class="chip"><i style="color:var(--mint);background:var(--mint)"></i><span class="t">UPDATED</span> <span class="n" id="updatedAgo">—</span></span>
              </div>
            </div>
          </div>

          <div class="statusLower">
            <div class="card">
              <div class="cardHead">
                <div class="title">TOP CORRIDORS</div>
                <div class="small" id="corridorsHint">by event count</div>
              </div>
              <div class="list" id="corridorsList">
                <!-- injected -->
              </div>
            </div>

            <div class="card">
              <div class="cardHead">
                <div class="title">LATEST EVENTS</div>
                <div class="small">first 6</div>
              </div>
              <div class="list" id="latestList">
                <!-- injected -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: LIVE CAM -->
      <section class="panel">
        <div class="panelTitle">
          <h3>LIVE CAMERA</h3>
          <small>FEED: <span id="camIndex">—</span></small>
        </div>

        <div class="camWrap">
          <div class="camMeta">
            <div class="left" title="Camera location">
              <span class="livePip"><span class="dot"></span>LIVE</span>
              <span id="camLabel">Loading cameras…</span>
            </div>
            <div class="right">ROTATE: <span id="camCountdown">—</span>s</div>
          </div>

          <div class="camBox">
            <iframe class="camFrame" id="camFrame" title="AZ511 camera view"
              sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>

            <div class="camFallback" id="camFallback">
              CAMERA EMBED BLOCKED
              <small>If AZ511 disallows iframe embedding, we can switch to still images (if provided) or proxy a snapshot endpoint.</small>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="ticker">
      <div class="tickerBrand">AZ NOW</div>
      <div class="tickerLine"><span id="tickerText">CONNECTING TO AZ511…</span></div>
      <div class="clockBox" id="clock">—:— —</div>
    </div>

    <div class="breaking" id="breaking">
      <div class="box">
        <div class="label"><span class="pulse"></span>BREAKING</div>
        <div class="msg" id="breakingMsg">New traffic event detected</div>
        <div class="submsg" id="breakingSub">Switching to nearest camera…</div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG (edit these only)
  // =========================
  const WORKER_BASE = "https://az-now-511-proxy.zachary-1-marshall.workers.dev";
  const CAMERA_ROTATE_SECONDS = 20;
  const EVENTS_POLL_SECONDS = 45;        // incidents refresh
  const CAMS_REFRESH_SECONDS  = 10 * 60; // refresh camera list every 10 min

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function setDatePill(){
    const d = new Date();
    const days = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    $("datePill").textContent = `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  }

  function updateClock(){
    const d = new Date();
    const h24 = d.getHours();
    const m = d.getMinutes();
    const ampm = h24 >= 12 ? "PM" : "AM";
    const h = ((h24 + 11) % 12) + 1;
    $("clock").textContent = `${h}:${pad2(m)} ${ampm}`;
  }

  function nowStamp(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  // Haversine distance (miles)
  function distMiles(lat1, lon1, lat2, lon2){
    const toRad = (x) => x * Math.PI / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function setTicker(text){
    $("tickerText").textContent = text;
  }

  function pickEventLatLon(e){
    const lat = Number(e.Latitude ?? e.Lat ?? e.Y ?? e.LocationLatitude);
    const lon = Number(e.Longitude ?? e.Lon ?? e.Long ?? e.X ?? e.LocationLongitude);
    if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
    return null;
  }

  // =========================
  // State
  // =========================
  let cameras = [];
  let camIdx = 0;
  let camCountdown = CAMERA_ROTATE_SECONDS;

  let lastEventIds = new Set();
  let lastEvents = [];
  let lastEventsAt = 0;

  let breakingTimer = null;
  let breakingCount = 0;

  // =========================
  // Fetchers
  // =========================
  async function getJSON(path){
    const url = `${WORKER_BASE}/${path.replace(/^\/+/,"")}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  async function loadCameras(){
    const data = await getJSON("cameras");

    const cleaned = [];
    for(const cam of data){
      const views = Array.isArray(cam.Views) ? cam.Views : [];
      const enabled = views.filter(v => (v.Status || "").toLowerCase() === "enabled" && v.Url);
      if(!enabled.length) continue;

      cleaned.push({
        id: cam.Id ?? cam.id,
        roadway: cam.Roadway || "",
        location: cam.Location || cam.Description || "",
        lat: Number(cam.Latitude),
        lon: Number(cam.Longitude),
        viewUrl: enabled[0].Url,
        viewDesc: enabled[0].Description || cam.Location || "Camera"
      });
    }

    cameras = cleaned;

    $("statCamsBig").textContent = cameras.length ? String(cameras.length) : "0";

    if(camIdx >= cameras.length) camIdx = 0;

    if(cameras.length){
      showCamera(camIdx);
      setTicker(`CAMERAS ONLINE • ${cameras.length} FEEDS • LAST UPDATE ${nowStamp()} •`);
    } else {
      setTicker(`NO CAMERAS FOUND • CHECK WORKER /cameras • LAST UPDATE ${nowStamp()} •`);
    }
  }

  // =========================
  // LEFT: Alerts rendering
  // =========================
  function renderAlerts(events){
    const list = $("alertsList");
    list.innerHTML = "";

    const max = Math.min(events.length, 10);
    $("alertsCount").textContent = `${events.length} ITEMS`;

    if(!events.length){
      list.innerHTML = `
        <div class="alert a-ok">
          <div class="icon">✓</div>
          <div class="text">
            <div class="top">NO ACTIVE EVENTS</div>
            <div class="sub">Smooth sailing (or the API is quiet).</div>
          </div>
          <div class="tag">OK</div>
        </div>`;
      return;
    }

    for(let i=0;i<max;i++){
      const e = events[i];
      const sev = (e.Severity || e.SeverityId || "").toString();
      const type = (e.EventType || e.Type || e.EventCategory || "EVENT").toString();
      const road = (e.RoadwayName || e.Roadway || e.Road || "").toString();
      const desc = (e.Description || e.ShortDescription || e.EventDescription || "").toString();
      const loc  = (e.Location || e.LocationDescription || "").toString();

      let cls = "a-ok";
      let icon = "•";
      let tag = sev ? `SEV ${sev}` : "LIVE";
      if(Number(sev) >= 3){ cls="a-danger"; icon="!"; }
      else if(Number(sev) === 2){ cls="a-warn"; icon="⛏"; }
      else { cls="a-ok"; icon="•"; }

      const top = (type || "EVENT").slice(0,22);
      const sub = (desc || loc || road || "Traffic event").slice(0,80);

      const el = document.createElement("div");
      el.className = `alert ${cls}`;
      el.innerHTML = `
        <div class="icon">${escapeHTML(icon)}</div>
        <div class="text">
          <div class="top">${escapeHTML(top)}</div>
          <div class="sub">${escapeHTML(sub)}</div>
        </div>
        <div class="tag">${escapeHTML(tag)}</div>
      `;
      list.appendChild(el);
    }
  }

  // =========================
  // CENTER: City status rendering
  // =========================
  function normalizeType(e){
    const t = (e.EventType || e.Type || e.EventCategory || "").toString().trim();
    if(!t) return "OTHER";
    const up = t.toUpperCase();
    if(up.includes("CRASH") || up.includes("ACCIDENT") || up.includes("INCIDENT")) return "CRASH";
    if(up.includes("CLOS") || up.includes("BLOCK") || up.includes("LANE")) return "CLOSURE";
    if(up.includes("WORK") || up.includes("CONST")) return "ROADWORK";
    if(up.includes("WEATHER") || up.includes("WIND") || up.includes("DUST") || up.includes("FOG")) return "WEATHER";
    return t.split(/\s+/)[0].slice(0,10).toUpperCase();
  }

  function normalizeRoad(e){
    const r = (e.RoadwayName || e.Roadway || e.Road || e.Route || "").toString().trim();
    if(r) return r;
    const loc = (e.Location || e.LocationDescription || "").toString();
    const m = loc.match(/\b(I-\d+|US-\d+|SR-\d+)\b/i);
    return m ? m[1].toUpperCase() : "LOCAL";
  }

  function renderCityStatus(events){
    $("statEventsBig").textContent = String(events.length);

    // chips: severity bucket counts
    const sevBuckets = { "SEV 3+": 0, "SEV 2": 0, "SEV 1/0": 0, "UNK": 0 };
    const typeBuckets = { "CRASH": 0, "ROADWORK": 0, "CLOSURE": 0, "WEATHER": 0, "OTHER": 0 };
    const corridorCounts = new Map();

    for(const e of events){
      const sev = Number((e.Severity ?? e.SeverityId ?? "").toString());
      if(Number.isFinite(sev)){
        if(sev >= 3) sevBuckets["SEV 3+"]++;
        else if(sev === 2) sevBuckets["SEV 2"]++;
        else sevBuckets["SEV 1/0"]++;
      } else {
        sevBuckets["UNK"]++;
      }

      const typ = normalizeType(e);
      if(typeBuckets[typ] == null) typeBuckets["OTHER"]++;
      else typeBuckets[typ]++;

      const road = normalizeRoad(e);
      corridorCounts.set(road, (corridorCounts.get(road) || 0) + 1);
    }

    // Sev chips
    const sevEl = $("sevChips");
    sevEl.innerHTML = "";
    const sevChip = (label, n, colorVar) => {
      const span = document.createElement("span");
      span.className = "chip";
      span.innerHTML = `<i style="color:var(${colorVar});background:var(${colorVar})"></i><span class="t">${escapeHTML(label)}</span> <span class="n">${n}</span>`;
      sevEl.appendChild(span);
    };
    sevChip("SEV 3+", sevBuckets["SEV 3+"], "--danger");
    sevChip("SEV 2",  sevBuckets["SEV 2"],  "--warn");
    sevChip("SEV 1",  sevBuckets["SEV 1/0"],"--mint");
    if(sevBuckets["UNK"]) sevChip("UNK", sevBuckets["UNK"], "--sky");

    // Type chips
    const typeEl = $("typeChips");
    typeEl.innerHTML = "";
    const typeChip = (label, n, colorVar) => {
      const span = document.createElement("span");
      span.className = "chip";
      span.innerHTML = `<i style="color:var(${colorVar});background:var(${colorVar})"></i><span class="t">${escapeHTML(label)}</span> <span class="n">${n}</span>`;
      typeEl.appendChild(span);
    };
    typeChip("CRASH",   typeBuckets["CRASH"],   "--danger");
    typeChip("WORK",    typeBuckets["ROADWORK"],"--warn");
    typeChip("CLOSE",   typeBuckets["CLOSURE"], "--pink");
    typeChip("WX",      typeBuckets["WEATHER"], "--sky");
    if(typeBuckets["OTHER"]) typeChip("OTHER", typeBuckets["OTHER"], "--mint");

    // Top corridors list
    const corridors = [...corridorCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);
    const corridorsList = $("corridorsList");
    corridorsList.innerHTML = "";
    if(!corridors.length){
      corridorsList.innerHTML = `<div class="row"><div><div class="name">NO CORRIDOR DATA</div><div class="desc">Events may not include roadway fields.</div></div><div class="count">—</div></div>`;
    } else {
      for(const [road, n] of corridors){
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <div class="name">${escapeHTML(road)}</div>
            <div class="desc">Most activity on this corridor</div>
          </div>
          <div class="count">${n}</div>
        `;
        corridorsList.appendChild(row);
      }
    }

    // Latest events list
    const latestList = $("latestList");
    latestList.innerHTML = "";
    const latest = events.slice(0,6);
    if(!latest.length){
      latestList.innerHTML = `<div class="row"><div><div class="name">NO EVENTS</div><div class="desc">Enjoy the calm.</div></div><div class="count">✓</div></div>`;
    } else {
      for(const e of latest){
        const type = (e.EventType || e.Type || "EVENT").toString().slice(0,18);
        const road = normalizeRoad(e);
        const desc = (e.Description || e.ShortDescription || e.Location || "").toString().slice(0,60);
        const sev = (e.Severity || e.SeverityId || "").toString();
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <div class="name">${escapeHTML(type)} • ${escapeHTML(road)}</div>
            <div class="desc">${escapeHTML(desc || "Traffic event")}</div>
          </div>
          <div class="count">${escapeHTML(sev ? "S"+sev : "LIVE")}</div>
        `;
        latestList.appendChild(row);
      }
    }

    // Update "updated ago"
    lastEventsAt = Date.now();
    updateUpdatedAgo();
  }

  function updateUpdatedAgo(){
    const el = $("updatedAgo");
    if(!lastEventsAt){ el.textContent = "—"; return; }
    const sec = Math.max(0, Math.round((Date.now()-lastEventsAt)/1000));
    if(sec < 60) el.textContent = `${sec}s`;
    else el.textContent = `${Math.round(sec/60)}m`;
  }

  // =========================
  // Events loading
  // =========================
  async function loadEvents(){
    let data;
    try {
      data = await getJSON("event");
    } catch (e) {
      data = await getJSON("alerts");
    }

    lastEvents = Array.isArray(data) ? data : (data?.Events || data?.events || []);

    // New events detection
    const ids = new Set();
    const newOnes = [];
    for(const ev of lastEvents){
      const id = (ev.Id ?? ev.EventId ?? ev.EventID ?? ev.IncidentId ?? ev.IncidentID ?? ev.Guid ?? ev.GUID ?? ev.SourceId ?? JSON.stringify(ev).slice(0,80));
      const sid = String(id);
      ids.add(sid);
      if(!lastEventIds.has(sid)) newOnes.push(ev);
    }

    $("statusUpdated").textContent = nowStamp();
    renderAlerts(lastEvents);
    renderCityStatus(lastEvents);

    // If new events appeared -> BREAKING + jump camera
    if(lastEventIds.size && newOnes.length){
      breakingCount += newOnes.length;
      $("breakingCount").textContent = String(breakingCount);
      const picked = newOnes[0];
      triggerBreaking(picked);
      jumpToNearestCamera(picked);
    }

    lastEventIds = ids;

    setTicker(buildTicker(lastEvents));
  }

  function buildTicker(events){
    const base = `AZ NOW LIVE • ${events.length} ACTIVE EVENTS • CAM ROTATION ${CAMERA_ROTATE_SECONDS}s • ${nowStamp()} • `;
    if(!events.length) return base + "NO MAJOR INCIDENTS REPORTED • DRIVE SMART!";
    const blurbs = [];
    for(const e of events.slice(0,4)){
      const t = (e.EventType || e.Type || "EVENT");
      const r = (e.RoadwayName || e.Roadway || "");
      const d = (e.Description || e.ShortDescription || "");
      const b = `${t}${r ? " " + r : ""}${d ? " — " + d : ""}`.replace(/\s+/g," ").trim();
      if(b) blurbs.push(b.slice(0,120));
    }
    return base + blurbs.join(" • ") + " • STAY SAFE — DRIVE SMART!";
  }

  // =========================
  // Camera rotation
  // =========================
  function showCamera(index){
    if(!cameras.length) return;

    camIdx = (index + cameras.length) % cameras.length;
    const cam = cameras[camIdx];

    $("camIndex").textContent = `${camIdx+1}/${cameras.length}`;
    $("camLabel").textContent = (cam.viewDesc || cam.location || cam.roadway || `CAM ${cam.id}`).slice(0,70);

    const frame = $("camFrame");
    const fallback = $("camFallback");

    // detect load quickly
    let loaded = false;
    frame.onload = () => { loaded = true; fallback.style.display = "none"; };
    frame.src = cam.viewUrl;

    setTimeout(() => {
      if(!loaded){
        fallback.style.display = "grid";
      }
    }, 1200);
  }

  function nextCamera(){
    showCamera(camIdx + 1);
    camCountdown = CAMERA_ROTATE_SECONDS;
  }

  function jumpToNearestCamera(eventObj){
    if(!cameras.length) return;

    const p = pickEventLatLon(eventObj);
    if(!p) return;

    let bestI = 0;
    let bestD = Infinity;
    for(let i=0;i<cameras.length;i++){
      const c = cameras[i];
      if(!Number.isFinite(c.lat) || !Number.isFinite(c.lon)) continue;
      const d = distMiles(p.lat, p.lon, c.lat, c.lon);
      if(d < bestD){
        bestD = d;
        bestI = i;
      }
    }

    showCamera(bestI);
    camCountdown = CAMERA_ROTATE_SECONDS;
    $("breakingSub").textContent = `Nearest cam selected (~${bestD.toFixed(1)} mi)`;
  }

  // =========================
  // Breaking overlay
  // =========================
  function triggerBreaking(eventObj){
    const type = (eventObj.EventType || eventObj.Type || "TRAFFIC EVENT").toString();
    const desc = (eventObj.Description || eventObj.ShortDescription || "New incident reported").toString();
    const road = (eventObj.RoadwayName || eventObj.Roadway || "").toString();

    $("breakingMsg").textContent = `${type}${road ? " • " + road : ""}`;
    $("breakingSub").textContent = desc.slice(0,90);

    const el = $("breaking");
    el.style.display = "block";

    clearTimeout(breakingTimer);
    breakingTimer = setTimeout(() => {
      el.style.display = "none";
    }, 5200);
  }

  // =========================
  // Loops
  // =========================
  async function boot(){
    setDatePill();
    updateClock();
    setInterval(updateClock, 1000);

    // “updated ago” ticker
    setInterval(updateUpdatedAgo, 1000);

    try{
      await loadCameras();
    }catch(e){
      $("statCamsBig").textContent = "0";
      setTicker(`CAMERA LOAD FAILED • CHECK WORKER /cameras • ${nowStamp()} •`);
      console.error(e);
    }

    try{
      await loadEvents();
    }catch(e){
      setTicker(`EVENT LOAD FAILED • CHECK WORKER /event • ${nowStamp()} •`);
      console.error(e);
    }

    setInterval(() => {
      loadCameras().catch(console.error);
    }, CAMS_REFRESH_SECONDS * 1000);

    setInterval(() => {
      loadEvents().catch(console.error);
    }, EVENTS_POLL_SECONDS * 1000);

    setInterval(() => {
      if(!cameras.length) return;
      camCountdown--;
      if(camCountdown <= 0) nextCamera();

      $("camCountdown").textContent = String(camCountdown);
      $("statNextBig").textContent = String(camCountdown);
    }, 1000);

    // initial paint for next counter
    $("statNextBig").textContent = String(camCountdown);
    $("camCountdown").textContent = String(camCountdown);
  }

  boot();
</script>
</body>
</html>
