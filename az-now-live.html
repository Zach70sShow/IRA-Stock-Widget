<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AZ NOW — Live Traffic + Cams</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#0d1230; --bg1:#171a3b;
      --ink:#f7f3ff; --muted:#d7d2ff;
      --line:#ffffff22;

      --peach:#ffb48a; --mint:#89f0d1; --sky:#86b7ff; --lav:#c3a1ff; --pink:#ff8fd1; --lemon:#ffe27a; --teal:#2bd9ff;
      --danger:#ff5b6e; --warn:#ffbf4a; --ok:#60ffb0;

      --radius: 18px; --radius2: 14px;
      --hdrH: 60px; --tickerH: 56px;
      --pad: 14px;
--scale: 0.31;          /* <<< change this */
--origin: top left;     /* keeps it anchored */

      --font-ui: "IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-retro: "VT323", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ width:100%; height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 500px at 20% 30%, #7b6cff30, transparent 55%),
        radial-gradient(900px 420px at 75% 20%, #2bd9ff24, transparent 60%),
        radial-gradient(900px 500px at 60% 80%, #ff8fd124, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
      font-family:var(--font-ui);
    }

    .bar{
  width:100vw;
  height:100vh;

  transform: scale(var(--scale));
  transform-origin: var(--origin);

  /* IMPORTANT: expand the “virtual canvas” so scaled content fills screen */
  width: calc(100vw / var(--scale));
  height: calc(100vh / var(--scale));
}


    /* CRT scanlines */
    .bar::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.04),
        rgba(255,255,255,0.04) 1px,
        rgba(0,0,0,0.0) 2px,
        rgba(0,0,0,0.0) 4px
      );
      opacity:.40;
      pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 4;
    }

    /* Header */
    .header{
      height:var(--hdrH);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      padding: 10px 14px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, #ffb48a66, #c3a1ff55 35%, #86b7ff55 60%, #89f0d155),
        linear-gradient(180deg, #ffffff12, #0000);
      z-index: 5;
      position:relative;
    }
    .brand{ display:flex; align-items:baseline; gap:12px; }
    .logo{
      font-family:var(--font-retro);
      font-size:42px;
      letter-spacing:2px;
      text-shadow:0 2px 0 #0007;
      line-height:1;
    }
    .sub{
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      opacity:.9;
    }
    .meta{
      display:flex; align-items:center; gap:14px;
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      background:#0003; border:1px solid #fff3;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px #fff2, 0 0 16px var(--ok);
    }

    /* Main grid (3 columns) */
    .main{
      height: calc(100% - var(--hdrH) - var(--tickerH));
      padding: var(--pad);
      display:grid;
      grid-template-columns: 1.1fr 1.25fr 1.65fr; /* incidents | snapshot | camera */
      gap: 12px;
      position:relative;
      z-index: 2;
      min-height: 0;
    }

    .panel{
      background: linear-gradient(180deg, #ffffff14, #ffffff08);
      border: 1px solid #ffffff20;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px #0003;
      position:relative;
      min-height: 0;
    }
    .panelTitle{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid #ffffff22;
      background:
        linear-gradient(90deg, #86b7ff30, #c3a1ff24, #ff8fd120),
        linear-gradient(180deg, #ffffff14, #0000);
    }
    .panelTitle h3{
      margin:0;
      font-family:var(--font-retro);
      font-size:26px;
      letter-spacing:1px;
    }
    .panelTitle small{
      font-family:var(--font-retro);
      font-size:18px;
      opacity:.85;
      letter-spacing:.5px;
      white-space:nowrap;
    }

    /* Top incidents list */
    .incWrap{
      padding: 10px 12px 12px;
      height: calc(100% - 52px);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .story{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .storyTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-family: var(--font-retro);
      letter-spacing: 1px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ffffff26;
      background: #0002;
      font-size: 20px;
      white-space:nowrap;
    }
    .badge .bDot{
      width:10px; height:10px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 14px #ffbf4a55;
    }
    .badge.danger .bDot{ background: var(--danger); box-shadow: 0 0 14px #ff5b6e55; }
    .badge.ok .bDot{ background: var(--ok); box-shadow: 0 0 14px #60ffb055; }

    .storyTitle{
      font-weight: 900;
      font-size: 16px;
      line-height: 1.15;
    }
    .storySub{
      opacity:.9;
      font-size: 13px;
      line-height: 1.25;
      color: var(--muted);
    }

    /* Snapshot panel */
    .snapWrap{
      padding: 10px 12px 12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:10px;
      min-height: 0;
    }
    .snapRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .tile{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      padding: 10px 10px;
      min-height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
    }
    .tile .k{
      font-family: var(--font-retro);
      font-size: 18px;
      letter-spacing: 1px;
      opacity:.9;
    }
    .tile .v{
      font-family: var(--font-retro);
      font-size: 34px;
      letter-spacing: 1px;
      color: var(--lemon);
      text-shadow: 0 2px 0 #0007;
      line-height: 1;
    }
    .tile .s{
      font-size: 12px;
      color: var(--muted);
      opacity:.9;
    }

    .explain{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      padding: 12px 12px;
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .explain h4{
      margin:0;
      font-family: var(--font-retro);
      font-size: 24px;
      letter-spacing: 1px;
    }
    .explain p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
    }

    /* Camera panel */
    .camWrap{
      padding:10px 12px 12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:10px;
      min-height: 0;
    }
    .camHeaderRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-family: var(--font-retro);
      letter-spacing:1px;
    }
    .camHeaderRow .left{
      display:flex; align-items:center; gap:10px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:12px;
      padding:6px 10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      max-width: 70%;
      font-size: 20px;
    }
    .livePip{ display:inline-flex; align-items:center; gap:6px; }
    .livePip .dot{
      width:8px; height:8px;
      background:var(--danger);
      box-shadow:0 0 14px #ff5b6ecc;
    }
    .camHeaderRow .right{
      background:#0004;
      border:1px solid #fff2;
      border-radius:12px;
      padding:6px 10px;
      font-size: 20px;
      white-space:nowrap;
    }

    .modeRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:1px solid #ffffff26;
      background:#0002;
      color: var(--ink);
      border-radius: 999px;
      padding: 8px 12px;
      font-family: var(--font-retro);
      font-size: 20px;
      letter-spacing: 1px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn b{ color: var(--lemon); }
    .btn.active{
      border-color:#ffffff55;
      background: linear-gradient(90deg, #86b7ff22, #ff8fd11f, #89f0d11f);
      box-shadow: inset 0 0 0 1px #0003;
    }
    .btn .miniDot{
      width:10px; height:10px; border-radius:50%;
      background: var(--teal);
      box-shadow: 0 0 14px #2bd9ff55;
    }
    .btn.acc .miniDot{ background: var(--danger); box-shadow: 0 0 14px #ff5b6e55; }
    .btn.rand .miniDot{ background: var(--lav); box-shadow: 0 0 14px #c3a1ff55; }

    .camBox{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      overflow:hidden;
      background:#0002;
      position:relative;
      min-height: 0;
    }
    .camFrame, .camFallback{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
    }
    .camFallback{
      display:none;
      place-items:center;
      padding:16px;
      text-align:center;
      color: var(--muted);
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
      background:
        radial-gradient(900px 260px at 60% 70%, #ffb48a22, transparent 55%),
        radial-gradient(700px 240px at 30% 50%, #86b7ff1f, transparent 60%),
        linear-gradient(180deg, #0b0f2b, #070a1d);
    }
    .camFallback small{
      display:block;
      font-size:18px;
      opacity:.85;
      margin-top:10px;
      font-family: var(--font-ui);
      letter-spacing:0;
    }

    /* Ticker (slower + more readable) */
    .ticker{
      height:var(--tickerH);
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      background:
        linear-gradient(90deg, #86b7ff2a, #ff8fd124 45%, #89f0d124),
        linear-gradient(180deg, #0000, #0002);
      position:relative;
      z-index:5;
    }
    .tickerBrand{
      font-family:var(--font-retro);
      font-size:34px;
      letter-spacing:2px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
    }
    .tickerLine{
      overflow:hidden;
      white-space:nowrap;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      height:100%;
      display:flex;
      align-items:center;
      position:relative;
    }
    .tickerLine span{
      display:inline-block;
      padding-left: 100%;
      font-family:var(--font-retro);
      font-size:24px;
      letter-spacing:1px;
      animation: scroll 44s linear infinite; /* MUCH slower */
      text-shadow:0 2px 0 #0007;
    }
    @keyframes scroll{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }
    .clockBox{
      font-family:var(--font-retro);
      font-size:34px;
      letter-spacing:2px;
      padding:6px 12px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      color:var(--lemon);
      white-space:nowrap;
    }

    /* Breaking overlay */
    .breaking{
      position:absolute; inset:0;
      display:none;
      z-index: 20;
      background: linear-gradient(180deg, #000000aa, #00000055);
      backdrop-filter: blur(4px);
    }
    .breaking .box{
      position:absolute;
      left: 18px;
      right: 18px;
      top: 80px;
      border-radius: 18px;
      border: 1px solid #ffffff26;
      background:
        linear-gradient(90deg, #ff5b6e88, #ffbf4a55 40%, #86b7ff55),
        linear-gradient(180deg, #00000022, #00000066);
      box-shadow: 0 20px 50px #0008;
      padding: 16px 16px 14px;
      overflow:hidden;
    }
    .breaking .label{
      font-family: var(--font-retro);
      font-size: 34px;
      letter-spacing: 2px;
      display:flex;
      align-items:center;
      gap:10px;
      color:#0b0f2a;
    }
    .breaking .label .pulse{
      width: 12px; height: 12px;
      border-radius: 50%;
      background: #0b0f2a;
      animation: pulse 0.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity: 0.9; }
      50%{ transform: scale(1.45); opacity: 1; }
      100%{ transform: scale(1); opacity: 0.9; }
    }
    .breaking .msg{
      margin-top: 8px;
      color: #0b0f2a;
      font-weight: 900;
      font-size: 18px;
    }
    .breaking .submsg{
      margin-top: 4px;
      color: #0b0f2a;
      opacity: .9;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="bar" role="img" aria-label="AZ NOW live traffic and cams dashboard">
    <div class="header">
      <div class="brand">
        <div class="logo">AZ NOW</div>
        <div class="sub">LIVE TRAFFIC + CAMS</div>
      </div>

      <div class="meta">
        <div class="pill"><span class="dot"></span><span>LIVE</span></div>
        <div class="pill" id="datePill">—</div>
      </div>
    </div>

    <div class="main">
      <!-- TOP INCIDENTS -->
      <section class="panel">
        <div class="panelTitle">
          <h3>TOP INCIDENTS</h3>
          <small><span id="eventsCount">—</span> ACTIVE</small>
        </div>

        <div class="incWrap" id="topIncidents">
          <div class="story">
            <div class="storyTop">
              <div class="badge ok"><span class="bDot"></span>LOADING</div>
              <div style="font-family:var(--font-retro);font-size:20px;opacity:.85;">—</div>
            </div>
            <div class="storyTitle">Connecting to AZ511…</div>
            <div class="storySub">Waiting for your Worker proxy to return events.</div>
          </div>
        </div>
      </section>

      <!-- SNAPSHOT -->
      <section class="panel">
        <div class="panelTitle">
          <h3>CITY SNAPSHOT</h3>
          <small>UPDATED: <span id="updatedAt">—</span></small>
        </div>

        <div class="snapWrap">
          <div class="snapRow">
            <div class="tile">
              <div class="k">ACTIVE INCIDENTS</div>
              <div class="v" id="snapInc">—</div>
              <div class="s" id="snapDelta">—</div>
            </div>
            <div class="tile">
              <div class="k">CAMERAS ONLINE</div>
              <div class="v" id="snapCams">—</div>
              <div class="s">feeds available</div>
            </div>
          </div>

          <div class="snapRow">
            <div class="tile">
              <div class="k">MODE</div>
              <div class="v" id="snapMode">—</div>
              <div class="s" id="snapModeHint">—</div>
            </div>
            <div class="tile">
              <div class="k">NEXT CAM</div>
              <div class="v"><span id="snapNext">—</span>s</div>
              <div class="s">rotation timer</div>
            </div>
          </div>

          <div class="explain">
            <h4 id="explainTitle">WHAT YOU’RE SEEING</h4>
            <p id="explainBody">
              The “ACCIDENT” mode will jump to the nearest camera when a new incident appears, like a mini news director in your room.
              “HOUSE” mode rotates the closest cameras to your home pin. “RANDOM” is the chaos channel.
            </p>
          </div>
        </div>
      </section>

      <!-- LIVE CAM -->
      <section class="panel">
        <div class="panelTitle">
          <h3>LIVE CAMERA</h3>
          <small><span id="camIndex">—</span></small>
        </div>

        <div class="camWrap">
          <div class="camHeaderRow">
            <div class="left" title="Camera location">
              <span class="livePip"><span class="dot"></span>LIVE</span>
              <span id="camLabel">Loading cameras…</span>
            </div>
            <div class="right">NEXT: <span id="camCountdown">—</span>s</div>
          </div>

          <div class="modeRow">
            <button class="btn home active" id="btnHome" type="button"><span class="miniDot"></span>HOUSE</button>
            <button class="btn acc" id="btnAcc" type="button"><span class="miniDot"></span>ACCIDENT</button>
            <button class="btn rand" id="btnRand" type="button"><span class="miniDot"></span>RANDOM</button>
          </div>

          <div class="camBox">
            <iframe class="camFrame" id="camFrame" title="AZ511 camera view"
              sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            <div class="camFallback" id="camFallback">
              CAMERA EMBED BLOCKED
              <small>If AZ511 disallows iframe embedding, we can swap to stills/snapshots (if provided) or proxy a snapshot endpoint.</small>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="ticker">
      <div class="tickerBrand">AZ NOW</div>
      <div class="tickerLine"><span id="tickerText">CONNECTING TO AZ511…</span></div>
      <div class="clockBox" id="clock">—:— —</div>
    </div>

    <div class="breaking" id="breaking">
      <div class="box">
        <div class="label"><span class="pulse"></span>BREAKING</div>
        <div class="msg" id="breakingMsg">New traffic event detected</div>
        <div class="submsg" id="breakingSub">Switching to nearest camera…</div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG (edit these only)
  // =========================
  const WORKER_BASE = "https://az-now-511-proxy.zachary-1-marshall.workers.dev";

  // Put YOUR HOUSE pin here (approx is fine)
  const HOME = { lat: 33.4484, lon: -112.0740 }; // <-- CHANGE ME

  const CAMERA_ROTATE_SECONDS = 20;
  const EVENTS_POLL_SECONDS = 45;
  const CAMS_REFRESH_SECONDS  = 10 * 60;

  // How many "near home" cameras to cycle
  const HOME_CAM_COUNT = 18;

  // When ACCIDENT mode triggers, keep cycling near that incident for X rotations
  const ACCIDENT_STICKY_ROTATIONS = 10;

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function setDatePill(){
    const d = new Date();
    const days = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    $("datePill").textContent = `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  }

  function updateClock(){
    const d = new Date();
    const h24 = d.getHours();
    const m = d.getMinutes();
    const ampm = h24 >= 12 ? "PM" : "AM";
    const h = ((h24 + 11) % 12) + 1;
    $("clock").textContent = `${h}:${pad2(m)} ${ampm}`;
  }

  function nowStamp(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // Haversine distance (miles)
  function distMiles(lat1, lon1, lat2, lon2){
    const toRad = (x) => x * Math.PI / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // =========================
  // Mode state
  // =========================
  const MODE = {
    HOME: "HOUSE",
    ACC: "ACCIDENT",
    RAND: "RANDOM"
  };
  let mode = MODE.HOME;

  function setMode(newMode){
    mode = newMode;

    $("btnHome").classList.toggle("active", mode === MODE.HOME);
    $("btnAcc").classList.toggle("active", mode === MODE.ACC);
    $("btnRand").classList.toggle("active", mode === MODE.RAND);

    $("snapMode").textContent = mode;
    $("snapModeHint").textContent =
      mode === MODE.HOME ? `nearest ${HOME_CAM_COUNT} cams` :
      mode === MODE.ACC  ? `auto-jump on new crash` :
      `pure chaos`;

    // reset rotation
    camCountdown = CAMERA_ROTATE_SECONDS;

    // rebuild the active playlist for this mode
    rebuildPlaylist();
    // show something immediately
    showNextFromPlaylist(true);
  }

  // =========================
  // State
  // =========================
  let cameras = [];
  let lastEvents = [];
  let lastEventIds = new Set();

  // playlist = the ordered list of camera indices we rotate through
  let playlist = [];
  let playlistPtr = 0;

  // accident sticky behavior
  let accidentSticky = {
    rotationsLeft: 0,
    centerLat: null,
    centerLon: null
  };

  let camCountdown = CAMERA_ROTATE_SECONDS;

  // =========================
  // Fetcher
  // =========================
  async function getJSON(path){
    const url = `${WORKER_BASE}/${path.replace(/^\/+/,"")}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  // =========================
  // Cameras
  // =========================
  async function loadCameras(){
    const data = await getJSON("cameras");

    const cleaned = [];
    for(const cam of data){
      const views = Array.isArray(cam.Views) ? cam.Views : [];
      const enabled = views.filter(v => (v.Status || "").toLowerCase() === "enabled" && v.Url);
      if(!enabled.length) continue;

      cleaned.push({
        id: cam.Id ?? cam.id,
        roadway: cam.Roadway || "",
        location: cam.Location || cam.Description || "",
        lat: Number(cam.Latitude),
        lon: Number(cam.Longitude),
        viewUrl: enabled[0].Url,
        viewDesc: enabled[0].Description || cam.Location || "Camera"
      });
    }

    cameras = cleaned;
    $("snapCams").textContent = cameras.length ? String(cameras.length) : "0";
    setTicker(`AZ NOW LIVE • ${cameras.length} CAMERAS ONLINE • ${nowStamp()} •`);

    rebuildPlaylist();
    if(cameras.length) showNextFromPlaylist(true);
  }

  function rebuildPlaylist(){
    if(!cameras.length){
      playlist = [];
      playlistPtr = 0;
      return;
    }

    if(mode === MODE.HOME){
      // nearest N cameras to HOME
      const ranked = cameras
        .map((c, i) => ({
          i,
          d: (Number.isFinite(c.lat) && Number.isFinite(c.lon))
            ? distMiles(33.295147, -112.117982, c.lat, c.lon)
            : 1e9
        }))
        .sort((a,b)=>a.d-b.d)
        .slice(0, Math.min(HOME_CAM_COUNT, cameras.length))
        .map(x=>x.i);

      playlist = ranked;
      playlistPtr = 0;
      $("explainTitle").textContent = "HOUSE MODE";
      $("explainBody").textContent =
        "Rotating through the nearest cameras to your home pin. Great for ‘what’s my area look like?’ vibes.";
      return;
    }

    if(mode === MODE.RAND){
      playlist = [...Array(cameras.length).keys()];
      shuffleInPlace(playlist);
      playlistPtr = 0;
      $("explainTitle").textContent = "RANDOM MODE";
      $("explainBody").textContent =
        "A never-ending tour of the city. Hit RANDOM again if you want a new shuffle.";
      return;
    }

    // ACCIDENT mode:
    // If we’re sticky to a crash area, rotate closest cams to that crash
    if(mode === MODE.ACC){
      if(accidentSticky.centerLat != null && accidentSticky.rotationsLeft > 0){
        const ranked = cameras
          .map((c, i) => ({
            i,
            d: (Number.isFinite(c.lat) && Number.isFinite(c.lon))
              ? distMiles(accidentSticky.centerLat, accidentSticky.centerLon, c.lat, c.lon)
              : 1e9
          }))
          .sort((a,b)=>a.d-b.d)
          .slice(0, Math.min(HOME_CAM_COUNT, cameras.length))
          .map(x=>x.i);

        playlist = ranked;
        playlistPtr = 0;
        $("explainTitle").textContent = "ACCIDENT MODE (LOCKED)";
        $("explainBody").textContent =
          "A new incident was detected. We’re cycling the closest cameras near it like a mini newsroom.";
        return;
      }

      // Otherwise: behave like a “wide city watch”
      playlist = [...Array(cameras.length).keys()];
      shuffleInPlace(playlist);
      playlistPtr = 0;
      $("explainTitle").textContent = "ACCIDENT MODE";
      $("explainBody").textContent =
        "When a new incident appears, we’ll jump to the nearest camera automatically.";
      return;
    }
  }

  function shuffleInPlace(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function showNextFromPlaylist(force=false){
    if(!playlist.length) return;

    // In RANDOM mode, if we run out, reshuffle
    if(mode === MODE.RAND && playlistPtr >= playlist.length){
      playlistPtr = 0;
      shuffleInPlace(playlist);
    }

    if(playlistPtr >= playlist.length) playlistPtr = 0;
    const camIndex = playlist[playlistPtr++];
    showCamera(camIndex);

    if(force) camCountdown = CAMERA_ROTATE_SECONDS;
  }

  function showCamera(index){
    if(!cameras.length) return;

    const cam = cameras[index];
    $("camIndex").textContent = `${index+1}/${cameras.length}`;

    // shorter + more readable label
    const label = (cam.viewDesc || cam.location || cam.roadway || `CAM ${cam.id}`).replace(/\s+/g," ").trim();
    $("camLabel").textContent = label.length > 64 ? label.slice(0,61) + "…" : label;

    // iframe embed
    const frame = $("camFrame");
    const fallback = $("camFallback");

    let loaded = false;
    frame.onload = () => { loaded = true; fallback.style.display = "none"; };
    frame.src = cam.viewUrl;

    // if blocked
    setTimeout(() => {
      if(!loaded){
        fallback.style.display = "grid";
      }
    }, 1200);
  }

  // =========================
  // Events
  // =========================
  function pickEventLatLon(e){
    const lat = Number(e.Latitude ?? e.Lat ?? e.Y ?? e.LocationLatitude);
    const lon = Number(e.Longitude ?? e.Lon ?? e.Long ?? e.X ?? e.LocationLongitude);
    if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
    return null;
  }

  async function loadEvents(){
    let data;
    try { data = await getJSON("event"); }
    catch { data = await getJSON("alerts"); }

    lastEvents = Array.isArray(data) ? data : (data?.Events || data?.events || []);
    $("updatedAt").textContent = nowStamp();

    // detect new events
    const ids = new Set();
    const newOnes = [];
    for(const ev of lastEvents){
      const id = (ev.Id ?? ev.EventId ?? ev.EventID ?? ev.IncidentId ?? ev.IncidentID ?? ev.Guid ?? ev.GUID ?? ev.SourceId ?? JSON.stringify(ev).slice(0,80));
      const sid = String(id);
      ids.add(sid);
      if(!lastEventIds.has(sid)) newOnes.push(ev);
    }

    // snapshot
    $("eventsCount").textContent = String(lastEvents.length);
    $("snapInc").textContent = String(lastEvents.length);

    // delta vs last poll
    const delta = (lastEventIds.size ? (lastEvents.length - lastEventIds.size) : 0);
    $("snapDelta").textContent = lastEventIds.size ? (delta === 0 ? "no change since last check" : (delta>0 ? `+${delta} since last check` : `${delta} since last check`)) : "warming up…";

    // render top incidents
    renderTopIncidents(lastEvents);

    // ticker
    setTicker(buildTicker(lastEvents));

    // breaking behavior
    if(lastEventIds.size && newOnes.length){
      const picked = newOnes[0];
      triggerBreaking(picked);

      // In ACCIDENT mode, lock to that incident area
      const p = pickEventLatLon(picked);
      if(p){
        accidentSticky.centerLat = p.lat;
        accidentSticky.centerLon = p.lon;
        accidentSticky.rotationsLeft = ACCIDENT_STICKY_ROTATIONS;

        if(mode === MODE.ACC){
          rebuildPlaylist();
          showNextFromPlaylist(true);
        }
      } else {
        // no coords — still show breaking but can’t geo-jump
        if(mode === MODE.ACC){
          showNextFromPlaylist(true);
        }
      }
    }

    lastEventIds = ids;
  }

  function simplifyType(ev){
    const t = String(ev.EventType || ev.Type || ev.EventCategory || "EVENT").toLowerCase();
    if(t.includes("crash") || t.includes("accident") || t.includes("collision")) return "CRASH";
    if(t.includes("closure") || t.includes("closed")) return "CLOSURE";
    if(t.includes("construction") || t.includes("roadwork") || t.includes("work")) return "ROADWORK";
    if(t.includes("weather") || t.includes("dust") || t.includes("fog") || t.includes("snow")) return "WEATHER";
    return "INCIDENT";
  }

  function simplifySeverity(ev){
    const s = Number(ev.Severity ?? ev.SeverityId ?? ev.SeverityID);
    if(!Number.isFinite(s)) return { label: "UPDATE", cls: "ok" };
    if(s >= 3) return { label: "MAJOR", cls: "danger" };
    if(s === 2) return { label: "MODERATE", cls: "" };
    return { label: "MINOR", cls: "ok" };
  }

  function oneLine(ev){
    const road = String(ev.RoadwayName || ev.Roadway || ev.Road || "").trim();
    const desc = String(ev.Description || ev.ShortDescription || ev.EventDescription || ev.Location || "").trim();
    const s = (road ? `${road} — ` : "") + (desc || "Traffic update");
    return s.replace(/\s+/g," ").trim();
  }

  function renderTopIncidents(events){
    const wrap = $("topIncidents");
    wrap.innerHTML = "";

    if(!events.length){
      wrap.innerHTML = `
        <div class="story">
          <div class="storyTop">
            <div class="badge ok"><span class="bDot"></span>CLEAR</div>
            <div style="font-family:var(--font-retro);font-size:20px;opacity:.85;">${nowStamp()}</div>
          </div>
          <div class="storyTitle">No active incidents reported</div>
          <div class="storySub">Either it’s calm… or the feed is quiet. Enjoy the peace.</div>
        </div>`;
      return;
    }

    const top = events.slice(0, 6);
    for(let i=0;i<top.length;i++){
      const ev = top[i];
      const type = simplifyType(ev);
      const sev = simplifySeverity(ev);
      const line = oneLine(ev);

      const title = `${type}: ${line}`;
      const sub = "Tap ACCIDENT mode to auto-jump when a new one appears.";

      const story = document.createElement("div");
      story.className = "story";
      story.innerHTML = `
        <div class="storyTop">
          <div class="badge ${sev.cls}"><span class="bDot"></span>${sev.label}</div>
          <div style="font-family:var(--font-retro);font-size:20px;opacity:.85;">#${i+1}</div>
        </div>
        <div class="storyTitle">${escapeHTML(title.slice(0, 120))}</div>
        <div class="storySub">${escapeHTML(sub)}</div>
      `;
      wrap.appendChild(story);
    }
  }

  function buildTicker(events){
    const base = `AZ NOW LIVE • ${events.length} ACTIVE INCIDENTS • MODE: ${mode} • NEXT CAM ${camCountdown}s • `;
    if(!events.length) return base + "NO MAJOR INCIDENTS • DRIVE SMART • STAY SAFE •";
    const blurbs = [];
    for(const e of events.slice(0,3)){
      const t = simplifyType(e);
      const l = oneLine(e);
      blurbs.push(`${t} — ${l}`.slice(0,120));
    }
    return base + blurbs.join(" • ") + " • STAY SAFE — DRIVE SMART •";
  }

  function setTicker(text){
    $("tickerText").textContent = text;
  }

  // =========================
  // Breaking overlay
  // =========================
  let breakingTimer = null;
  function triggerBreaking(eventObj){
    const type = simplifyType(eventObj);
    const msg = oneLine(eventObj);

    $("breakingMsg").textContent = `${type}`;
    $("breakingSub").textContent = msg.slice(0, 110);

    const el = $("breaking");
    el.style.display = "block";

    clearTimeout(breakingTimer);
    breakingTimer = setTimeout(() => {
      el.style.display = "none";
    }, 5200);
  }

  // =========================
  // Rotation loop
  // =========================
  function tick(){
    if(!cameras.length) return;

    camCountdown--;
    if(camCountdown <= 0){
      // decrement sticky counter if we’re locked near a crash
      if(mode === MODE.ACC && accidentSticky.rotationsLeft > 0){
        accidentSticky.rotationsLeft--;
        if(accidentSticky.rotationsLeft === 0){
          // unlock -> rebuild playlist
          rebuildPlaylist();
        }
      }

      showNextFromPlaylist(true);
      camCountdown = CAMERA_ROTATE_SECONDS;
    }

    $("camCountdown").textContent = String(camCountdown);
    $("snapNext").textContent = String(camCountdown);

    // Keep ticker base fresh-ish without restarting the animation
    // (We only update ticker on event polls for smooth scrolling)
  }

  // =========================
  // Boot
  // =========================
  async function boot(){
    setDatePill();
    updateClock();
    setInterval(updateClock, 1000);

    // buttons
    $("btnHome").addEventListener("click", () => setMode(MODE.HOME));
    $("btnAcc").addEventListener("click", () => setMode(MODE.ACC));
    $("btnRand").addEventListener("click", () => {
      // re-shuffle each time you hit it (fun)
      setMode(MODE.RAND);
      rebuildPlaylist();
      showNextFromPlaylist(true);
    });

    // default mode snapshot
    $("snapMode").textContent = mode;

    // initial loads
    try{ await loadCameras(); } catch(e){ console.error(e); setTicker(`CAMERA LOAD FAILED • CHECK WORKER /cameras • ${nowStamp()} •`); }
    try{ await loadEvents(); } catch(e){ console.error(e); setTicker(`EVENT LOAD FAILED • CHECK WORKER /event • ${nowStamp()} •`); }

    // refresh loops
    setInterval(() => loadCameras().catch(console.error), CAMS_REFRESH_SECONDS * 1000);
    setInterval(() => loadEvents().catch(console.error), EVENTS_POLL_SECONDS * 1000);
    setInterval(tick, 1000);

    // ensure UI buttons reflect default
    setMode(MODE.HOME);
  }

  boot();
</script>
</body>
</html>
