<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AZ NOW — Live Traffic + Cams</title>

  <!-- Fonts (optional; safe fallbacks if blocked) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ========= YOU TUNE THESE ========= */
      --camSize: 0.30;        /* panel cam zoom-out (0.25–0.60 typical) */
      --camSizeFull: 0.82;    /* fullscreen cam zoom (0.70–0.95 typical) */
      --tickerSeconds: 55;    /* TICKER SPEED (higher = slower) */
      --maxIncidents: 7;      /* how many incidents to list */

      /* Location presets (used by buttons) */
      --homeLat: 33.295147; --homeLon: -112.117982;
      --workLat: 33.440492; --workLon: -111.953428;
      --meganLat: 33.419155; --meganLon: -111.703516;
      --dtLat:   33.448231; --dtLon:   -112.074975;

      /* ========= THEME ========= */
      --bg0:#0d1230; --bg1:#171a3b;
      --ink:#f7f3ff; --muted:#d7d2ff;
      --line:#ffffff22;

      --peach:#ffb48a; --mint:#89f0d1; --sky:#86b7ff; --lav:#c3a1ff; --pink:#ff8fd1; --lemon:#ffe27a; --teal:#2bd9ff;
      --danger:#ff5b6e; --warn:#ffbf4a; --ok:#60ffb0;

      --radius:18px; --radius2:14px;
      --hdrH:60px; --tickerH:56px; --pad:14px;

      --font-ui:"IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-retro:"VT323", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;

      --shadow: 0 10px 30px #00000066;
    }

    *{ box-sizing:border-box; }
    html,body{ width:100%; height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 500px at 20% 30%, #7b6cff30, transparent 55%),
        radial-gradient(900px 420px at 75% 20%, #2bd9ff24, transparent 60%),
        radial-gradient(900px 500px at 60% 80%, #ff8fd124, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
      font-family:var(--font-ui);
    }

    /* Fullscreen shell */
    .bar{
      width:100vw; height:100vh;
      position:relative;
      overflow:hidden;
      background:
        linear-gradient(90deg, #ffffff14, #ffffff08 40%, #ffffff12),
        radial-gradient(700px 280px at 20% 30%, #ffb48a18, transparent 60%),
        radial-gradient(600px 260px at 75% 35%, #89f0d118, transparent 60%),
        radial-gradient(700px 300px at 50% 120%, #c3a1ff14, transparent 55%),
        linear-gradient(180deg, #13163a, #0f1232);
    }

    /* CRT scanlines */
    .bar::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.04),
        rgba(255,255,255,0.04) 1px,
        rgba(0,0,0,0.0) 2px,
        rgba(0,0,0,0.0) 4px
      );
      opacity:.38;
      pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 50;
    }

    /* Header */
    .header{
      height:var(--hdrH);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, #ffb48a66, #c3a1ff55 35%, #86b7ff55 60%, #89f0d155),
        linear-gradient(180deg, #ffffff12, #0000);
      position:relative;
      z-index: 10;
    }

    .brand{ display:flex; align-items:baseline; gap:12px; }
    .logo{
      font-family:var(--font-retro);
      font-size:42px;
      letter-spacing:2px;
      text-shadow:0 2px 0 #0007;
      line-height:1;
    }
    .sub{
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      opacity:.9;
    }

    .meta{
      display:flex; align-items:center; gap:14px;
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      background:#0003;
      border:1px solid #fff3;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px #fff2, 0 0 16px var(--ok);
    }

    /* Buttons row */
    .controls{
      height: 54px;
      padding: 10px 14px 0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      position:relative;
      z-index: 9;
    }
    .btn{
      font-family: var(--font-retro);
      font-size: 22px;
      letter-spacing: 1px;
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid #ffffff26;
      background: linear-gradient(180deg, #ffffff12, #00000020);
      color: var(--ink);
      cursor: pointer;
      user-select:none;
      box-shadow: inset 0 0 0 1px #00000025;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: #89f0d155;
      background: linear-gradient(180deg, #89f0d126, #00000020);
    }
    .btn.danger{
      border-color: #ff5b6e66;
      background: linear-gradient(180deg, #ff5b6e22, #00000020);
    }
    .modePill{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      font-family: var(--font-retro);
      font-size: 22px;
      letter-spacing: 1px;
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid #ffffff26;
      background:#0002;
      white-space:nowrap;
    }
    .modePill b{ color: var(--lemon); }

    /* Main layout */
    .main{
      height: calc(100% - var(--hdrH) - var(--tickerH) - 54px);
      padding: var(--pad);
      display:grid;
      grid-template-columns: 1.1fr 1.0fr 1.7fr; /* incidents | summary | camera */
      gap:12px;
      position:relative;
      z-index: 2;
      min-height: 0;
    }

    .panel{
      background: linear-gradient(180deg, #ffffff14, #ffffff08);
      border: 1px solid #ffffff20;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px #0003;
      position:relative;
      min-height: 0;
    }
    .panelTitle{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      border-bottom:1px solid #ffffff22;
      background:
        linear-gradient(90deg, #86b7ff30, #c3a1ff24, #ff8fd120),
        linear-gradient(180deg, #ffffff14, #0000);
    }
    .panelTitle h3{
      margin:0;
      font-family:var(--font-retro);
      font-size:26px;
      letter-spacing:1px;
    }
    .panelTitle small{
      font-family:var(--font-retro);
      font-size:18px;
      opacity:.85;
      letter-spacing:.5px;
      white-space:nowrap;
    }

    /* Incidents list */
    .incidents{
      padding:10px 12px 12px;
      height: calc(100% - 52px);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .incident{
      display:grid;
      grid-template-columns: 34px 1fr auto;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: var(--radius2);
      background:#0002;
      border:1px solid #ffffff1e;
    }
    .ic{
      width:34px; height:34px;
      border-radius:12px;
      display:grid;
      place-items:center;
      font-family:var(--font-retro);
      font-size:22px;
      color:#0b0f2a;
      box-shadow: inset 0 0 0 1px #0002;
    }
    .itop{ font-weight:900; font-size:14px; line-height:1.1; }
    .isub{ opacity:.85; font-size:12px; margin-top:2px; }
    .itag{
      font-family:var(--font-retro);
      font-size:18px;
      padding: 6px 8px;
      border-radius:12px;
      border:1px solid #ffffff26;
      background:#0002;
      letter-spacing:1px;
      white-space:nowrap;
    }
    .sev-high .ic{ background: var(--danger); }
    .sev-med  .ic{ background: var(--warn); }
    .sev-low  .ic{ background: var(--mint); }

    /* Summary panel */
    .summary{
      padding:10px 12px 12px;
      height: calc(100% - 52px);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }
    .bigNums{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .card{
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background:#0002;
      padding: 10px 10px;
      min-height: 70px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card .k{
      font-family: var(--font-retro);
      font-size: 18px;
      letter-spacing: 1px;
      opacity: .9;
    }
    .card .v{
      font-family: var(--font-retro);
      font-size: 30px;
      letter-spacing: 1px;
      color: var(--lemon);
      text-shadow: 0 2px 0 #0007;
      line-height: 1;
    }
    .card .s{
      font-size: 12px;
      opacity: .85;
      color: var(--muted);
      margin-top: 2px;
    }
    .focusBox{
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background:#0002;
      padding: 12px 12px;
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }
    .focusBox .headline{
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
      color: var(--mint);
      text-shadow: 0 2px 0 #0007;
    }
    .focusBox .plain{
      font-size: 13px;
      line-height: 1.35;
      opacity: .95;
      overflow:auto;
      padding-right: 4px;
    }
    .focusBox .plain b{ color: var(--lemon); }

    /* Camera panel */
    .camWrap{
      padding:10px 12px 12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto 1fr;
      gap:10px;
      min-height: 0;
    }
    .camMeta{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .camMeta .left{
      display:flex; align-items:center; gap:10px;
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:12px;
      padding:6px 10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .livePip{ display:inline-flex; align-items:center; gap:6px; }
    .livePip .dot{
      width:8px; height:8px;
      background:var(--danger);
      box-shadow:0 0 14px #ff5b6ecc;
    }
    .camMeta .right{
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:12px;
      padding:6px 10px;
      white-space:nowrap;
    }

    .camBox{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      overflow:hidden;
      background:#0002;
      position:relative;
      min-height: 0;
    }

    /* IMPORTANT: center the video ALWAYS (panel mode) */
    .camInner,
    .camInnerFull{
      position:absolute;
      inset:0;
      left:50%;
      top:50%;
      translate:-50% -50%;
      transform-origin:center center;
    }

    /* Panel mode zoom (uses --camSize) */
    .camInner{
      transform: translate(-50%, -50%) scale(var(--camSize));
      width: calc(100% / var(--camSize));
      height: calc(100% / var(--camSize));
    }

    /* Fullscreen mode zoom (uses --camSizeFull) */
    .camInnerFull{
      transform: translate(-50%, -50%) scale(var(--camSizeFull));
      width: calc(100% / var(--camSizeFull));
      height: calc(100% / var(--camSizeFull));
    }

    .camFrame, .camFallback{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
    }
    .camFallback{
      display:none;
      place-items:center;
      padding:16px;
      text-align:center;
      color: var(--muted);
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
      background:
        radial-gradient(900px 260px at 60% 70%, #ffb48a22, transparent 55%),
        radial-gradient(700px 240px at 30% 50%, #86b7ff1f, transparent 60%),
        linear-gradient(180deg, #0b0f2b, #070a1d);
    }
    .camFallback small{
      display:block;
      font-size:18px;
      opacity:.85;
      margin-top:10px;
      font-family: var(--font-ui);
      letter-spacing:0;
    }

    /* Fullscreen camera stage (behind overlays) */
    .fullStage{
      position:absolute;
      inset: calc(var(--hdrH) + 54px) 0 var(--tickerH) 0; /* below header+buttons, above ticker */
      z-index: 1;
      background:#000;
      display:none; /* turned on in fullscreen mode */
    }

    /* Overlay UI (in fullscreen mode) */
    .overlay{
      position:absolute;
      inset: calc(var(--hdrH) + 54px) 0 var(--tickerH) 0;
      z-index: 6;
      display:none;
      pointer-events:none;
      padding: var(--pad);
      gap: 12px;
    }
    .overlay.on{ display:grid; grid-template-columns: 520px 1fr; }
    .overlay .stack{ display:flex; flex-direction:column; gap:12px; min-width:0; }
    .overlay .panel{
      pointer-events:auto;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, #0a0d2499, #00000033);
      border: 1px solid #ffffff26;
      box-shadow: 0 20px 50px #0007;
    }

    /* Hide normal main when fullscreen */
    .main.hidden{ display:none; }

    /* Ticker */
    .ticker{
      height:var(--tickerH);
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      background:
        linear-gradient(90deg, #86b7ff2a, #ff8fd124 45%, #89f0d124),
        linear-gradient(180deg, #0000, #0002);
      position:relative;
      z-index: 10;
    }
    .tickerBrand{
      font-family:var(--font-retro);
      font-size:34px;
      letter-spacing:2px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
    }
    .tickerLine{
      overflow:hidden;
      white-space:nowrap;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      height:100%;
      display:flex;
      align-items:center;
      position:relative;
    }
    .tickerLine span{
      display:inline-block;
      padding-left: 100%;
      font-family:var(--font-retro);
      font-size:24px;
      letter-spacing:1px;
      animation: scroll var(--tickerSeconds) linear infinite;
      text-shadow:0 2px 0 #0007;
    }
    @keyframes scroll{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }
    .clockBox{
      font-family:var(--font-retro);
      font-size:34px;
      letter-spacing:2px;
      padding:6px 12px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      color:var(--lemon);
      white-space:nowrap;
    }

    /* Simple “new accident” toast */
    .toast{
      position:absolute;
      right: 16px;
      bottom: calc(var(--tickerH) + 14px);
      z-index: 40;
      display:none;
      border-radius: 16px;
      border: 1px solid #ffffff26;
      background: linear-gradient(90deg, #ff5b6e88, #ffbf4a55 40%, #86b7ff55);
      box-shadow: 0 20px 50px #0008;
      padding: 12px 14px;
      color:#0b0f2a;
      max-width: 520px;
    }
    .toast .t1{
      font-family: var(--font-retro);
      font-size: 28px;
      letter-spacing: 2px;
      display:flex;
      align-items:center;
      gap:10px;
      line-height: 1;
    }
    .toast .t2{
      margin-top: 6px;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.25;
    }
    .pulseDot{
      width: 12px; height: 12px; border-radius: 50%;
      background:#0b0f2a;
      animation: pulse 0.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity: 0.9; }
      50%{ transform: scale(1.45); opacity: 1; }
      100%{ transform: scale(1); opacity: 0.9; }
    }
  </style>
</head>

<body>
  <div class="bar" role="img" aria-label="AZ NOW live traffic and cams dashboard">
    <div class="header">
      <div class="brand">
        <div class="logo">AZ NOW</div>
        <div class="sub">LIVE TRAFFIC + CAMS</div>
      </div>

      <div class="meta">
        <div class="pill"><span class="dot"></span><span>LIVE</span></div>
        <div class="pill" id="datePill">—</div>
        <div class="pill" id="fsPill" style="display:none;">FULLSCREEN</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn danger" id="btnAccident">Accident view</button>
      <button class="btn" id="btnRandom">Random</button>
      <button class="btn primary" id="btnHome">Home</button>
      <button class="btn" id="btnWork">Work</button>
      <button class="btn" id="btnMegan">Megan</button>
      <button class="btn" id="btnDowntown">Downtown</button>
      <button class="btn" id="btnFullscreen" title="Toggle fullscreen camera">Fullscreen</button>

      <div class="modePill" title="Current camera selection mode">
        MODE: <b id="modeLabel">RANDOM</b>
      </div>
    </div>

    <!-- Fullscreen camera stage -->
    <div class="fullStage" id="fullStage">
      <div class="camInnerFull" id="camInnerFull">
        <iframe class="camFrame" id="camFrameFull" title="AZ511 camera view (fullscreen)"
          sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
      </div>
    </div>

    <!-- Overlay UI (only used in fullscreen) -->
    <div class="overlay" id="overlay">
      <div class="stack">
        <section class="panel">
          <div class="panelTitle">
            <h3>TOP INCIDENTS</h3>
            <small>UPDATED: <span id="incUpdated2">—</span></small>
          </div>
          <div class="incidents" id="incidentsList2"></div>
        </section>

        <section class="panel">
          <div class="panelTitle">
            <h3>CITY SNAPSHOT</h3>
            <small>STATUS: <span id="statusLabel2">—</span></small>
          </div>
          <div class="summary">
            <div class="bigNums">
              <div class="card">
                <div class="k">ACTIVE EVENTS</div>
                <div class="v" id="statEvents2">—</div>
                <div class="s">Things impacting traffic right now</div>
              </div>
              <div class="card">
                <div class="k">CAMERAS LIVE</div>
                <div class="v" id="statCams2">—</div>
                <div class="s">Available camera feeds</div>
              </div>
            </div>
            <div class="focusBox">
              <div class="headline" id="focusTitle2">What you’re looking at</div>
              <div class="plain" id="focusBody2">—</div>
            </div>
          </div>
        </section>
      </div>

      <div class="stack" style="align-items:flex-end;">
        <section class="panel" style="width:min(520px, 100%);">
          <div class="panelTitle">
            <h3>LIVE CAMERA</h3>
            <small>FEED: <span id="camIndex2">—</span></small>
          </div>
          <div style="padding:10px 12px 12px; display:grid; gap:10px;">
            <div class="camMeta">
              <div class="left">
                <span class="livePip"><span class="dot"></span>LIVE</span>
                <span id="camLabel2">—</span>
              </div>
              <div class="right">NEXT: <span id="camCountdown2">—</span>s</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="main" id="main">
      <!-- Incidents -->
      <section class="panel">
        <div class="panelTitle">
          <h3>TOP INCIDENTS</h3>
          <small>UPDATED: <span id="incUpdated">—</span></small>
        </div>
        <div class="incidents" id="incidentsList">
          <div class="incident sev-low">
            <div class="ic">…</div>
            <div>
              <div class="itop">Loading</div>
              <div class="isub">Waiting for AZ511 events…</div>
            </div>
            <div class="itag">LIVE</div>
          </div>
        </div>
      </section>

      <!-- Summary -->
      <section class="panel">
        <div class="panelTitle">
          <h3>CITY SNAPSHOT</h3>
          <small>STATUS: <span id="statusLabel">—</span></small>
        </div>

        <div class="summary">
          <div class="bigNums">
            <div class="card">
              <div class="k">ACTIVE EVENTS</div>
              <div class="v" id="statEvents">—</div>
              <div class="s">Things impacting traffic right now</div>
            </div>
            <div class="card">
              <div class="k">CAMERAS LIVE</div>
              <div class="v" id="statCams">—</div>
              <div class="s">Available camera feeds</div>
            </div>
          </div>

          <div class="focusBox">
            <div class="headline" id="focusTitle">What you’re looking at</div>
            <div class="plain" id="focusBody">
              Loading…<br><br>
              Tip: Use <b>Accident view</b> to jump to cams near crashes, or <b>Home</b> to surf cameras around your house.
            </div>
          </div>
        </div>
      </section>

      <!-- Camera -->
      <section class="panel">
        <div class="panelTitle">
          <h3>LIVE CAMERA</h3>
          <small>FEED: <span id="camIndex">—</span></small>
        </div>

        <div class="camWrap">
          <div class="camMeta">
            <div class="left" title="Camera location">
              <span class="livePip"><span class="dot"></span>LIVE</span>
              <span id="camLabel">Loading cameras…</span>
            </div>
            <div class="right">NEXT: <span id="camCountdown">—</span>s</div>
          </div>

          <div class="camBox">
            <div class="camInner" id="camInner">
              <iframe class="camFrame" id="camFrame" title="AZ511 camera view"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            </div>
            <div class="camFallback" id="camFallback">
              CAMERA EMBED BLOCKED
              <small>If AZ511 disallows iframe embedding, we can switch to still images (if available) or proxy a snapshot endpoint.</small>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="ticker">
      <div class="tickerBrand">AZ NOW</div>
      <div class="tickerLine"><span id="tickerText">CONNECTING TO AZ511…</span></div>
      <div class="clockBox" id="clock">—:— —</div>
    </div>

    <div class="toast" id="toast">
      <div class="t1"><span class="pulseDot"></span>NEW ACCIDENT</div>
      <div class="t2" id="toastMsg">—</div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG (edit these only)
  // =========================
  const WORKER_BASE = "https://az-now-511-proxy.zachary-1-marshall.workers.dev";

  const CAMERA_ROTATE_SECONDS = 20;
  const EVENTS_POLL_SECONDS = 45;        // refresh incidents
  const CAMS_REFRESH_SECONDS = 10 * 60;  // refresh camera list

  // Button coords (same as you requested)
  const LOCATIONS = {
    HOME:     { name: "HOME",     lat: 33.295147, lon: -112.117982 },
    WORK:     { name: "WORK",     lat: 33.440492, lon: -111.953428 },
    MEGAN:    { name: "MEGAN",    lat: 33.419155, lon: -111.703516 },
    DOWNTOWN: { name: "DOWNTOWN", lat: 33.448231, lon: -112.074975 }
  };

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function setDatePill(){
    const d = new Date();
    const days = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    $("datePill").textContent = `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  }

  function updateClock(){
    const d = new Date();
    const h24 = d.getHours();
    const m = d.getMinutes();
    const ampm = h24 >= 12 ? "PM" : "AM";
    const h = ((h24 + 11) % 12) + 1;
    $("clock").textContent = `${h}:${pad2(m)} ${ampm}`;
  }

  function nowStamp(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // Haversine distance (miles)
  function distMiles(lat1, lon1, lat2, lon2){
    const toRad = (x) => x * Math.PI / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function pickLatLon(obj){
    const lat = Number(obj?.Latitude ?? obj?.Lat ?? obj?.Y ?? obj?.LocationLatitude);
    const lon = Number(obj?.Longitude ?? obj?.Lon ?? obj?.Long ?? obj?.X ?? obj?.LocationLongitude);
    if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
    return null;
  }

  function looksLikeAccident(ev){
    const t = (ev?.EventType || ev?.Type || ev?.EventCategory || "").toString().toLowerCase();
    const d = (ev?.Description || ev?.ShortDescription || ev?.EventDescription || "").toString().toLowerCase();
    return t.includes("accident") || t.includes("crash") || d.includes("accident") || d.includes("crash") || d.includes("collision");
  }

  function summarizeForHumans(ev){
    const type = (ev?.EventType || ev?.Type || "Traffic issue").toString();
    const road = (ev?.RoadwayName || ev?.Roadway || ev?.Road || "").toString();
    const desc = (ev?.Description || ev?.ShortDescription || ev?.EventDescription || "").toString();
    const loc  = (ev?.Location || ev?.LocationDescription || "").toString();

    const main = [type, road].filter(Boolean).join(" • ").trim() || "Traffic issue";
    const detail = (desc || loc || "Details unavailable").replace(/\s+/g," ").trim();

    return { main: main.slice(0, 40), detail: detail.slice(0, 80) };
  }

  async function getJSON(path){
    const url = `${WORKER_BASE}/${path.replace(/^\/+/,"")}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  // =========================
  // State
  // =========================
  let cameras = [];
  let camIdx = 0;
  let camCountdown = CAMERA_ROTATE_SECONDS;

  let lastEventIds = new Set();
  let lastEvents = [];

  // Modes
  let mode = { type: "RANDOM", target: null };

  // Fullscreen state
  let fullscreen = false;

  // =========================
  // UI setters
  // =========================
  function setModeLabel(){
    if(mode.type === "ACCIDENT") $("modeLabel").textContent = "ACCIDENT";
    else if(mode.type === "RANDOM") $("modeLabel").textContent = "RANDOM";
    else if(mode.type === "NEAR") $("modeLabel").textContent = mode.target?.name || "NEAR";
  }

  function setTicker(text){ $("tickerText").textContent = text; }

  function setStatus(){
    const n = lastEvents.length;
    let label = "CALM";
    if(n >= 80) label = "BUSY";
    else if(n >= 30) label = "ACTIVE";
    else if(n >= 10) label = "NORMAL";
    $("statusLabel").textContent = label;

    $("focusTitle").textContent =
      (mode.type === "ACCIDENT") ? "Accident mode" :
      (mode.type === "NEAR") ? `Near ${mode.target?.name || "target"}` :
      "Random mode";

    if(mode.type === "ACCIDENT"){
      $("focusBody").innerHTML =
        `We’ll prioritize cameras near new <b>accidents</b>.<br>
         When something new pops up, you’ll see an alert and we’ll try to jump to a nearby cam.`;
    } else if(mode.type === "NEAR"){
      $("focusBody").innerHTML =
        `Showing cameras within ~<b>10 miles</b> of <b>${escapeHTML(mode.target?.name || "your spot")}</b>.<br>
         Use Random anytime for a city-wide scan.`;
    } else {
      $("focusBody").innerHTML =
        `A city-wide shuffle of cameras.<br>
         Want something specific? Tap <b>Home</b> or <b>Downtown</b>.`;
    }

    // Mirror to fullscreen overlay (if present)
    if($("statusLabel2")){
      $("statusLabel2").textContent = label;
      $("focusTitle2").textContent = $("focusTitle").textContent;
      $("focusBody2").innerHTML = $("focusBody").innerHTML;
      $("statEvents2").textContent = $("statEvents").textContent;
      $("statCams2").textContent = $("statCams").textContent;
    }
  }

  function showToast(msg){
    $("toastMsg").textContent = msg;
    const el = $("toast");
    el.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => el.style.display = "none", 5200);
  }

  function applyFullscreen(on){
    fullscreen = !!on;
    $("main").classList.toggle("hidden", fullscreen);
    $("fullStage").style.display = fullscreen ? "block" : "none";
    $("overlay").classList.toggle("on", fullscreen);
    $("fsPill").style.display = fullscreen ? "inline-flex" : "none";

    // Keep the fullscreen iframe on the same feed
    syncFullscreenFrame();
    mirrorOverlayText();
  }

  function mirrorOverlayText(){
    if(!fullscreen) return;
    $("incUpdated2").textContent = $("incUpdated").textContent;
    $("statEvents2").textContent = $("statEvents").textContent;
    $("statCams2").textContent = $("statCams").textContent;
    $("statusLabel2").textContent = $("statusLabel").textContent;
    $("camIndex2").textContent = $("camIndex").textContent;
    $("camLabel2").textContent = $("camLabel").textContent;
    $("camCountdown2").textContent = $("camCountdown").textContent;

    // incidents mirror
    $("incidentsList2").innerHTML = $("incidentsList").innerHTML;
  }

  // =========================
  // Data loading
  // =========================
  async function loadCameras(){
    const data = await getJSON("cameras");

    const cleaned = [];
    for(const cam of data){
      const views = Array.isArray(cam.Views) ? cam.Views : [];
      const enabled = views.filter(v => (v.Status || "").toLowerCase() === "enabled" && v.Url);
      if(!enabled.length) continue;

      cleaned.push({
        id: cam.Id ?? cam.id,
        roadway: cam.Roadway || "",
        location: cam.Location || cam.Description || "",
        lat: Number(cam.Latitude),
        lon: Number(cam.Longitude),
        viewUrl: enabled[0].Url,
        viewDesc: enabled[0].Description || cam.Location || "Camera"
      });
    }

    cameras = cleaned;
    $("statCams").textContent = cameras.length ? String(cameras.length) : "0";
    if($("statCams2")) $("statCams2").textContent = $("statCams").textContent;

    if(camIdx >= cameras.length) camIdx = 0;

    if(cameras.length){
      showCamera(camIdx);
      setTicker(`CAMERAS LIVE • ${cameras.length} FEEDS • ${nowStamp()} •`);
    } else {
      setTicker(`NO CAMERAS FOUND • CHECK WORKER /cameras • ${nowStamp()} •`);
    }
  }

  async function loadEvents(){
    let data;
    try { data = await getJSON("event"); }
    catch { data = await getJSON("alerts"); }

    lastEvents = Array.isArray(data) ? data : (data?.Events || data?.events || []);
    $("incUpdated").textContent = nowStamp();
    $("statEvents").textContent = String(lastEvents.length);
    if($("incUpdated2")) $("incUpdated2").textContent = $("incUpdated").textContent;
    if($("statEvents2")) $("statEvents2").textContent = $("statEvents").textContent;

    // New event detection
    const ids = new Set();
    const newOnes = [];
    for(const ev of lastEvents){
      const id = (ev.Id ?? ev.EventId ?? ev.EventID ?? ev.IncidentId ?? ev.IncidentID ?? ev.Guid ?? ev.GUID ?? ev.SourceId ?? JSON.stringify(ev).slice(0,80));
      const sid = String(id);
      ids.add(sid);
      if(!lastEventIds.has(sid)) newOnes.push(ev);
    }

    const newAcc = newOnes.find(looksLikeAccident);
    if(lastEventIds.size && newAcc){
      const s = summarizeForHumans(newAcc);
      showToast(`${s.main} — ${s.detail}`);
      if(mode.type === "ACCIDENT"){
        jumpToNearestCamera(newAcc);
      }
    }
    lastEventIds = ids;

    renderIncidents(lastEvents);
    setStatus();
    setTicker(buildTicker(lastEvents));
    mirrorOverlayText();
  }

  function buildTicker(events){
    const base = `AZ NOW LIVE • ${events.length} ACTIVE EVENTS • MODE ${$("modeLabel").textContent} • ${nowStamp()} • `;
    if(!events.length) return base + "NO MAJOR ISSUES REPORTED • DRIVE SMART!";
    const blurbs = [];
    for(const ev of events.slice(0,3)){
      const s = summarizeForHumans(ev);
      blurbs.push(`${s.main} — ${s.detail}`);
    }
    return base + blurbs.join(" • ") + " • STAY SAFE — DRIVE SMART!";
  }

  function renderIncidents(events){
    const list = $("incidentsList");
    list.innerHTML = "";

    const maxInc = Number(getComputedStyle(document.documentElement).getPropertyValue("--maxIncidents")) || 7;
    const show = events.slice(0, maxInc);

    if(!show.length){
      list.innerHTML = `
        <div class="incident sev-low">
          <div class="ic">✓</div>
          <div>
            <div class="itop">All clear</div>
            <div class="isub">No active events reported.</div>
          </div>
          <div class="itag">OK</div>
        </div>`;
      return;
    }

    for(const ev of show){
      const s = summarizeForHumans(ev);
      const sevN = Number(ev?.Severity || ev?.SeverityId || 1);
      const cls = sevN >= 3 ? "sev-high" : (sevN === 2 ? "sev-med" : "sev-low");

      let icon = "•";
      if(looksLikeAccident(ev)) icon = "!";
      else if((ev?.EventType || "").toString().toLowerCase().includes("construction")) icon = "⛏";
      else if((ev?.EventType || "").toString().toLowerCase().includes("weather")) icon = "☁";

      const tag = looksLikeAccident(ev) ? "ACC" : (sevN ? `SEV ${sevN}` : "LIVE");

      const el = document.createElement("div");
      el.className = `incident ${cls}`;
      el.innerHTML = `
        <div class="ic">${escapeHTML(icon)}</div>
        <div>
          <div class="itop">${escapeHTML(s.main)}</div>
          <div class="isub">${escapeHTML(s.detail)}</div>
        </div>
        <div class="itag">${escapeHTML(tag)}</div>
      `;
      el.addEventListener("click", () => jumpToNearestCamera(ev));
      list.appendChild(el);
    }
  }

  // =========================
  // Camera logic
  // =========================
  function syncFullscreenFrame(){
    if(!fullscreen) return;
    const src = $("camFrame").src || "";
    if(src && $("camFrameFull").src !== src){
      $("camFrameFull").src = src;
    }
  }

  function showCamera(index){
    if(!cameras.length) return;

    camIdx = (index + cameras.length) % cameras.length;
    const cam = cameras[camIdx];

    $("camIndex").textContent = `${camIdx+1}/${cameras.length}`;
    $("camLabel").textContent = (cam.viewDesc || cam.location || cam.roadway || `CAM ${cam.id}`).slice(0,60);

    const frame = $("camFrame");
    const fallback = $("camFallback");

    let loaded = false;
    frame.onload = () => { loaded = true; fallback.style.display = "none"; };
    frame.src = cam.viewUrl;

    // mirror to fullscreen frame
    if(fullscreen){
      $("camFrameFull").src = cam.viewUrl;
    }

    setTimeout(() => {
      if(!loaded){
        fallback.style.display = "grid";
      }
    }, 1400);

    mirrorOverlayText();
  }

  function pickRandomCameraIndex(){
    return Math.floor(Math.random() * cameras.length);
  }

  function getCamerasNear(lat, lon, miles=10){
    if(!cameras.length) return [];
    const picks = [];
    for(let i=0;i<cameras.length;i++){
      const c = cameras[i];
      if(!Number.isFinite(c.lat) || !Number.isFinite(c.lon)) continue;
      const d = distMiles(lat, lon, c.lat, c.lon);
      if(d <= miles) picks.push({ i, d });
    }
    picks.sort((a,b) => a.d - b.d);
    return picks;
  }

  function nextCamera(){
    if(!cameras.length) return;

    if(mode.type === "RANDOM"){
      showCamera(pickRandomCameraIndex());
    } else if(mode.type === "NEAR" && mode.target){
      const near = getCamerasNear(mode.target.lat, mode.target.lon, 10);
      if(near.length){
        const currentPos = near.findIndex(x => x.i === camIdx);
        const nextPos = (currentPos >= 0 ? currentPos + 1 : 0) % near.length;
        showCamera(near[nextPos].i);
      } else {
        showCamera(pickRandomCameraIndex());
      }
    } else if(mode.type === "ACCIDENT"){
      showCamera(pickRandomCameraIndex());
    }

    camCountdown = CAMERA_ROTATE_SECONDS;
  }

  function jumpToNearestCamera(eventObj){
    if(!cameras.length) return;

    const p = pickLatLon(eventObj);
    if(!p){
      showCamera(pickRandomCameraIndex());
      camCountdown = CAMERA_ROTATE_SECONDS;
      return;
    }

    let bestI = 0;
    let bestD = Infinity;
    for(let i=0;i<cameras.length;i++){
      const c = cameras[i];
      if(!Number.isFinite(c.lat) || !Number.isFinite(c.lon)) continue;
      const d = distMiles(p.lat, p.lon, c.lat, c.lon);
      if(d < bestD){
        bestD = d;
        bestI = i;
      }
    }

    showCamera(bestI);
    camCountdown = CAMERA_ROTATE_SECONDS;

    $("focusTitle").textContent = "Jumped to nearby camera";
    $("focusBody").innerHTML =
      `Found the closest camera to the selected event (~<b>${bestD.toFixed(1)} miles</b>).<br>
       Tap <b>Random</b> to go back to city shuffle, or <b>Home</b> to stay near your place.`;

    setStatus();
  }

  function jumpToNewestAccident(){
    const newest = lastEvents.find(looksLikeAccident);
    if(newest) jumpToNearestCamera(newest);
    else showCamera(pickRandomCameraIndex());
  }

  // =========================
  // Button wiring
  // =========================
  function setModeAccident(){
    mode = { type: "ACCIDENT", target: null };
    setModeLabel();
    setStatus();
    jumpToNewestAccident();
    setTicker(`ACCIDENT VIEW • Watching for new crashes • ${nowStamp()} •`);
  }

  function setModeRandom(){
    mode = { type: "RANDOM", target: null };
    setModeLabel();
    setStatus();
    showCamera(pickRandomCameraIndex());
    setTicker(`RANDOM VIEW • City camera shuffle • ${nowStamp()} •`);
  }

  function setModeNear(loc){
    mode = { type: "NEAR", target: loc };
    setModeLabel();
    setStatus();
    const near = getCamerasNear(loc.lat, loc.lon, 10);
    if(near.length) showCamera(near[0].i);
    else showCamera(pickRandomCameraIndex());
    setTicker(`NEAR ${loc.name} • Cameras within ~10 miles • ${nowStamp()} •`);
  }

  // =========================
  // Boot
  // =========================
  async function boot(){
    setDatePill();
    updateClock();
    setInterval(updateClock, 1000);

    $("btnAccident").addEventListener("click", setModeAccident);
    $("btnRandom").addEventListener("click", setModeRandom);
    $("btnHome").addEventListener("click", () => setModeNear(LOCATIONS.HOME));
    $("btnWork").addEventListener("click", () => setModeNear(LOCATIONS.WORK));
    $("btnMegan").addEventListener("click", () => setModeNear(LOCATIONS.MEGAN));
    $("btnDowntown").addEventListener("click", () => setModeNear(LOCATIONS.DOWNTOWN));
    $("btnFullscreen").addEventListener("click", () => applyFullscreen(!fullscreen));

    try{ await loadCameras(); }
    catch(e){
      $("statCams").textContent = "0";
      setTicker(`CAMERA LOAD FAILED • CHECK WORKER /cameras • ${nowStamp()} •`);
      console.error(e);
    }

    try{ await loadEvents(); }
    catch(e){
      setTicker(`EVENT LOAD FAILED • CHECK WORKER /event • ${nowStamp()} •`);
      console.error(e);
    }

    setModeRandom();

    setInterval(() => loadCameras().catch(console.error), CAMS_REFRESH_SECONDS * 1000);
    setInterval(() => loadEvents().catch(console.error), EVENTS_POLL_SECONDS * 1000);

    setInterval(() => {
      if(!cameras.length) return;
      camCountdown--;
      if(camCountdown <= 0) nextCamera();
      $("camCountdown").textContent = String(camCountdown);

      // mirror countdown + labels in fullscreen overlay
      if($("camCountdown2")) $("camCountdown2").textContent = $("camCountdown").textContent;
      if($("camLabel2")) $("camLabel2").textContent = $("camLabel").textContent;
      if($("camIndex2")) $("camIndex2").textContent = $("camIndex").textContent;
    }, 1000);
  }

  boot();
</script>
</body>
</html>
