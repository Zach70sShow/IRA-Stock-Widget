<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AZ NOW — Live Traffic + Cams</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ========= TUNE THESE ========= */
      --sideW: 360px;          /* side info panel width */
      --contentZoom: 1.75;     /* camera fill amount (1.2–2.4 typical) */
      --iframeOffsetX: 0px;    /* nudge camera LEFT(-)/RIGHT(+) */
      --iframeOffsetY: 0px;    /* nudge camera UP(-)/DOWN(+) */
      --hideScrollbarPx: 22px; /* shove iframe left to clip inner scrollbar */
      --maxScale: 2.40;        /* safety cap for total scale */
      --maxIncidents: 5;
      --tickerSeconds: 55;

      /* How we “pretend” the embedded cam page is sized.
         If it still looks tiny, try bumping H up to 900 or 1080. */
      --embedW: 1280;
      --embedH: 720;

      /* ========= THEME ========= */
      --bg0:#0d1230; --bg1:#171a3b;
      --ink:#f7f3ff; --muted:#d7d2ff;
      --line:#ffffff22;

      --mint:#89f0d1; --sky:#86b7ff; --lav:#c3a1ff; --pink:#ff8fd1; --lemon:#ffe27a;
      --danger:#ff5b6e; --warn:#ffbf4a; --ok:#60ffb0;

      --radius:18px; --radius2:14px;
      --hdrH:56px; --controlsH:54px; --tickerH:52px; --pad:12px;

      --font-ui:"IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-retro:"VT323", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ width:100%; height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 500px at 20% 30%, #7b6cff30, transparent 55%),
        radial-gradient(900px 420px at 75% 20%, #2bd9ff24, transparent 60%),
        radial-gradient(900px 500px at 60% 80%, #ff8fd124, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
      font-family:var(--font-ui);
    }

    .bar{
      width:100vw; height:100vh;
      position:relative;
      overflow:hidden;
      background:
        linear-gradient(90deg, #ffffff14, #ffffff08 40%, #ffffff12),
        radial-gradient(700px 280px at 20% 30%, #ffb48a18, transparent 60%),
        radial-gradient(600px 260px at 75% 35%, #89f0d118, transparent 60%),
        radial-gradient(700px 300px at 50% 120%, #c3a1ff14, transparent 55%),
        linear-gradient(180deg, #13163a, #0f1232);
    }
    .bar::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.04),
        rgba(255,255,255,0.04) 1px,
        rgba(0,0,0,0.0) 2px,
        rgba(0,0,0,0.0) 4px
      );
      opacity:.30;
      pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 50;
    }

    .header{
      height:var(--hdrH);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, #ffb48a66, #c3a1ff55 35%, #86b7ff55 60%, #89f0d155),
        linear-gradient(180deg, #ffffff12, #0000);
      position:relative;
      z-index: 10;
    }
    .brand{ display:flex; align-items:baseline; gap:12px; }
    .logo{
      font-family:var(--font-retro);
      font-size:40px;
      letter-spacing:2px;
      text-shadow:0 2px 0 #0007;
      line-height:1;
    }
    .sub{
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      opacity:.9;
    }
    .meta{
      display:flex; align-items:center; gap:12px;
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      background:#0003;
      border:1px solid #fff3;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px #fff2, 0 0 16px var(--ok);
    }

    .controls{
      height: var(--controlsH);
      padding: 10px 14px 0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      position:relative;
      z-index: 9;
    }
    .btn{
      font-family: var(--font-retro);
      font-size: 20px;
      letter-spacing: 1px;
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid #ffffff26;
      background: linear-gradient(180deg, #ffffff12, #00000020);
      color: var(--ink);
      cursor: pointer;
      user-select:none;
      box-shadow: inset 0 0 0 1px #00000025;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: #89f0d155;
      background: linear-gradient(180deg, #89f0d126, #00000020);
    }
    .btn.danger{
      border-color: #ff5b6e66;
      background: linear-gradient(180deg, #ff5b6e22, #00000020);
    }
    .modePill{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      font-family: var(--font-retro);
      font-size: 20px;
      letter-spacing: 1px;
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid #ffffff26;
      background:#0002;
      white-space:nowrap;
    }
    .modePill b{ color: var(--lemon); }

    /* ===== main stage for 32:9 ===== */
    .stage{
      height: calc(100% - var(--hdrH) - var(--controlsH) - var(--tickerH));
      display:grid;
      grid-template-columns: 1fr var(--sideW);
      gap:12px;
      padding: var(--pad);
      min-height: 0;
      position:relative;
      z-index: 2;
    }

    /* VIDEO AREA */
    .videoShell{
      position:relative;
      border-radius: var(--radius);
      overflow:hidden;            /* outer clip */
      border: 1px solid #ffffff20;
      background:#000;
      box-shadow: inset 0 0 0 1px #0003;
      min-height:0;
    }

    /* HUD overlays */
    .videoHUD{
      position:absolute;
      left:12px;
      right:12px;
      top:12px;
      z-index: 5;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .hudPill{
      pointer-events:none;
      font-family:var(--font-retro);
      font-size:20px;
      letter-spacing:1px;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid #ffffff26;
      background: linear-gradient(180deg, #0a0d2499, #00000040);
      backdrop-filter: blur(6px);
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hudPill b{ color: var(--lemon); }
    .liveDot{ display:inline-flex; align-items:center; gap:8px; }
    .liveDot .rd{
      width:8px; height:8px; border-radius:50%;
      background: var(--danger);
      box-shadow:0 0 14px #ff5b6ecc;
    }

    /* The important part:
       - viewport clips everything (including iframe’s own scrollbar region)
       - iframe is centered, scaled to FIT HEIGHT, then extra zoom applied
       - we shift X left a bit to hide the inner scrollbar */
    .videoViewport{
      position:absolute;
      inset:0;
      overflow:hidden; /* NO SCROLLBARS ON OUR PAGE */
    }
    .camIFrame{
      position:absolute;
      left:50%;
      top:50%;
      /* We set width/height in JS to the “virtual” embed size */
      transform-origin:center center;
      border:0;
      background:#000;
      /* older attribute too */
      overflow:hidden;
    }

    /* SIDE STRIP */
    .side{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }
    .panel{
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid #ffffff20;
      background: linear-gradient(180deg, #ffffff14, #ffffff08);
      box-shadow: inset 0 0 0 1px #0003;
      min-height: 0;
    }
    .panelTitle{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      border-bottom:1px solid #ffffff22;
      background:
        linear-gradient(90deg, #86b7ff30, #c3a1ff24, #ff8fd120),
        linear-gradient(180deg, #ffffff14, #0000);
    }
    .panelTitle h3{
      margin:0;
      font-family:var(--font-retro);
      font-size:24px;
      letter-spacing:1px;
    }
    .panelTitle small{
      font-family:var(--font-retro);
      font-size:18px;
      opacity:.85;
      letter-spacing:.5px;
      white-space:nowrap;
    }

    .incidents{
      padding:10px 12px 12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 0;
      flex: 1;
    }
    .incident{
      display:grid;
      grid-template-columns: 32px 1fr auto;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: var(--radius2);
      background:#0002;
      border:1px solid #ffffff1e;
      cursor:pointer;
    }
    .ic{
      width:32px; height:32px;
      border-radius:12px;
      display:grid;
      place-items:center;
      font-family:var(--font-retro);
      font-size:22px;
      color:#0b0f2a;
      box-shadow: inset 0 0 0 1px #0002;
    }
    .itop{ font-weight:900; font-size:13px; line-height:1.1; }
    .isub{ opacity:.85; font-size:11px; margin-top:2px; }
    .itag{
      font-family:var(--font-retro);
      font-size:16px;
      padding: 6px 8px;
      border-radius:12px;
      border:1px solid #ffffff26;
      background:#0002;
      letter-spacing:1px;
      white-space:nowrap;
    }
    .sev-high .ic{ background: var(--danger); }
    .sev-med  .ic{ background: var(--warn); }
    .sev-low  .ic{ background: var(--mint); }

    .summary{
      padding:10px 12px 12px;
      display:grid;
      gap:10px;
    }
    .bigNums{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .card{
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background:#0002;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height: 66px;
    }
    .card .k{
      font-family: var(--font-retro);
      font-size: 16px;
      letter-spacing: 1px;
      opacity: .9;
    }
    .card .v{
      font-family: var(--font-retro);
      font-size: 28px;
      letter-spacing: 1px;
      color: var(--lemon);
      text-shadow: 0 2px 0 #0007;
      line-height: 1;
    }
    .card .s{
      font-size: 11px;
      opacity: .85;
      color: var(--muted);
      margin-top: 2px;
    }
    .note{
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background:#0002;
      padding: 10px 10px;
      font-size: 12px;
      line-height: 1.35;
      color: var(--muted);
    }
    .note b{ color: var(--lemon); }

    .ticker{
      height:var(--tickerH);
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      background:
        linear-gradient(90deg, #86b7ff2a, #ff8fd124 45%, #89f0d124),
        linear-gradient(180deg, #0000, #0002);
      position:relative;
      z-index: 10;
    }
    .tickerBrand{
      font-family:var(--font-retro);
      font-size:32px;
      letter-spacing:2px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
    }
    .tickerLine{
      overflow:hidden;
      white-space:nowrap;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      height:100%;
      display:flex;
      align-items:center;
      position:relative;
    }
    .tickerLine span{
      display:inline-block;
      padding-left: 100%;
      font-family:var(--font-retro);
      font-size:22px;
      letter-spacing:1px;
      animation: scroll var(--tickerSeconds) linear infinite;
      text-shadow:0 2px 0 #0007;
    }
    @keyframes scroll{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }
    .clockBox{
      font-family:var(--font-retro);
      font-size:32px;
      letter-spacing:2px;
      padding:6px 12px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      color:var(--lemon);
      white-space:nowrap;
    }

    .toast{
      position:absolute;
      right: 16px;
      bottom: calc(var(--tickerH) + 14px);
      z-index: 40;
      display:none;
      border-radius: 16px;
      border: 1px solid #ffffff26;
      background: linear-gradient(90deg, #ff5b6e88, #ffbf4a55 40%, #86b7ff55);
      box-shadow: 0 20px 50px #0008;
      padding: 12px 14px;
      color:#0b0f2a;
      max-width: 520px;
    }
    .toast .t1{
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 2px;
      display:flex;
      align-items:center;
      gap:10px;
      line-height: 1;
    }
    .toast .t2{
      margin-top: 6px;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.25;
    }
    .pulseDot{
      width: 12px; height: 12px; border-radius: 50%;
      background:#0b0f2a;
      animation: pulse 0.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity: 0.9; }
      50%{ transform: scale(1.45); opacity: 1; }
      100%{ transform: scale(1); opacity: 0.9; }
    }

    @media (max-width: 1100px){ :root{ --sideW: 320px; } }
    @media (max-width: 900px){
      :root{ --sideW: 280px; }
      .btn{ font-size:18px; padding:7px 10px; }
    }
  </style>
</head>

<body>
  <div class="bar">

    <div class="header">
      <div class="brand">
        <div class="logo">AZ NOW</div>
        <div class="sub">LIVE TRAFFIC + CAMS</div>
      </div>

      <div class="meta">
        <div class="pill"><span class="dot"></span><span>LIVE</span></div>
        <div class="pill" id="datePill">—</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn danger" id="btnAccident">Accident view</button>
      <button class="btn" id="btnRandom">Random</button>
      <button class="btn primary" id="btnHome">Home</button>
      <button class="btn" id="btnWork">Work</button>
      <button class="btn" id="btnMegan">Megan</button>
      <button class="btn" id="btnDowntown">Downtown</button>

      <div class="modePill">MODE: <b id="modeLabel">RANDOM</b></div>
    </div>

    <div class="stage">
      <!-- VIDEO (primary) -->
      <div class="videoShell">
        <div class="videoHUD">
          <div class="hudPill">
            <span class="liveDot"><span class="rd"></span>LIVE</span>
            <span id="camLabelHud">Loading…</span>
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="hudPill">FEED <b id="camIndexHud">—</b></div>
            <div class="hudPill">NEXT <b id="camCountdownHud">—</b>s</div>
          </div>
        </div>

        <div class="videoViewport" id="videoViewport">
          <iframe
            id="camFrame"
            class="camIFrame"
            title="AZ511 camera view"
            scrolling="no"
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
            referrerpolicy="no-referrer"
          ></iframe>
        </div>
      </div>

      <!-- SIDE STRIP -->
      <div class="side">
        <section class="panel" style="flex:1;">
          <div class="panelTitle">
            <h3>TOP INCIDENTS</h3>
            <small>UPDATED: <span id="incUpdated">—</span></small>
          </div>
          <div class="incidents" id="incidentsList">
            <div class="incident sev-low">
              <div class="ic">…</div>
              <div>
                <div class="itop">Loading</div>
                <div class="isub">Waiting for AZ511 events…</div>
              </div>
              <div class="itag">LIVE</div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panelTitle">
            <h3>CITY SNAPSHOT</h3>
            <small>STATUS: <span id="statusLabel">—</span></small>
          </div>
          <div class="summary">
            <div class="bigNums">
              <div class="card">
                <div class="k">EVENTS</div>
                <div class="v" id="statEvents">—</div>
                <div class="s">Active traffic items</div>
              </div>
              <div class="card">
                <div class="k">CAMS</div>
                <div class="v" id="statCams">—</div>
                <div class="s">Camera feeds available</div>
              </div>
            </div>
            <div class="note" id="note">
              Tip: <b>Accident view</b> jumps near crashes. <b>Home</b> keeps you near your place.
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="ticker">
      <div class="tickerBrand">AZ NOW</div>
      <div class="tickerLine"><span id="tickerText">CONNECTING TO AZ511…</span></div>
      <div class="clockBox" id="clock">—:— —</div>
    </div>

    <div class="toast" id="toast">
      <div class="t1"><span class="pulseDot"></span>NEW ACCIDENT</div>
      <div class="t2" id="toastMsg">—</div>
    </div>

  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const WORKER_BASE = "https://az-now-511-proxy.zachary-1-marshall.workers.dev";

  const CAMERA_ROTATE_SECONDS = 20;
  const EVENTS_POLL_SECONDS = 45;
  const CAMS_REFRESH_SECONDS = 10 * 60;

  const LOCATIONS = {
    HOME:     { name: "HOME",     lat: 33.295147, lon: -112.117982 },
    WORK:     { name: "WORK",     lat: 33.440492, lon: -111.953428 },
    MEGAN:    { name: "MEGAN",    lat: 33.419155, lon: -111.703516 },
    DOWNTOWN: { name: "DOWNTOWN", lat: 33.448231, lon: -112.074975 }
  };

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function cssNum(name, fallback){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }
  function cssPx(name, fallback){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if(!v) return fallback;
    // supports "22px" or "0"
    return v.endsWith("px") ? Number(v.slice(0,-2)) : Number(v);
  }

  function setDatePill(){
    const d = new Date();
    const days = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    $("datePill").textContent = `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  }
  function updateClock(){
    const d = new Date();
    const h24 = d.getHours();
    const m = d.getMinutes();
    const ampm = h24 >= 12 ? "PM" : "AM";
    const h = ((h24 + 11) % 12) + 1;
    $("clock").textContent = `${h}:${pad2(m)} ${ampm}`;
  }
  function nowStamp(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // Haversine miles
  function distMiles(lat1, lon1, lat2, lon2){
    const toRad = (x) => x * Math.PI / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function pickLatLon(obj){
    const lat = Number(obj?.Latitude ?? obj?.Lat ?? obj?.Y ?? obj?.LocationLatitude);
    const lon = Number(obj?.Longitude ?? obj?.Lon ?? obj?.Long ?? obj?.X ?? obj?.LocationLongitude);
    if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
    return null;
  }

  function looksLikeAccident(ev){
    const t = (ev?.EventType || ev?.Type || ev?.EventCategory || "").toString().toLowerCase();
    const d = (ev?.Description || ev?.ShortDescription || ev?.EventDescription || "").toString().toLowerCase();
    return t.includes("accident") || t.includes("crash") || d.includes("accident") || d.includes("crash") || d.includes("collision");
  }

  function summarizeForHumans(ev){
    const type = (ev?.EventType || ev?.Type || "Traffic issue").toString();
    const road = (ev?.RoadwayName || ev?.Roadway || ev?.Road || "").toString();
    const desc = (ev?.Description || ev?.ShortDescription || ev?.EventDescription || "").toString();
    const loc  = (ev?.Location || ev?.LocationDescription || "").toString();
    const main = [type, road].filter(Boolean).join(" • ").trim() || "Traffic issue";
    const detail = (desc || loc || "Details unavailable").replace(/\s+/g," ").trim();
    return { main: main.slice(0, 42), detail: detail.slice(0, 85) };
  }

  async function getJSON(path){
    const url = `${WORKER_BASE}/${path.replace(/^\/+/,"")}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  // =========================
  // Embed sizing (THIS fixes your 32:9 problem)
  // =========================
  function positionAndScaleIframe(){
    const vp = $("videoViewport");
    const iframe = $("camFrame");
    if(!vp || !iframe) return;

    const vpW = vp.clientWidth;
    const vpH = vp.clientHeight;

    const embedW = cssNum("--embedW", 1280);
    const embedH = cssNum("--embedH", 720);

    // Fit by HEIGHT (always) so it stops zooming once vertical pixels fill up.
    const fitScale = vpH / embedH;

    const contentZoom = cssNum("--contentZoom", 1.6);
    const maxScale = cssNum("--maxScale", 2.4);

    const finalScale = Math.min(fitScale * contentZoom, maxScale);

    // Make iframe big enough to hide inner scrollbar by shifting left.
    const hideSB = cssPx("--hideScrollbarPx", 22);
    const offX = cssPx("--iframeOffsetX", 0);
    const offY = cssPx("--iframeOffsetY", 0);

    iframe.style.width  = embedW + "px";
    iframe.style.height = embedH + "px";

    // Center + offset + scrollbar shove, then scale.
    // Note: we push LEFT by hideSB so the right-side scrollbar gets clipped.
    iframe.style.transform =
      `translate(-50%, -50%) translate(${offX - hideSB}px, ${offY}px) scale(${finalScale})`;
  }

  // =========================
  // State
  // =========================
  let cameras = [];
  let camIdx = 0;
  let camCountdown = CAMERA_ROTATE_SECONDS;

  let lastEventIds = new Set();
  let lastEvents = [];

  let mode = { type: "RANDOM", target: null };

  // =========================
  // UI
  // =========================
  function setModeLabel(){
    if(mode.type === "ACCIDENT") $("modeLabel").textContent = "ACCIDENT";
    else if(mode.type === "RANDOM") $("modeLabel").textContent = "RANDOM";
    else if(mode.type === "NEAR") $("modeLabel").textContent = mode.target?.name || "NEAR";
  }
  function setTicker(text){ $("tickerText").textContent = text; }

  function setStatus(){
    const n = lastEvents.length;
    let label = "CALM";
    if(n >= 80) label = "BUSY";
    else if(n >= 30) label = "ACTIVE";
    else if(n >= 10) label = "NORMAL";
    $("statusLabel").textContent = label;

    if(mode.type === "ACCIDENT"){
      $("note").innerHTML = `Accident mode: jumps near new <b>crashes</b>.`;
    } else if(mode.type === "NEAR"){
      $("note").innerHTML = `Near <b>${escapeHTML(mode.target?.name || "target")}</b>: cams within ~<b>10 miles</b>.`;
    } else {
      $("note").innerHTML = `Random: city-wide shuffle. Try <b>Home</b> or <b>Downtown</b>.`;
    }
  }

  function showToast(msg){
    $("toastMsg").textContent = msg;
    const el = $("toast");
    el.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => el.style.display = "none", 5200);
  }

  // =========================
  // Loading
  // =========================
  async function loadCameras(){
    const data = await getJSON("cameras");
    const cleaned = [];
    for(const cam of data){
      const views = Array.isArray(cam.Views) ? cam.Views : [];
      const enabled = views.filter(v => (v.Status || "").toLowerCase() === "enabled" && v.Url);
      if(!enabled.length) continue;

      cleaned.push({
        id: cam.Id ?? cam.id,
        roadway: cam.Roadway || "",
        location: cam.Location || cam.Description || "",
        lat: Number(cam.Latitude),
        lon: Number(cam.Longitude),
        viewUrl: enabled[0].Url,
        viewDesc: enabled[0].Description || cam.Location || "Camera"
      });
    }
    cameras = cleaned;
    $("statCams").textContent = cameras.length ? String(cameras.length) : "0";
    if(camIdx >= cameras.length) camIdx = 0;

    if(cameras.length){
      showCamera(camIdx);
      setTicker(`CAMERAS LIVE • ${cameras.length} FEEDS • ${nowStamp()} •`);
    } else {
      setTicker(`NO CAMERAS FOUND • CHECK WORKER /cameras • ${nowStamp()} •`);
    }
  }

  async function loadEvents(){
    let data;
    try { data = await getJSON("event"); }
    catch { data = await getJSON("alerts"); }

    lastEvents = Array.isArray(data) ? data : (data?.Events || data?.events || []);
    $("incUpdated").textContent = nowStamp();
    $("statEvents").textContent = String(lastEvents.length);

    const ids = new Set();
    const newOnes = [];
    for(const ev of lastEvents){
      const id = (ev.Id ?? ev.EventId ?? ev.EventID ?? ev.IncidentId ?? ev.IncidentID ?? ev.Guid ?? ev.GUID ?? ev.SourceId ?? JSON.stringify(ev).slice(0,80));
      const sid = String(id);
      ids.add(sid);
      if(!lastEventIds.has(sid)) newOnes.push(ev);
    }

    const newAcc = newOnes.find(looksLikeAccident);
    if(lastEventIds.size && newAcc){
      const s = summarizeForHumans(newAcc);
      showToast(`${s.main} — ${s.detail}`);
      if(mode.type === "ACCIDENT"){
        jumpToNearestCamera(newAcc);
      }
    }
    lastEventIds = ids;

    renderIncidents(lastEvents);
    setStatus();
    setTicker(buildTicker(lastEvents));
  }

  function buildTicker(events){
    const base = `AZ NOW LIVE • ${events.length} ACTIVE EVENTS • MODE ${$("modeLabel").textContent} • ${nowStamp()} • `;
    if(!events.length) return base + "NO MAJOR ISSUES REPORTED • DRIVE SMART!";
    const blurbs = [];
    for(const ev of events.slice(0,3)){
      const s = summarizeForHumans(ev);
      blurbs.push(`${s.main} — ${s.detail}`);
    }
    return base + blurbs.join(" • ") + " • STAY SAFE — DRIVE SMART!";
  }

  function renderIncidents(events){
    const list = $("incidentsList");
    list.innerHTML = "";

    const maxInc = Number(getComputedStyle(document.documentElement).getPropertyValue("--maxIncidents")) || 5;
    const show = events.slice(0, maxInc);

    if(!show.length){
      list.innerHTML = `
        <div class="incident sev-low">
          <div class="ic">✓</div>
          <div>
            <div class="itop">All clear</div>
            <div class="isub">No active events reported.</div>
          </div>
          <div class="itag">OK</div>
        </div>`;
      return;
    }

    for(const ev of show){
      const s = summarizeForHumans(ev);
      const sevN = Number(ev?.Severity || ev?.SeverityId || 1);
      const cls = sevN >= 3 ? "sev-high" : (sevN === 2 ? "sev-med" : "sev-low");

      let icon = "•";
      if(looksLikeAccident(ev)) icon = "!";
      else if((ev?.EventType || "").toString().toLowerCase().includes("construction")) icon = "⛏";
      else if((ev?.EventType || "").toString().toLowerCase().includes("weather")) icon = "☁";

      const tag = looksLikeAccident(ev) ? "ACC" : (sevN ? `SEV ${sevN}` : "LIVE");

      const el = document.createElement("div");
      el.className = `incident ${cls}`;
      el.innerHTML = `
        <div class="ic">${escapeHTML(icon)}</div>
        <div>
          <div class="itop">${escapeHTML(s.main)}</div>
          <div class="isub">${escapeHTML(s.detail)}</div>
        </div>
        <div class="itag">${escapeHTML(tag)}</div>
      `;
      el.addEventListener("click", () => jumpToNearestCamera(ev));
      list.appendChild(el);
    }
  }

  // =========================
  // Cameras
  // =========================
  function showCamera(index){
    if(!cameras.length) return;

    camIdx = (index + cameras.length) % cameras.length;
    const cam = cameras[camIdx];

    $("camIndexHud").textContent = `${camIdx+1}/${cameras.length}`;
    $("camLabelHud").textContent = (cam.viewDesc || cam.location || cam.roadway || `CAM ${cam.id}`).slice(0,70);

    const frame = $("camFrame");
    frame.onload = () => positionAndScaleIframe();
    frame.src = cam.viewUrl;

    // also do it immediately
    positionAndScaleIframe();
  }

  function pickRandomCameraIndex(){
    return Math.floor(Math.random() * cameras.length);
  }

  function getCamerasNear(lat, lon, miles=10){
    if(!cameras.length) return [];
    const picks = [];
    for(let i=0;i<cameras.length;i++){
      const c = cameras[i];
      if(!Number.isFinite(c.lat) || !Number.isFinite(c.lon)) continue;
      const d = distMiles(lat, lon, c.lat, c.lon);
      if(d <= miles) picks.push({ i, d });
    }
    picks.sort((a,b) => a.d - b.d);
    return picks;
  }

  function nextCamera(){
    if(!cameras.length) return;

    if(mode.type === "RANDOM"){
      showCamera(pickRandomCameraIndex());
    } else if(mode.type === "NEAR" && mode.target){
      const near = getCamerasNear(mode.target.lat, mode.target.lon, 10);
      if(near.length){
        const currentPos = near.findIndex(x => x.i === camIdx);
        const nextPos = (currentPos >= 0 ? currentPos + 1 : 0) % near.length;
        showCamera(near[nextPos].i);
      } else {
        showCamera(pickRandomCameraIndex());
      }
    } else if(mode.type === "ACCIDENT"){
      showCamera(pickRandomCameraIndex());
    }

    camCountdown = CAMERA_ROTATE_SECONDS;
  }

  function jumpToNearestCamera(eventObj){
    if(!cameras.length) return;
    const p = pickLatLon(eventObj);
    if(!p){
      showCamera(pickRandomCameraIndex());
      camCountdown = CAMERA_ROTATE_SECONDS;
      return;
    }

    let bestI = 0;
    let bestD = Infinity;
    for(let i=0;i<cameras.length;i++){
      const c = cameras[i];
      if(!Number.isFinite(c.lat) || !Number.isFinite(c.lon)) continue;
      const d = distMiles(p.lat, p.lon, c.lat, c.lon);
      if(d < bestD){
        bestD = d;
        bestI = i;
      }
    }
    showCamera(bestI);
    camCountdown = CAMERA_ROTATE_SECONDS;
    $("note").innerHTML = `Jumped to the closest cam (~<b>${bestD.toFixed(1)} mi</b>) near that event.`;
  }

  function jumpToNewestAccident(){
    const newest = lastEvents.find(looksLikeAccident);
    if(newest) jumpToNearestCamera(newest);
    else showCamera(pickRandomCameraIndex());
  }

  // =========================
  // Modes
  // =========================
  function setModeAccident(){
    mode = { type: "ACCIDENT", target: null };
    setModeLabel(); setStatus();
    jumpToNewestAccident();
    setTicker(`ACCIDENT VIEW • Watching for new crashes • ${nowStamp()} •`);
  }
  function setModeRandom(){
    mode = { type: "RANDOM", target: null };
    setModeLabel(); setStatus();
    showCamera(pickRandomCameraIndex());
    setTicker(`RANDOM VIEW • City camera shuffle • ${nowStamp()} •`);
  }
  function setModeNear(loc){
    mode = { type: "NEAR", target: loc };
    setModeLabel(); setStatus();
    const near = getCamerasNear(loc.lat, loc.lon, 10);
    if(near.length) showCamera(near[0].i);
    else showCamera(pickRandomCameraIndex());
    setTicker(`NEAR ${loc.name} • Cameras within ~10 miles • ${nowStamp()} •`);
  }

  // =========================
  // Boot
  // =========================
  async function boot(){
    setDatePill();
    updateClock();
    setInterval(updateClock, 1000);

    $("btnAccident").addEventListener("click", setModeAccident);
    $("btnRandom").addEventListener("click", setModeRandom);
    $("btnHome").addEventListener("click", () => setModeNear(LOCATIONS.HOME));
    $("btnWork").addEventListener("click", () => setModeNear(LOCATIONS.WORK));
    $("btnMegan").addEventListener("click", () => setModeNear(LOCATIONS.MEGAN));
    $("btnDowntown").addEventListener("click", () => setModeNear(LOCATIONS.DOWNTOWN));

    window.addEventListener("resize", () => positionAndScaleIframe());

    try{ await loadCameras(); } catch(e){ console.error(e); }
    try{ await loadEvents(); } catch(e){ console.error(e); }

    setModeRandom();

    setInterval(() => loadCameras().catch(console.error), CAMS_REFRESH_SECONDS * 1000);
    setInterval(() => loadEvents().catch(console.error), EVENTS_POLL_SECONDS * 1000);

    setInterval(() => {
      if(!cameras.length) return;
      camCountdown--;
      if(camCountdown <= 0) nextCamera();
      $("camCountdownHud").textContent = String(camCountdown);
    }, 1000);
  }

  boot();
</script>
</body>
</html>
