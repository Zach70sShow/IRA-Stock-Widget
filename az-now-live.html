<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AZ NOW — Live Traffic + Cams (Xeneon Edge)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ====== YOU TWEAK THESE ====== */
      --scale: 0.31;          /* overall fit on Xeneon Edge (you said ~0.31 is right) */
      --textScale: 1.55;      /* bump text up WITHOUT zooming the camera */
      --designW: 2560;
      --designH: 720;

      /* Colors */
      --bg0:#0d1230; --bg1:#171a3b;
      --ink:#f7f3ff; --muted:#d7d2ff;
      --line:#ffffff22;

      --peach:#ffb48a; --mint:#89f0d1; --sky:#86b7ff; --lav:#c3a1ff; --pink:#ff8fd1; --lemon:#ffe27a; --teal:#2bd9ff;
      --danger:#ff5b6e; --warn:#ffbf4a; --ok:#60ffb0;

      --radius: 18px; --radius2: 14px;
      --hdrH: 60px; --tickerH: 56px;
      --pad: 14px;

      --font-ui: "IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-retro: "VT323", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;

      /* Font bases (we multiply by --textScale below) */
      --f-logo: 42px;
      --f-sub: 22px;
      --f-meta: 22px;
      --f-title: 26px;
      --f-small: 18px;
      --f-alertTop: 14px;
      --f-alertSub: 12px;
      --f-tag: 18px;
      --f-ticker: 24px;
      --f-clock: 34px;
    }

    *{ box-sizing:border-box; }
    html,body{ width:100%; height:100%; margin:0; }
    body{
      overflow:hidden;
      background:
        radial-gradient(1200px 500px at 20% 30%, #7b6cff30, transparent 55%),
        radial-gradient(900px 420px at 75% 20%, #2bd9ff24, transparent 60%),
        radial-gradient(900px 500px at 60% 80%, #ff8fd124, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
      font-family:var(--font-ui);
    }

    /* Stage + scaled canvas */
    .stage{
      position:fixed; inset:0;
      overflow:hidden;
    }
    .bar{
      width: calc(var(--designW) * 1px);
      height: calc(var(--designH) * 1px);
      transform: scale(var(--scale));
      transform-origin: top left;
      position:relative;
      overflow:hidden;
      background:
        linear-gradient(90deg, #ffffff14, #ffffff08 40%, #ffffff12),
        radial-gradient(700px 280px at 20% 30%, #ffb48a18, transparent 60%),
        radial-gradient(600px 260px at 75% 35%, #89f0d118, transparent 60%),
        radial-gradient(700px 300px at 50% 120%, #c3a1ff14, transparent 55%),
        linear-gradient(180deg, #13163a, #0f1232);
    }

    /* CRT scanlines */
    .bar::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.04),
        rgba(255,255,255,0.04) 1px,
        rgba(0,0,0,0.0) 2px,
        rgba(0,0,0,0.0) 4px
      );
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 9;
    }

    /* Header */
    .header{
      height:var(--hdrH);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      padding: 10px 14px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, #ffb48a66, #c3a1ff55 35%, #86b7ff55 60%, #89f0d155),
        linear-gradient(180deg, #ffffff12, #0000);
      z-index: 5;
      position:relative;
    }

    .brand{ display:flex; align-items:baseline; gap:12px; }
    .logo{
      font-family:var(--font-retro);
      font-size: calc(var(--f-logo) * var(--textScale));
      letter-spacing:2px;
      text-shadow:0 2px 0 #0007;
      line-height:1;
    }
    .sub{
      font-family:var(--font-retro);
      font-size: calc(var(--f-sub) * var(--textScale));
      letter-spacing:1px;
      opacity:.9;
    }

    .meta{
      display:flex; align-items:center; gap:14px;
      font-family:var(--font-retro);
      font-size: calc(var(--f-meta) * var(--textScale));
      letter-spacing:1px;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      background:#0003; border:1px solid #fff3;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px #fff2, 0 0 16px var(--ok);
    }

    /* Main grid (bigger, simpler center) */
    .main{
      height: calc(100% - var(--hdrH) - var(--tickerH));
      padding: var(--pad);
      display:grid;
      grid-template-columns: 1.25fr 1.05fr 1.7fr; /* incidents | snapshot | camera */
      gap: 12px;
      position:relative;
      z-index: 2;
    }

    .panel{
      background: linear-gradient(180deg, #ffffff14, #ffffff08);
      border: 1px solid #ffffff20;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px #0003;
      position:relative;
      min-height: 0;
    }
    .panelTitle{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid #ffffff22;
      background:
        linear-gradient(90deg, #86b7ff30, #c3a1ff24, #ff8fd120),
        linear-gradient(180deg, #ffffff14, #0000);
    }
    .panelTitle h3{
      margin:0;
      font-family:var(--font-retro);
      font-size: calc(var(--f-title) * var(--textScale));
      letter-spacing:1px;
    }
    .panelTitle small{
      font-family:var(--font-retro);
      font-size: calc(var(--f-small) * var(--textScale));
      opacity:.85;
      letter-spacing:.5px;
      white-space:nowrap;
    }

    /* Incidents list */
    .alerts{
      padding: 10px 12px 12px;
      display:flex; flex-direction:column; gap:10px;
      height: calc(100% - 52px);
      overflow:auto;
    }
    .alert{
      display:grid;
      grid-template-columns: 40px 1fr auto;
      gap:12px;
      align-items:center;
      padding: 12px 12px;
      border-radius: var(--radius2);
      background:#0002;
      border:1px solid #ffffff1e;
    }
    .icon{
      width:40px; height:40px; border-radius:14px;
      display:grid; place-items:center;
      font-family:var(--font-retro);
      font-size: calc(22px * var(--textScale));
      color:#0b0f2a;
      box-shadow: inset 0 0 0 1px #0002;
    }
    .text .top{
      font-weight:900;
      font-size: calc(var(--f-alertTop) * var(--textScale));
      line-height:1.1;
      letter-spacing:.2px;
    }
    .text .sub{
      opacity:.9;
      font-size: calc(var(--f-alertSub) * var(--textScale));
      margin-top:4px;
      line-height:1.15;
    }
    .tag{
      font-family:var(--font-retro);
      font-size: calc(var(--f-tag) * var(--textScale));
      padding: 8px 10px;
      border-radius:12px;
      border:1px solid #ffffff26;
      background:#0002;
      letter-spacing:1px;
      white-space:nowrap;
    }
    .a-danger .icon{ background:var(--danger); }
    .a-warn .icon{ background:var(--warn); }
    .a-ok .icon{ background:var(--mint); }

    /* Snapshot (replaces fake map) */
    .snap{
      padding: 12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
      min-height:0;
    }

    .bigStats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .card{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      padding: 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-height: 92px;
    }
    .card .k{
      font-family:var(--font-retro);
      font-size: calc(18px * var(--textScale));
      letter-spacing:1px;
      opacity:.9;
    }
    .card .v{
      font-family:var(--font-retro);
      font-size: calc(34px * var(--textScale));
      letter-spacing:1px;
      font-weight: 900;
      line-height: 1;
      text-shadow:0 2px 0 #0007;
    }
    .card .v.lemon{ color:var(--lemon); }
    .card .v.mint{ color:var(--mint); }
    .card .v.danger{ color:var(--danger); }

    .modeRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }
    .modeBadge{
      border-radius: 999px;
      border:1px solid #ffffff1f;
      background:#0002;
      padding: 10px 12px;
      font-family: var(--font-retro);
      font-size: calc(22px * var(--textScale));
      letter-spacing:1px;
      display:flex;
      align-items:center;
      gap: 10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .modeBadge .spark{
      width:10px; height:10px; border-radius:50%;
      background: var(--teal);
      box-shadow: 0 0 14px #2bd9ff77;
    }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      cursor:pointer;
      user-select:none;
      border-radius: 14px;
      border:1px solid #ffffff26;
      background: linear-gradient(180deg, #ffffff14, #00000010);
      color: var(--ink);
      padding: 10px 12px;
      font-family: var(--font-retro);
      font-size: calc(20px * var(--textScale));
      letter-spacing:1px;
      box-shadow: inset 0 0 0 1px #0003;
      transition: transform .08s ease, background .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.on{
      border-color: #ffffff44;
      background: linear-gradient(90deg, #89f0d133, #86b7ff22, #ff8fd122);
      box-shadow: 0 10px 22px #0005, inset 0 0 0 1px #ffffff14;
    }

    .infoBox{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      background:#0002;
      padding: 12px;
      min-height:0;
      overflow:auto;
      font-size: calc(13px * var(--textScale));
      line-height: 1.25;
      color: var(--muted);
    }
    .infoBox b{ color: var(--ink); }

    /* Camera panel */
    .camWrap{
      padding:12px;
      height: calc(100% - 52px);
      display:grid;
      grid-template-rows: auto 1fr;
      gap:12px;
      min-height: 0;
    }
    .camMeta{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
    }
    .camMeta .left{
      display:flex; align-items:center; gap:10px;
      font-family:var(--font-retro);
      font-size: calc(22px * var(--textScale));
      letter-spacing:1px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:14px;
      padding:10px 12px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .livePip{ display:inline-flex; align-items:center; gap:8px; }
    .livePip .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 16px #ff5b6ecc;
    }
    .camMeta .right{
      font-family:var(--font-retro);
      font-size: calc(22px * var(--textScale));
      letter-spacing:1px;
      background:#0004;
      border:1px solid #fff2;
      border-radius:14px;
      padding:10px 12px;
      white-space:nowrap;
    }

    .camBox{
      border-radius: var(--radius2);
      border:1px solid #ffffff1f;
      overflow:hidden;
      background:#0002;
      position:relative;
      min-height: 0;
    }

    /* IMPORTANT: keep camera "un-zoomed" (contain) */
    .camFrame{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
      background:#000;
    }

    /* If iframe content is "too zoomed" because the camera page itself is big,
       we can scale JUST the iframe contents by wrapping via CSS transform.
       This DOES NOT affect text elsewhere. */
    .camInner{
      position:absolute; inset:0;
      transform: scale(var(--camScale));
      transform-origin: top left;
      width: calc(100% / var(--camScale));
      height: calc(100% / var(--camScale));
    }
    :root{ --camScale: 1; } /* set to 0.9, 0.8, etc if you ever want camera smaller */

    .camFallback{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      padding:22px;
      text-align:center;
      color: var(--muted);
      font-family: var(--font-retro);
      font-size: calc(28px * var(--textScale));
      letter-spacing: 1px;
      background:
        radial-gradient(900px 260px at 60% 70%, #ffb48a22, transparent 55%),
        radial-gradient(700px 240px at 30% 50%, #86b7ff1f, transparent 60%),
        linear-gradient(180deg, #0b0f2b, #070a1d);
    }
    .camFallback small{
      display:block;
      font-size: calc(18px * var(--textScale));
      opacity:.85;
      margin-top:12px;
      font-family: var(--font-ui);
      letter-spacing:0;
    }

    /* Ticker */
    .ticker{
      height:var(--tickerH);
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      background:
        linear-gradient(90deg, #86b7ff2a, #ff8fd124 45%, #89f0d124),
        linear-gradient(180deg, #0000, #0002);
      position:relative;
      z-index:5;
    }
    .tickerBrand{
      font-family:var(--font-retro);
      font-size: calc(34px * var(--textScale));
      letter-spacing:2px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      white-space:nowrap;
    }
    .tickerLine{
      overflow:hidden;
      white-space:nowrap;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      height:100%;
      display:flex;
      align-items:center;
      position:relative;
    }
    .tickerLine span{
      display:inline-block;
      padding-left: 100%;
      font-family:var(--font-retro);
      font-size: calc(var(--f-ticker) * var(--textScale));
      letter-spacing:1px;
      animation: scroll var(--tickerSeconds) linear infinite;
      text-shadow:0 2px 0 #0007;
    }
    :root{ --tickerSeconds: 52s; } /* SLOWER ticker (was too fast) */

    @keyframes scroll{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }

    .clockBox{
      font-family:var(--font-retro);
      font-size: calc(var(--f-clock) * var(--textScale));
      letter-spacing:2px;
      padding:6px 12px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#0002;
      text-shadow:0 2px 0 #0007;
      color:var(--lemon);
      white-space:nowrap;
    }

    /* BREAKING overlay */
    .breaking{
      position:absolute; inset:0;
      display:none;
      z-index: 20;
      background: linear-gradient(180deg, #000000aa, #00000055);
      backdrop-filter: blur(4px);
    }
    .breaking .box{
      position:absolute;
      left: 18px;
      right: 18px;
      top: 84px;
      border-radius: 18px;
      border: 1px solid #ffffff26;
      background:
        linear-gradient(90deg, #ff5b6e88, #ffbf4a55 40%, #86b7ff55),
        linear-gradient(180deg, #00000022, #00000066);
      box-shadow: 0 20px 50px #0008;
      padding: 16px 16px 14px;
      overflow:hidden;
    }
    .breaking .label{
      font-family: var(--font-retro);
      font-size: calc(34px * var(--textScale));
      letter-spacing: 2px;
      display:flex;
      align-items:center;
      gap:10px;
      color:#0b0f2a;
      text-shadow:none;
    }
    .breaking .label .pulse{
      width: 12px; height: 12px;
      border-radius: 50%;
      background: #0b0f2a;
      animation: pulse 0.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity: 0.9; }
      50%{ transform: scale(1.45); opacity: 1; }
      100%{ transform: scale(1); opacity: 0.9; }
    }
    .breaking .msg{
      margin-top: 8px;
      color: #0b0f2a;
      font-weight: 900;
      font-size: calc(20px * var(--textScale));
    }
    .breaking .submsg{
      margin-top: 4px;
      color: #0b0f2a;
      opacity: .9;
      font-size: calc(14px * var(--textScale));
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="bar" role="img" aria-label="AZ NOW live traffic and cams dashboard">

      <!-- HEADER (retro badge removed per request) -->
      <div class="header">
        <div class="brand">
          <div class="logo">AZ NOW</div>
          <div class="sub">LIVE TRAFFIC + CAMS</div>
        </div>
        <div class="meta">
          <div class="pill"><span class="dot"></span><span>LIVE</span></div>
          <div class="pill" id="datePill">—</div>
        </div>
      </div>

      <div class="main">
        <!-- INCIDENTS -->
        <section class="panel">
          <div class="panelTitle">
            <h3>TOP INCIDENTS</h3>
            <small id="alertsCount">—</small>
          </div>
          <div class="alerts" id="alertsList">
            <div class="alert a-ok">
              <div class="icon">…</div>
              <div class="text">
                <div class="top">LOADING</div>
                <div class="sub">Waiting for AZ511 events…</div>
              </div>
              <div class="tag">LIVE</div>
            </div>
          </div>
        </section>

        <!-- SNAPSHOT (simple + readable) -->
        <section class="panel">
          <div class="panelTitle">
            <h3>CITY SNAPSHOT</h3>
            <small>UPDATED: <span id="snapUpdated">—</span></small>
          </div>

          <div class="snap">
            <div class="bigStats">
              <div class="card">
                <div class="k">ACTIVE EVENTS</div>
                <div class="v danger" id="statEvents">—</div>
              </div>
              <div class="card">
                <div class="k">CAMERAS ONLINE</div>
                <div class="v mint" id="statCams">—</div>
              </div>
              <div class="card">
                <div class="k">CURRENT MODE</div>
                <div class="v lemon" id="statMode">RANDOM</div>
              </div>
              <div class="card">
                <div class="k">NEXT CAM IN</div>
                <div class="v lemon"><span id="statNext">—</span>s</div>
              </div>
            </div>

            <div class="modeRow">
              <div class="modeBadge" id="modeBadge" title="What the dashboard is doing right now">
                <span class="spark"></span>
                <span id="modeExplain">Rotating through random cams.</span>
              </div>

              <div class="btnRow">
                <button class="btn on" id="btnRandom">RANDOM</button>
                <button class="btn" id="btnHouse">HOUSE</button>
                <button class="btn" id="btnAccident">ACCIDENT</button>
              </div>
            </div>

            <div class="infoBox" id="helpBox">
              <b>RANDOM</b> = rotates through all cams.<br>
              <b>HOUSE</b> = rotates cams near your home (within a radius).<br>
              <b>ACCIDENT</b> = jumps to the nearest camera to a newly-reported event (when coordinates are available).<br><br>
              Tip: If the camera page ever refuses to embed, we can swap to a snapshot/proxy approach.
            </div>
          </div>
        </section>

        <!-- LIVE CAM -->
        <section class="panel">
          <div class="panelTitle">
            <h3>LIVE CAMERA</h3>
            <small>FEED: <span id="camIndex">—</span></small>
          </div>

          <div class="camWrap">
            <div class="camMeta">
              <div class="left" title="Camera location">
                <span class="livePip"><span class="dot"></span>LIVE</span>
                <span id="camLabel">Loading cameras…</span>
              </div>
              <div class="right">ROTATE: <span id="camCountdown">—</span>s</div>
            </div>

            <div class="camBox">
              <!-- camInner lets you scale JUST the embedded page if you ever need it -->
              <div class="camInner">
                <iframe class="camFrame" id="camFrame" title="AZ511 camera view"
                  sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
              </div>

              <div class="camFallback" id="camFallback">
                CAMERA EMBED BLOCKED
                <small>If AZ511 disallows iframe embedding, we can switch to still images (if provided) or proxy a snapshot endpoint.</small>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="ticker">
        <div class="tickerBrand">AZ NOW</div>
        <div class="tickerLine"><span id="tickerText">CONNECTING TO AZ511…</span></div>
        <div class="clockBox" id="clock">—:— —</div>
      </div>

      <div class="breaking" id="breaking">
        <div class="box">
          <div class="label"><span class="pulse"></span>BREAKING</div>
          <div class="msg" id="breakingMsg">New traffic event detected</div>
          <div class="submsg" id="breakingSub">Switching to nearest camera…</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG (edit these only)
  // =========================
  const WORKER_BASE = "https://az-now-511-proxy.zachary-1-marshall.workers.dev";

  // Rotation + polling
  const CAMERA_ROTATE_SECONDS = 20;
  const EVENTS_POLL_SECONDS = 45;
  const CAMS_REFRESH_SECONDS  = 10 * 60;

  // HOUSE mode: set your home location + radius
  const HOUSE_LAT = 33.295147;    // <-- replace with your home lat (Phoenix default placeholder)
  const HOUSE_LON = -112.117982;  // <-- replace with your home lon
  const HOUSE_RADIUS_MILES = 10; // cams within this distance are considered "near home"

  // Severity threshold for “ACCIDENT” feel (still shows other things, but prioritizes bigger ones)
  const SEV_MAJOR_AT_OR_ABOVE = 3;

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function setDatePill(){
    const d = new Date();
    const days = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    $("datePill").textContent = `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  }

  function updateClock(){
    const d = new Date();
    const h24 = d.getHours();
    const m = d.getMinutes();
    const ampm = h24 >= 12 ? "PM" : "AM";
    const h = ((h24 + 11) % 12) + 1;
    $("clock").textContent = `${h}:${pad2(m)} ${ampm}`;
  }

  function nowStamp(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  // Haversine distance (miles)
  function distMiles(lat1, lon1, lat2, lon2){
    const toRad = (x) => x * Math.PI / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function sevNumber(ev){
    const raw = ev?.Severity ?? ev?.SeverityId ?? ev?.SeverityID ?? ev?.severity;
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }

  function pickEventLatLon(e){
    const lat = Number(e.Latitude ?? e.Lat ?? e.Y ?? e.LocationLatitude);
    const lon = Number(e.Longitude ?? e.Lon ?? e.Long ?? e.X ?? e.LocationLongitude);
    if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
    return null;
  }

  // =========================
  // Mode State
  // =========================
  const MODE = {
    RANDOM: "RANDOM",
    HOUSE: "HOUSE",
    ACCIDENT: "ACCIDENT"
  };
  let mode = MODE.RANDOM;

  function setMode(next){
    mode = next;
    $("statMode").textContent = next;

    // button styling
    $("btnRandom").classList.toggle("on", next === MODE.RANDOM);
    $("btnHouse").classList.toggle("on", next === MODE.HOUSE);
    $("btnAccident").classList.toggle("on", next === MODE.ACCIDENT);

    if(next === MODE.RANDOM){
      $("modeExplain").textContent = "Rotating through random cams.";
    } else if(next === MODE.HOUSE){
      $("modeExplain").textContent = `Showing cams near your house (~${HOUSE_RADIUS_MILES} mi).`;
    } else {
      $("modeExplain").textContent = "Prioritizing new incidents → nearest cam.";
    }

    // force immediate camera refresh in current mode
    camCountdown = 2;
  }

  // =========================
  // Data State
  // =========================
  let camerasAll = [];
  let camerasNearHouse = [];
  let camPlaylist = []; // the current list we rotate through (depends on mode)
  let camIdx = 0;
  let camCountdown = CAMERA_ROTATE_SECONDS;

  let lastEventIds = new Set();
  let lastEvents = [];

  // =========================
  // Fetchers
  // =========================
  async function getJSON(path){
    const url = `${WORKER_BASE}/${path.replace(/^\/+/,"")}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  async function loadCameras(){
    const data = await getJSON("cameras");

    const cleaned = [];
    for(const cam of data){
      const views = Array.isArray(cam.Views) ? cam.Views : [];
      const enabled = views.filter(v => (v.Status || "").toLowerCase() === "enabled" && v.Url);
      if(!enabled.length) continue;

      const lat = Number(cam.Latitude);
      const lon = Number(cam.Longitude);

      cleaned.push({
        id: cam.Id ?? cam.id,
        roadway: cam.Roadway || "",
        location: cam.Location || cam.Description || "",
        lat, lon,
        viewUrl: enabled[0].Url,
        viewDesc: enabled[0].Description || cam.Location || "Camera"
      });
    }

    camerasAll = cleaned;
    $("statCams").textContent = camerasAll.length ? String(camerasAll.length) : "0";

    // Precompute near-house list
    camerasNearHouse = camerasAll
      .filter(c => Number.isFinite(c.lat) && Number.isFinite(c.lon))
      .map(c => ({...c, d: distMiles(HOUSE_LAT, HOUSE_LON, c.lat, c.lon)}))
      .filter(c => c.d <= HOUSE_RADIUS_MILES)
      .sort((a,b) => a.d - b.d);

    // Build playlist based on current mode
    rebuildPlaylist();

    // paint first camera if needed
    if(camPlaylist.length){
      camIdx = Math.min(camIdx, camPlaylist.length - 1);
      showCamera(camIdx);
      setTicker(`AZ NOW LIVE • CAMERAS ONLINE ${camerasAll.length} • UPDATED ${nowStamp()} •`);
    } else {
      setTicker(`AZ NOW LIVE • NO CAMERAS FOUND • CHECK WORKER /cameras • ${nowStamp()} •`);
    }
  }

  function rebuildPlaylist(){
    if(mode === MODE.HOUSE){
      camPlaylist = camerasNearHouse.length ? camerasNearHouse : camerasAll;
    } else {
      camPlaylist = camerasAll;
    }

    // If playlist changed, keep index valid
    if(camIdx >= camPlaylist.length) camIdx = 0;
  }

  async function loadEvents(){
    // Try endpoints; your worker supports one of these
    let data;
    try { data = await getJSON("event"); }
    catch { data = await getJSON("alerts"); }

    lastEvents = Array.isArray(data) ? data : (data?.Events || data?.events || []);
    $("statEvents").textContent = String(lastEvents.length);
    $("snapUpdated").textContent = nowStamp();

    // sort for display: severity desc then newest-ish
    const sortedForList = [...lastEvents].sort((a,b) => sevNumber(b) - sevNumber(a));

    renderAlerts(sortedForList);

    // Detect new events by id-ish field
    const ids = new Set();
    const newOnes = [];
    for(const ev of lastEvents){
      const id = (ev.Id ?? ev.EventId ?? ev.EventID ?? ev.IncidentId ?? ev.IncidentID ?? ev.Guid ?? ev.GUID ?? ev.SourceId ?? JSON.stringify(ev).slice(0,80));
      const sid = String(id);
      ids.add(sid);
      if(!lastEventIds.has(sid)) newOnes.push(ev);
    }

    // Breaking + jump cam (only in ACCIDENT mode)
    if(lastEventIds.size && newOnes.length){
      const picked = newOnes.sort((a,b) => sevNumber(b) - sevNumber(a))[0];
      triggerBreaking(picked);

      if(mode === MODE.ACCIDENT){
        jumpToNearestCamera(picked);
      }
    }

    lastEventIds = ids;

    // ticker
    setTicker(buildTicker(sortedForList));
  }

  function setTicker(text){
    $("tickerText").textContent = text;
  }

  function buildTicker(events){
    const base = `AZ NOW LIVE • ${events.length} ACTIVE EVENTS • MODE ${mode} • NEXT CAM ${camCountdown}s • ${nowStamp()} • `;
    if(!events.length) return base + "NO MAJOR INCIDENTS REPORTED • DRIVE SMART!";
    const blurbs = [];
    for(const e of events.slice(0,3)){
      const t = (e.EventType || e.Type || "EVENT");
      const r = (e.RoadwayName || e.Roadway || "");
      const d = (e.Description || e.ShortDescription || "");
      const b = `${t}${r ? " " + r : ""}${d ? " — " + d : ""}`.replace(/\s+/g," ").trim();
      if(b) blurbs.push(b);
    }
    return base + blurbs.join(" • ") + " • STAY SAFE — DRIVE SMART!";
  }

  function renderAlerts(events){
    const list = $("alertsList");
    list.innerHTML = "";

    $("alertsCount").textContent = `${events.length} ITEMS`;

    if(!events.length){
      list.innerHTML = `
        <div class="alert a-ok">
          <div class="icon">✓</div>
          <div class="text">
            <div class="top">NO ACTIVE EVENTS</div>
            <div class="sub">Smooth sailing (or the API is quiet).</div>
          </div>
          <div class="tag">OK</div>
        </div>`;
      return;
    }

    const max = Math.min(events.length, 8);
    for(let i=0;i<max;i++){
      const e = events[i];
      const sev = sevNumber(e);
      const type = (e.EventType || e.Type || e.EventCategory || "EVENT").toString();
      const road = (e.RoadwayName || e.Roadway || e.Road || "").toString();
      const desc = (e.Description || e.ShortDescription || e.EventDescription || "").toString();
      const loc  = (e.Location || e.LocationDescription || "").toString();

      let cls = "a-ok";
      let icon = "•";
      let tag = sev ? `SEV ${sev}` : "LIVE";

      if(sev >= 3){ cls="a-danger"; icon="!"; }
      else if(sev === 2){ cls="a-warn"; icon="⛏"; }

      const top = (type || "EVENT").slice(0,28);
      const subRaw = (desc || loc || road || "Traffic event");
      const sub = subRaw.length > 90 ? subRaw.slice(0,88) + "…" : subRaw;

      const el = document.createElement("div");
      el.className = `alert ${cls}`;
      el.innerHTML = `
        <div class="icon">${escapeHTML(icon)}</div>
        <div class="text">
          <div class="top">${escapeHTML(top)}</div>
          <div class="sub">${escapeHTML(sub)}</div>
        </div>
        <div class="tag">${escapeHTML(tag)}</div>
      `;
      list.appendChild(el);
    }
  }

  // =========================
  // Camera rotation
  // =========================
  function showCamera(index){
    if(!camPlaylist.length) return;

    camIdx = (index + camPlaylist.length) % camPlaylist.length;
    const cam = camPlaylist[camIdx];

    $("camIndex").textContent = `${camIdx+1}/${camPlaylist.length}`;
    $("camLabel").textContent = (cam.viewDesc || cam.location || cam.roadway || `CAM ${cam.id}`).slice(0,80);

    const frame = $("camFrame");
    const fallback = $("camFallback");

    let loaded = false;
    frame.onload = () => { loaded = true; fallback.style.display = "none"; };
    frame.src = cam.viewUrl;

    setTimeout(() => {
      if(!loaded){
        fallback.style.display = "grid";
      }
    }, 1200);
  }

  function nextCamera(){
    // In ACCIDENT mode we still rotate, but through current playlist (random)
    showCamera(camIdx + 1);
    camCountdown = CAMERA_ROTATE_SECONDS;
  }

  // Jump to nearest camera for an event (if coords exist)
  function jumpToNearestCamera(eventObj){
    if(!camerasAll.length) return;
    const p = pickEventLatLon(eventObj);
    if(!p) return;

    let bestI = 0;
    let bestD = Infinity;

    // In HOUSE mode, prefer near-house cams if available, otherwise all
    const pool = (mode === MODE.HOUSE && camerasNearHouse.length) ? camerasNearHouse : camerasAll;

    for(let i=0;i<pool.length;i++){
      const c = pool[i];
      if(!Number.isFinite(c.lat) || !Number.isFinite(c.lon)) continue;
      const d = distMiles(p.lat, p.lon, c.lat, c.lon);
      if(d < bestD){
        bestD = d;
        bestI = i;
      }
    }

    // If we jumped within a pool that's not the current playlist, swap playlist to pool for a clean index
    if(mode === MODE.HOUSE && camerasNearHouse.length){
      camPlaylist = camerasNearHouse;
    } else {
      camPlaylist = camerasAll;
    }

    camIdx = bestI;
    showCamera(camIdx);
    camCountdown = CAMERA_ROTATE_SECONDS;

    $("breakingSub").textContent = `Nearest cam selected (~${bestD.toFixed(1)} mi)`;
  }

  // =========================
  // Breaking overlay
  // =========================
  let breakingTimer = null;
  function triggerBreaking(eventObj){
    const type = (eventObj.EventType || eventObj.Type || "TRAFFIC EVENT").toString();
    const desc = (eventObj.Description || eventObj.ShortDescription || "New incident reported").toString();
    const road = (eventObj.RoadwayName || eventObj.Roadway || "").toString();

    $("breakingMsg").textContent = `${type}${road ? " • " + road : ""}`;
    $("breakingSub").textContent = desc.slice(0,110);

    const el = $("breaking");
    el.style.display = "block";

    clearTimeout(breakingTimer);
    breakingTimer = setTimeout(() => {
      el.style.display = "none";
    }, 5200);
  }

  // =========================
  // Buttons
  // =========================
  $("btnRandom").addEventListener("click", () => { setMode(MODE.RANDOM); rebuildPlaylist(); });
  $("btnHouse").addEventListener("click", () => { setMode(MODE.HOUSE); rebuildPlaylist(); });
  $("btnAccident").addEventListener("click", () => { setMode(MODE.ACCIDENT); rebuildPlaylist(); });

  // =========================
  // Boot / loops
  // =========================
  async function boot(){
    setDatePill();
    updateClock();
    setInterval(updateClock, 1000);

    // initial loads
    try{
      await loadCameras();
    }catch(e){
      $("statCams").textContent = "0";
      setTicker(`CAMERA LOAD FAILED • CHECK WORKER /cameras • ${nowStamp()} •`);
      console.error(e);
    }

    try{
      await loadEvents();
    }catch(e){
      setTicker(`EVENT LOAD FAILED • CHECK WORKER /event • ${nowStamp()} •`);
      console.error(e);
    }

    // refresh cameras occasionally
    setInterval(() => {
      loadCameras().catch(console.error);
    }, CAMS_REFRESH_SECONDS * 1000);

    // poll events
    setInterval(() => {
      loadEvents().catch(console.error);
    }, EVENTS_POLL_SECONDS * 1000);

    // camera rotation timer
    setInterval(() => {
      if(!camPlaylist.length) return;

      camCountdown--;
      if(camCountdown <= 0) nextCamera();

      $("camCountdown").textContent = String(camCountdown);
      $("statNext").textContent = String(camCountdown);
    }, 1000);

    // Prime countdown UI
    $("camCountdown").textContent = String(camCountdown);
    $("statNext").textContent = String(camCountdown);
    $("statMode").textContent = mode;
  }

  // Start in RANDOM
  setMode(MODE.RANDOM);
  boot();
</script>
</body>
</html>
