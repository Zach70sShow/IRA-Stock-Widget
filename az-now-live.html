<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AZ NOW — Live (AZ511)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#0d1230;
      --bg1:#171a3b;
      --ink:#f7f3ff;
      --muted:#d7d2ff;
      --line:#ffffff26;
      --shadow: 0 10px 30px #00000055;

      /* “pastel but 80s” */
      --peach:#ffb48a;
      --mint:#89f0d1;
      --sky:#86b7ff;
      --lav:#c3a1ff;
      --pink:#ff8fd1;
      --lemon:#ffe27a;
      --teal:#2bd9ff;

      --danger:#ff5b6e;
      --warn:#ffbf4a;
      --ok:#60ffb0;

      --radius: 18px;
      --radius2: 14px;

      --hdrH: 58px;
      --tickerH: 56px;
      --pad: 14px;

      --font-ui: "IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-retro: "VT323", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    * { box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: var(--font-ui);
      color: var(--ink);
    }

    #stage{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background:
        radial-gradient(1200px 500px at 20% 30%, #7b6cff30, transparent 55%),
        radial-gradient(900px 420px at 75% 20%, #2bd9ff24, transparent 60%),
        radial-gradient(900px 500px at 60% 80%, #ff8fd124, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow: hidden;
    }

    /* native design canvas */
    #canvas{
      width: 2560px;
      height: 720px;
      transform-origin: top left;
      will-change: transform;
    }

    /* Outer */
    .bar {
      width: 2560px;
      height: 720px;
      border-radius: 0;
      box-shadow: none;
      border: 0;
      position: relative;
      overflow: hidden;

      background:
        linear-gradient(90deg, #ffffff14, #ffffff08 40%, #ffffff12),
        radial-gradient(900px 360px at 18% 35%, #ffb48a18, transparent 60%),
        radial-gradient(850px 340px at 78% 40%, #89f0d118, transparent 60%),
        radial-gradient(1000px 420px at 50% 120%, #c3a1ff14, transparent 55%),
        linear-gradient(180deg, #13163a, #0f1232);
    }

    /* CRT scanlines + slight bloom */
    .bar::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.04),
          rgba(255,255,255,0.04) 1px,
          rgba(0,0,0,0.0) 2px,
          rgba(0,0,0,0.0) 4px
        );
      opacity:.45;
      pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 1;
    }
    .bar::after{
      content:"";
      position:absolute; inset:-30px;
      background: radial-gradient(900px 220px at 50% 20%, #ffffff22, transparent 60%);
      filter: blur(12px);
      opacity:.35;
      pointer-events:none;
      z-index: 1;
    }

    .header {
      height: var(--hdrH);
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 10px 14px;
      position: relative;
      z-index: 2;
      border-bottom: 1px solid #ffffff22;
      background:
        linear-gradient(90deg, #ffb48a66, #c3a1ff55 35%, #86b7ff55 60%, #89f0d155),
        linear-gradient(180deg, #ffffff12, #00000000);
    }

    .brand {
      display:flex;
      align-items: baseline;
      gap: 10px;
    }
    .brand .logo {
      font-family: var(--font-retro);
      font-size: 40px;
      letter-spacing: 2px;
      line-height: 1;
      text-shadow: 0 2px 0 #00000055;
    }
    .brand .sub {
      font-family: var(--font-retro);
      font-size: 22px;
      opacity: .9;
      letter-spacing: 1px;
    }

    .meta {
      display:flex;
      align-items:center;
      gap: 14px;
      font-family: var(--font-retro);
      font-size: 22px;
      letter-spacing: 1px;
      text-shadow: 0 2px 0 #00000055;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #00000033;
      border: 1px solid #ffffff33;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 0 3px #ffffff15, 0 0 16px var(--ok);
    }
    .dot.bad { background: var(--danger); box-shadow: 0 0 0 3px #ffffff15, 0 0 16px var(--danger); }

    .retroBadge {
      border-radius: 10px;
      padding: 6px 10px;
      background: #0a0d24aa;
      border: 1px solid #ffffff2a;
      box-shadow: inset 0 0 0 1px #ffffff12;
    }
    .retroBadge b { color: var(--lemon); }

    .main {
      height: calc(100% - var(--hdrH) - var(--tickerH));
      padding: var(--pad);
      display: grid;
      grid-template-columns: 1.05fr 1.6fr 1fr 0.95fr;
      gap: 12px;
      position: relative;
      z-index: 2;
    }

    .panel {
      background: linear-gradient(180deg, #ffffff14, #ffffff08);
      border: 1px solid #ffffff20;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: inset 0 0 0 1px #0000002a;
      position: relative;
    }

    .panelTitle {
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #ffffff22;
      background:
        linear-gradient(90deg, #86b7ff30, #c3a1ff24, #ff8fd120),
        linear-gradient(180deg, #ffffff14, #00000000);
    }
    .panelTitle h3 {
      margin: 0;
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
    }
    .panelTitle small {
      font-family: var(--font-retro);
      font-size: 18px;
      opacity: .85;
      letter-spacing: .5px;
    }

    /* Alerts list */
    .alerts {
      padding: 10px 12px 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .alert {
      display:grid;
      grid-template-columns: 34px 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: var(--radius2);
      background: #00000022;
      border: 1px solid #ffffff1e;
      min-height: 64px;
    }
    .alert .icon {
      width: 34px; height: 34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      font-family: var(--font-retro);
      font-size: 22px;
      color: #0b0f2a;
      box-shadow: inset 0 0 0 1px #00000025;
    }
    .alert .text .top {
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 14px;
      line-height: 1.1;
    }
    .alert .text .sub {
      opacity:.85;
      font-size: 12px;
      margin-top: 2px;
      line-height: 1.25;
    }
    .alert .tag {
      font-family: var(--font-retro);
      font-size: 18px;
      opacity: .95;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid #ffffff26;
      background: #00000022;
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .a-danger .icon{ background: var(--danger); }
    .a-warn .icon{ background: var(--warn); }
    .a-ok .icon{ background: var(--mint); }

    /* Map panel */
    .mapWrap {
      padding: 10px 12px 12px;
      height: 100%;
      display:grid;
      grid-template-rows: 1fr auto;
      gap: 10px;
    }

    .mapCanvas {
      border-radius: var(--radius2);
      background:
        radial-gradient(600px 220px at 60% 30%, #89f0d11a, transparent 55%),
        radial-gradient(520px 240px at 30% 70%, #ffb48a18, transparent 60%),
        linear-gradient(180deg, #0c1030, #0a0d24);
      border: 1px solid #ffffff1f;
      overflow: hidden;
      position: relative;
    }

    .incidentBadge {
      position:absolute;
      top: 10px; left: 10px;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #ff5b6e22;
      border: 1px solid #ff5b6e55;
      font-family: var(--font-retro);
      font-size: 20px;
      letter-spacing: 1px;
      box-shadow: 0 8px 18px #00000055;
      z-index: 5;
    }
    .incidentBadge .tri{
      width: 18px; height: 18px;
      background: var(--danger);
      clip-path: polygon(50% 0%, 100% 85%, 0% 85%);
      box-shadow: 0 0 12px #ff5b6e88;
    }

    /* breaking overlay */
    .breaking {
      position:absolute;
      inset: 10px 10px auto 10px;
      display:none;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(90deg, #ff5b6e55, #ff8fd133);
      border: 1px solid #ff5b6e88;
      box-shadow: 0 10px 24px #00000066;
      z-index: 6;
      backdrop-filter: blur(4px);
    }
    .breaking .left {
      display:flex;
      align-items:center;
      gap: 10px;
      font-family: var(--font-retro);
      font-size: 24px;
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .breaking .msg {
      font-family: var(--font-ui);
      font-weight: 800;
      font-size: 13px;
      opacity: .95;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    .breaking .blink {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 18px var(--danger);
      animation: blink 0.8s linear infinite;
    }
    @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:.2} }

    .mapLegend {
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .stat {
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background: #00000022;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat .k {
      font-family: var(--font-retro);
      font-size: 18px;
      letter-spacing: 1px;
      opacity: .9;
    }
    .stat .v {
      font-weight: 900;
      font-size: 16px;
    }
    .stat .v b{
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
      color: var(--lemon);
      text-shadow: 0 2px 0 #00000055;
    }

    /* Weather + Live cam */
    .weatherWrap{
      padding: 10px 12px 12px;
      display:grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      height: 100%;
    }
    .weatherStats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .ws {
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background: #00000022;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-height: 62px;
    }
    .ws .lbl{
      font-family: var(--font-retro);
      font-size: 18px;
      letter-spacing: 1px;
      opacity:.9;
    }
    .ws .val{
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
      color: var(--mint);
      text-shadow: 0 2px 0 #00000055;
    }

    .cam {
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      overflow:hidden;
      background: #00000022;
      position: relative;
      min-height: 120px;
    }
    .camHeader{
      position:absolute;
      top: 8px; left: 8px; right: 8px;
      display:flex;
      justify-content: space-between;
      align-items: center;
      z-index: 3;
      pointer-events:none;
    }
    .camHeader .left{
      display:flex; align-items:center; gap:10px;
      font-family: var(--font-retro);
      font-size: 18px;
      letter-spacing: 1px;
      background: #00000055;
      border: 1px solid #ffffff22;
      border-radius: 12px;
      padding: 6px 10px;
      max-width: 68%;
      overflow:hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .livePip{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .livePip .dot{
      width: 8px; height: 8px;
      background: var(--danger);
      box-shadow: 0 0 14px #ff5b6ecc;
    }

    /* real cam image */
    .camImg {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      filter: saturate(1.05) contrast(1.05);
      transform: scale(1.02);
    }
    .camNoise {
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(to bottom, #ffffff10 0, #ffffff10 1px, transparent 2px, transparent 4px),
        radial-gradient(800px 240px at 50% 15%, #ffffff10, transparent 60%);
      opacity:.28;
      mix-blend-mode: overlay;
      pointer-events:none;
      z-index: 2;
    }
    .camFallback {
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      background:
        radial-gradient(900px 260px at 60% 70%, #ffb48a22, transparent 55%),
        radial-gradient(700px 240px at 30% 50%, #86b7ff1f, transparent 60%),
        linear-gradient(180deg, #0b0f2b, #070a1d);
      color: #ffffffcc;
      font-family: var(--font-retro);
      font-size: 26px;
      letter-spacing: 1px;
    }

    /* Right column = camera carousel (replaces rest stop) */
    .camListWrap{
      padding: 10px 12px 12px;
      height: 100%;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .camList{
      display:flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
      flex: 1;
    }
    .camItem{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: var(--radius2);
      border: 1px solid #ffffff1f;
      background: #00000022;
      min-height: 52px;
    }
    .camItem .name{
      font-weight: 900;
      font-size: 13px;
      line-height: 1.2;
      overflow:hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .camItem .meta{
      font-family: var(--font-retro);
      font-size: 18px;
      letter-spacing: 1px;
      opacity: .9;
      white-space: nowrap;
    }
    .camItem.active{
      border-color: #ffe27a66;
      box-shadow: 0 0 0 2px #ffe27a22 inset;
      background: linear-gradient(180deg, #ffe27a10, #00000022);
    }

    /* Ticker */
    .ticker {
      height: var(--tickerH);
      border-top: 1px solid #ffffff22;
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap: 10px;
      padding: 8px 12px;
      position: relative;
      z-index: 2;
      background:
        linear-gradient(90deg, #86b7ff2a, #ff8fd124 45%, #89f0d124),
        linear-gradient(180deg, #00000000, #00000022);
    }

    .tickerBrand {
      font-family: var(--font-retro);
      font-size: 34px;
      letter-spacing: 2px;
      padding: 6px 10px;
      border-radius: 14px;
      border: 1px solid #ffffff24;
      background: #00000022;
      text-shadow: 0 2px 0 #00000055;
    }

    .tickerLine {
      overflow: hidden;
      white-space: nowrap;
      border-radius: 14px;
      border: 1px solid #ffffff24;
      background: #00000022;
      height: 100%;
      display:flex;
      align-items:center;
      position: relative;
    }
    .tickerLine span {
      display:inline-block;
      padding-left: 100%;
      font-family: var(--font-retro);
      font-size: 24px;
      letter-spacing: 1px;
      animation: scroll 18s linear infinite;
      text-shadow: 0 2px 0 #00000055;
    }
    @keyframes scroll{
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .clockBox {
      font-family: var(--font-retro);
      font-size: 34px;
      letter-spacing: 2px;
      padding: 6px 12px;
      border-radius: 14px;
      border: 1px solid #ffffff24;
      background: #00000022;
      text-shadow: 0 2px 0 #00000055;
      color: var(--lemon);
    }

    /* SVG map styles */
    svg { width: 100%; height: 100%; display:block; }
    .grid { opacity: .18; }
    .road { fill: none; stroke-linecap: round; stroke-linejoin: round; }
    .r-main { stroke-width: 9; }
    .r-mid  { stroke-width: 7; }
    .r-min  { stroke-width: 4; opacity: .85; }
    .r-green { stroke: var(--ok); filter: drop-shadow(0 0 8px #60ffb033); }
    .r-yellow{ stroke: var(--warn); filter: drop-shadow(0 0 10px #ffbf4a2a); }
    .r-red   { stroke: var(--danger); filter: drop-shadow(0 0 10px #ff5b6e2a); }
    .pin text { font-family: var(--font-retro); font-size: 18px; fill: #0b0f2a; }
    .pin rect { fill: var(--lemon); stroke: #00000055; stroke-width: 1; rx: 6; }
    .pin .n { font-size: 20px; }
  </style>
</head>

<body>
  <div id="stage">
    <div id="canvas">
      <div class="bar" role="img" aria-label="AZ NOW live traffic and weather dashboard">
        <!-- HEADER -->
        <div class="header">
          <div class="brand">
            <div class="logo">AZ NOW</div>
            <div class="sub">LIVE TRAFFIC + ROAD WEATHER</div>
          </div>

          <div class="meta">
            <div class="pill"><span class="dot" id="liveDot"></span><span id="liveLabel">LIVE</span></div>
            <div class="pill" id="datePill">—</div>
            <div class="retroBadge">RETRO <b>8s</b> LIVE</div>
          </div>
        </div>

        <!-- MAIN GRID -->
        <div class="main">
          <!-- TRAFFIC ALERTS -->
          <section class="panel">
            <div class="panelTitle">
              <h3>TRAFFIC ALERTS</h3>
              <small id="alertsCount">—</small>
            </div>
            <div class="alerts" id="alertsList"></div>
          </section>

          <!-- PHOENIX TRAFFIC MAP -->
          <section class="panel">
            <div class="panelTitle">
              <h3>PHOENIX TRAFFIC MAP</h3>
              <small id="updateLabel">LIVE UPDATE: <span id="updateClock">—</span></small>
            </div>

            <div class="mapWrap">
              <div class="mapCanvas">
                <div class="breaking" id="breaking">
                  <div class="left"><span class="blink"></span>BREAKING</div>
                  <div class="msg" id="breakingMsg">—</div>
                </div>

                <div class="incidentBadge"><span class="tri"></span><span id="incidentCount">—</span></div>

                <!-- Fake “map” as SVG (kept stylized; we just update badges/alerts/cams for now) -->
                <svg viewBox="0 0 900 320" preserveAspectRatio="none" aria-hidden="true">
                  <g class="grid">
                    <path d="M0 40 H900 M0 80 H900 M0 120 H900 M0 160 H900 M0 200 H900 M0 240 H900 M0 280 H900" stroke="#ffffff" stroke-width="1"/>
                    <path d="M60 0 V320 M120 0 V320 M180 0 V320 M240 0 V320 M300 0 V320 M360 0 V320 M420 0 V320 M480 0 V320 M540 0 V320 M600 0 V320 M660 0 V320 M720 0 V320 M780 0 V320 M840 0 V320" stroke="#ffffff" stroke-width="1"/>
                  </g>

                  <path class="road r-main r-green" d="M40 210 C 190 190, 330 190, 500 205 S 760 235, 860 220" />
                  <path class="road r-mid r-yellow" d="M90 80 C 180 120, 260 150, 360 160 S 560 160, 720 120 S 820 90, 880 100" />
                  <path class="road r-mid r-red" d="M120 300 C 250 250, 320 235, 420 230 S 600 230, 720 260 S 830 300, 890 290" />
                  <path class="road r-min r-green" d="M260 40 C 280 110, 290 170, 300 320" />
                  <path class="road r-min r-yellow" d="M560 20 C 540 80, 520 160, 520 320" />
                  <path class="road r-min r-green" d="M740 40 C 700 120, 690 190, 680 320" />

                  <g class="pin" transform="translate(340,145)">
                    <rect x="-16" y="-16" width="32" height="26"></rect>
                    <text class="n" x="0" y="3" text-anchor="middle">3</text>
                  </g>
                  <g class="pin" transform="translate(600,120)">
                    <rect x="-16" y="-16" width="32" height="26"></rect>
                    <text class="n" x="0" y="3" text-anchor="middle">3</text>
                  </g>
                  <g class="pin" transform="translate(690,205)">
                    <rect x="-16" y="-16" width="32" height="26"></rect>
                    <text class="n" x="0" y="3" text-anchor="middle">1</text>
                  </g>

                  <path d="M0 320 L0 260 L60 260 L60 240 L90 240 L90 265 L125 265 L125 230 L150 230 L150 250 L180 250 L180 220 L210 220 L210 260 L250 260 L250 235 L280 235 L280 265 L330 265 L330 245 L360 245 L360 260 L420 260 L420 235 L470 235 L470 250 L520 250 L520 235 L560 235 L560 260 L620 260 L620 240 L650 240 L650 265 L690 265 L690 230 L730 230 L730 260 L780 260 L780 245 L820 245 L820 260 L900 260 L900 320 Z"
                        fill="#ff8fd10f"/>
                </svg>
              </div>

              <div class="mapLegend">
                <div class="stat">
                  <div class="k">I-10 TO DOWNTOWN</div>
                  <div class="v"><b id="eta1">—</b> mins</div>
                </div>
                <div class="stat">
                  <div class="k">I-17 TO SKY HARBOR</div>
                  <div class="v"><b id="eta2">—</b> mins</div>
                </div>
                <div class="stat">
                  <div class="k">BEST DEPARTURE IN</div>
                  <div class="v"><b id="bestDep">—</b> mins</div>
                </div>
              </div>
            </div>
          </section>

          <!-- ROAD WEATHER + LIVE CAM -->
          <section class="panel">
            <div class="panelTitle">
              <h3>ROAD WEATHER</h3>
              <small>STATION: <span id="stationName">—</span></small>
            </div>

            <div class="weatherWrap">
              <div class="weatherStats">
                <div class="ws">
                  <div class="lbl">TEMP</div>
                  <div class="val"><span id="temp">—</span>°</div>
                </div>
                <div class="ws">
                  <div class="lbl">WIND</div>
                  <div class="val"><span id="wind">—</span> mph</div>
                </div>
                <div class="ws">
                  <div class="lbl">SURFACE</div>
                  <div class="val" style="color:var(--lemon)"><span id="surface">—</span></div>
                </div>
                <div class="ws">
                  <div class="lbl">GRIP</div>
                  <div class="val"><span id="grip">—</span></div>
                </div>
              </div>

              <div class="cam" id="camBox">
                <div class="camHeader">
                  <div class="left">
                    <span class="livePip"><span class="dot"></span>LIVE CAM</span>
                    <span id="camLabel">—</span>
                  </div>
                  <div class="left">NEXT: <span id="camNext">—</span></div>
                </div>

                <div class="camFallback" id="camFallback">LOADING CAM…</div>
                <img class="camImg" id="camImg" alt="AZ511 Camera" style="display:none" />
                <div class="camNoise"></div>
              </div>
            </div>
          </section>

          <!-- CAMERA CAROUSEL (replaces rest stop) -->
          <section class="panel">
            <div class="panelTitle">
              <h3>CAMERA CAROUSEL</h3>
              <small><span id="camCount">—</span> FEEDS</small>
            </div>

            <div class="camListWrap">
              <div class="camList" id="camList"></div>
            </div>
          </section>
        </div>

        <!-- TICKER -->
        <div class="ticker">
          <div class="tickerBrand">AZ NOW</div>

          <div class="tickerLine" aria-label="Scrolling ticker">
            <span id="tickerText">CONNECTING TO AZ511…</span>
          </div>

          <div class="clockBox" id="clock">—</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     * CONFIG
     ******************************************************************/
    const AZNOW = {
      // ✅ Paste your key here
      API_KEY: "PASTE_YOUR_AZ511_KEY_HERE",

      // If CORS ever blocks direct fetches, set PROXY_BASE to your own proxy URL.
      // Example: "https://your-worker.yourdomain.workers.dev"
      // (Then requests go to `${PROXY_BASE}/api/v2/get/event?...`)
      PROXY_BASE: "",

      FORMAT: "json",

      // Phoenix-ish bounding box (filters cams & stations to “metro” vibe)
      // Adjust if you want broader (e.g., cover all AZ)
      BBOX: {
        minLat: 33.0,
        maxLat: 34.2,
        minLon: -112.9,
        maxLon: -111.2
      },

      // Polling cadence (be nice to rate limits)
      POLL_MS: 45000,       // events/weather refresh
      CAM_ROTATE_MS: 12000, // camera rotation

      MAX_ALERTS: 4,
      CAM_LIST_SIZE: 7,

      // If you want: force these camera IDs to the front of the rotation
      FAVORITE_CAM_IDS: [
        // "1234", "5678"
      ]
    };

    /******************************************************************
     * FULLSCREEN CONTAIN SCALING (no cropping)
     ******************************************************************/
    const stage = document.getElementById("stage");
    const canvas = document.getElementById("canvas");

    function fitContain(){
      const sw = stage.clientWidth;
      const sh = stage.clientHeight;
      const scale = Math.min(sw / 2560, sh / 720);
      const x = Math.floor((sw - 2560 * scale) / 2);
      const y = Math.floor((sh - 720 * scale) / 2);
      canvas.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
    }
    window.addEventListener("resize", fitContain);
    fitContain();

    /******************************************************************
     * HELPERS
     ******************************************************************/
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2, "0");

    function setLive(ok){
      const dot = $("liveDot");
      const lbl = $("liveLabel");
      if(ok){
        dot.classList.remove("bad");
        lbl.textContent = "LIVE";
      } else {
        dot.classList.add("bad");
        lbl.textContent = "OFFLINE";
      }
    }

    function setDatePill(){
      const d = new Date();
      const days = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];
      const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
      $("datePill").textContent = `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    }

    function updateClock(){
      const d = new Date();
      const h24 = d.getHours();
      const m = d.getMinutes();
      const ampm = h24 >= 12 ? "PM" : "AM";
      const h = ((h24 + 11) % 12) + 1;
      $("clock").textContent = `${h}:${pad2(m)} ${ampm}`;
    }

    function inBbox(lat, lon){
      if(lat == null || lon == null) return false;
      const b = AZNOW.BBOX;
      return lat >= b.minLat && lat <= b.maxLat && lon >= b.minLon && lon <= b.maxLon;
    }

    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (x) => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function sanitizeText(s){
      return String(s ?? "").replace(/\s+/g, " ").trim();
    }

    function pick(obj, keys){
      for(const k of keys){
        if(obj && obj[k] != null && obj[k] !== "") return obj[k];
      }
      return null;
    }

    // Deep-find an array that "looks like" items with certain fields
    function deepFindArray(root, fieldHints){
      const seen = new Set();
      function walk(node){
        if(!node || typeof node !== "object") return null;
        if(seen.has(node)) return null;
        seen.add(node);

        if(Array.isArray(node)){
          // if array of objects and any object contains a hint field
          const ok = node.some(x => x && typeof x === "object" && fieldHints.some(f => f in x));
          if(ok) return node;
          for(const item of node){
            const found = walk(item);
            if(found) return found;
          }
          return null;
        }

        for(const k of Object.keys(node)){
          const found = walk(node[k]);
          if(found) return found;
        }
        return null;
      }
      return walk(root);
    }

    async function fetchJSON(url, timeoutMs=12000){
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        // sometimes APIs return JSON already; sometimes as string
        try { return JSON.parse(txt); } catch { return txt; }
      } finally {
        clearTimeout(t);
      }
    }

    function apiUrl(endpoint){
      const base = AZNOW.PROXY_BASE
        ? `${AZNOW.PROXY_BASE}/api/v2/get/${endpoint}`
        : `https://az511.com/api/v2/get/${endpoint}`;
      const u = new URL(base);
      u.searchParams.set("key", AZNOW.API_KEY);
      u.searchParams.set("format", AZNOW.FORMAT);
      return u.toString();
    }

    /******************************************************************
     * LIVE DATA STATEe
     ******************************************************************/
    let state = {
      cams: [],
      camIdx: 0,
      camTimer: null,
      lastEventIds: new Set()
    };

    /******************************************************************
     * RENDER: ALERTS
     ******************************************************************/
    function severityToClass(sev){
      // We don't know AZ511's exact scale; handle common patterns
      if(sev == null) return "a-warn";
      const n = Number(sev);
      if(Number.isFinite(n)){
        if(n >= 3) return "a-danger";
        if(n === 2) return "a-warn";
        return "a-ok";
      }
      const s = String(sev).toLowerCase();
      if(s.includes("high") || s.includes("major")) return "a-danger";
      if(s.includes("med") || s.includes("moder")) return "a-warn";
      return "a-ok";
    }

    function eventIcon(type){
      const t = String(type ?? "").toLowerCase();
      if(t.includes("accident") || t.includes("crash") || t.includes("collision")) return "!";
      if(t.includes("closure") || t.includes("closed")) return "⛔";
      if(t.includes("construction") || t.includes("work")) return "⛏";
      if(t.includes("weather") || t.includes("storm") || t.includes("dust") || t.includes("wind")) return "☁";
      if(t.includes("congestion") || t.includes("slow")) return "≋";
      return "ℹ";
    }

    function renderAlerts(events){
      const list = $("alertsList");
      list.innerHTML = "";

      const shown = events.slice(0, AZNOW.MAX_ALERTS);
      $("alertsCount").textContent = `${shown.length} ITEMS`;

      for(const e of shown){
        const type = sanitizeText(pick(e, ["EventType", "EventTypeName", "Type", "TypeName", "EventCategory", "Category", "eventType"]));
        const road = sanitizeText(pick(e, ["RoadwayName", "RoadName", "Roadway", "Route", "route", "Road"]));
        const dir  = sanitizeText(pick(e, ["DirectionOfTravel", "Direction", "Dir"]));
        const desc = sanitizeText(pick(e, ["Description", "EventDescription", "PublicDescription", "FullDescription", "ShortDescription", "Summary"]));
        const sev  = pick(e, ["Severity", "SeverityLevel", "severity", "Level"]);

        const top = type || (desc ? desc.split(" — ")[0] : "EVENT");
        const subParts = [];
        if(road) subParts.push(road);
        if(dir) subParts.push(dir);
        if(desc) subParts.push(desc);
        const sub = subParts.join(" — ").slice(0, 140);

        const cls = severityToClass(sev);
        const tagTxt = (sev != null && String(sev).trim() !== "")
          ? `SEV ${sev}`
          : (type ? type.toUpperCase().slice(0,8) : "INFO");

        const el = document.createElement("div");
        el.className = `alert ${cls}`;
        el.innerHTML = `
          <div class="icon">${eventIcon(type || desc)}</div>
          <div class="text">
            <div class="top">${escapeHtml(top)}</div>
            <div class="sub">${escapeHtml(sub || "—")}</div>
          </div>
          <div class="tag">${escapeHtml(tagTxt)}</div>
        `;
        list.appendChild(el);
      }
    }

    /******************************************************************
     * RENDER: BREAKING + TICKER
     ******************************************************************/
    let breakingHideTimer = null;
    function showBreaking(message){
      const box = $("breaking");
      $("breakingMsg").textContent = message;
      box.style.display = "flex";
      if(breakingHideTimer) clearTimeout(breakingHideTimer);
      breakingHideTimer = setTimeout(() => { box.style.display = "none"; }, 12000);
    }

    function setTicker(text){
      $("tickerText").textContent = text || "—";
    }

    /******************************************************************
     * CAMERAS
     ******************************************************************/
    function cameraName(cam){
      return sanitizeText(
        pick(cam, ["Location", "Name", "Title", "Roadway", "RoadwayName", "CrossStreet", "Description"]) ||
        `CAM ${pick(cam, ["Id","ID","CameraId","CameraID"]) || "—"}`
      );
    }

    function cameraLatLon(cam){
      const lat = Number(pick(cam, ["Latitude", "Lat", "latitude"]));
      const lon = Number(pick(cam, ["Longitude", "Lon", "longitude"]));
      return { lat: Number.isFinite(lat) ? lat : null, lon: Number.isFinite(lon) ? lon : null };
    }

    function cameraBestUrl(cam){
      // Most AZ511 camera objects include Views[] with Url
      const views = pick(cam, ["Views", "View", "CameraViews", "views"]);
      if(Array.isArray(views) && views.length){
        const u = pick(views[0], ["Url", "URL", "url", "ImageUrl", "ImageURL"]);
        if(u) return u;
      }
      // sometimes it's directly present
      return pick(cam, ["Url", "URL", "url", "ImageUrl", "ImageURL"]);
    }

    function renderCamList(cams, activeIdx){
      const list = $("camList");
      list.innerHTML = "";

      const slice = cams.slice(0, AZNOW.CAM_LIST_SIZE);
      $("camCount").textContent = String(cams.length);

      slice.forEach((cam, i) => {
        const item = document.createElement("div");
        item.className = `camItem ${i === activeIdx ? "active" : ""}`;
        const nm = cameraName(cam);
        const id = pick(cam, ["Id","ID","CameraId","CameraID"]);
        item.innerHTML = `
          <div class="name">${escapeHtml(nm)}</div>
          <div class="meta">${escapeHtml(id ?? "")}</div>
        `;
        list.appendChild(item);
      });
    }

    function setActiveCamera(cam){
      const url = cameraBestUrl(cam);
      const nm = cameraName(cam);

      $("camLabel").textContent = nm || "—";

      const img = $("camImg");
      const fb  = $("camFallback");

      if(!url){
        img.style.display = "none";
        fb.style.display = "grid";
        fb.textContent = "NO CAMERA URL";
        return;
      }

      // cache-bust so it refreshes like a feed
      const busted = url.includes("?") ? `${url}&_=${Date.now()}` : `${url}?_=${Date.now()}`;

      img.onload = () => {
        fb.style.display = "none";
        img.style.display = "block";
      };
      img.onerror = () => {
        img.style.display = "none";
        fb.style.display = "grid";
        fb.textContent = "CAM LOAD FAIL";
      };

      img.src = busted;
    }

    function startCameraRotation(){
      if(state.camTimer) clearInterval(state.camTimer);
      state.camTimer = setInterval(() => rotateCamera(), AZNOW.CAM_ROTATE_MS);
    }

    function rotateCamera(){
      if(!state.cams.length) return;
      state.camIdx = (state.camIdx + 1) % Math.min(state.cams.length, AZNOW.CAM_LIST_SIZE);
      const cam = state.cams[state.camIdx];
      setActiveCamera(cam);
      renderCamList(state.cams, state.camIdx);
    }

    function jumpToNearestCamera(lat, lon){
      if(!state.cams.length || lat == null || lon == null) return;
      let bestI = 0, bestD = Infinity;
      for(let i=0;i<state.cams.length;i++){
        const p = cameraLatLon(state.cams[i]);
        if(p.lat == null || p.lon == null) continue;
        const d = haversineKm(lat, lon, p.lat, p.lon);
        if(d < bestD){
          bestD = d;
          bestI = i;
        }
      }
      state.camIdx = bestI;
      const cam = state.cams[state.camIdx];
      setActiveCamera(cam);
      renderCamList(state.cams, state.camIdx);
    }

    /******************************************************************
     * WEATHER
     ******************************************************************/
    function stationName(st){
      return sanitizeText(pick(st, ["StationName", "Name", "StationId", "StationID", "ID", "Id"])) || "—";
    }

    function stationLatLon(st){
      const lat = Number(pick(st, ["Latitude", "Lat", "latitude"]));
      const lon = Number(pick(st, ["Longitude", "Lon", "longitude"]));
      return { lat: Number.isFinite(lat) ? lat : null, lon: Number.isFinite(lon) ? lon : null };
    }

    function renderWeather(st){
      $("stationName").textContent = stationName(st);

      // Try common weather fields; if different, you’ll still see something rather than blank
      const temp = pick(st, ["AirTemperature", "Temperature", "TempF", "Temp", "temp"]);
      const wind = pick(st, ["WindSpeed", "WindMph", "Wind", "wind"]);
      const surf = pick(st, ["SurfaceCondition", "Surface", "PavementCondition", "RoadCondition", "surface"]);
      const grip = pick(st, ["Grip", "Friction", "RoadFriction", "grip"]);

      $("temp").textContent = temp != null ? String(Math.round(Number(temp))) : "—";
      $("wind").textContent = wind != null ? String(Math.round(Number(wind))) : "—";
      $("surface").textContent = surf != null ? sanitizeText(surf).toUpperCase().slice(0,12) : "—";
      $("grip").textContent = grip != null ? sanitizeText(grip).toUpperCase().slice(0,12) : "—";
    }

    /******************************************************************
     * EVENTS: normalize + detect “new”
     ******************************************************************/
    function normalizeEvents(raw){
      if(!raw || typeof raw !== "object") return [];

      const arr =
        deepFindArray(raw, ["RoadwayName","EventType","Description","Severity","DirectionOfTravel","RoadName","Roadway"]) ||
        deepFindArray(raw, ["eventType","description","severity","latitude","longitude"]) ||
        [];

      // Filter to metro-ish events if they have coords
      const filtered = arr.filter(e => {
        const lat = Number(pick(e, ["Latitude","Lat","latitude"]));
        const lon = Number(pick(e, ["Longitude","Lon","longitude"]));
        if(Number.isFinite(lat) && Number.isFinite(lon)) return inBbox(lat, lon);
        // if no coords, keep (we'll still show)
        return true;
      });

      // Best-effort sort by severity desc, then "updated/created" if present
      filtered.sort((a,b) => {
        const sa = Number(pick(a, ["Severity","SeverityLevel","severity"])) || 0;
        const sb = Number(pick(b, ["Severity","SeverityLevel","severity"])) || 0;
        if(sb !== sa) return sb - sa;
        const ta = Date.parse(pick(a, ["LastUpdated","UpdateTime","StartTime","Created","created","Timestamp"]) || "") || 0;
        const tb = Date.parse(pick(b, ["LastUpdated","UpdateTime","StartTime","Created","created","Timestamp"]) || "") || 0;
        return tb - ta;
      });

      return filtered;
    }

    function eventId(e){
      return String(pick(e, ["ID","Id","EventId","EventID","eventId","Guid","GUID"]) ?? "");
    }

    function eventLatLon(e){
      const lat = Number(pick(e, ["Latitude","Lat","latitude"]));
      const lon = Number(pick(e, ["Longitude","Lon","longitude"]));
      return { lat: Number.isFinite(lat) ? lat : null, lon: Number.isFinite(lon) ? lon : null };
    }

    function buildBreakingMessage(e){
      const type = sanitizeText(pick(e, ["EventType","EventTypeName","Type","TypeName","eventType"]));
      const road = sanitizeText(pick(e, ["RoadwayName","RoadName","Roadway","Route","Road"]));
      const dir  = sanitizeText(pick(e, ["DirectionOfTravel","Direction","Dir"]));
      const desc = sanitizeText(pick(e, ["Description","PublicDescription","ShortDescription","Summary","EventDescription"]));
      const bits = [];
      if(type) bits.push(type.toUpperCase());
      if(road) bits.push(road);
      if(dir)  bits.push(dir);
      if(desc) bits.push(desc);
      return bits.join(" — ").slice(0, 140);
    }

    /******************************************************************
     * API LOOPS
     ******************************************************************/
    let countdown = 27;
    function tickCountdown(){
      countdown--;
      if(countdown <= 0) countdown = Math.round(AZNOW.POLL_MS / 1000);
      $("updateClock").textContent = `00:${pad2(countdown % 60)}`;
      $("camNext").textContent = `00:${pad2(countdown % 60)}`;
    }

    async function loadCameras(){
      const raw = await fetchJSON(apiUrl("cameras"));
      const arr =
        deepFindArray(raw, ["Views","Url","Latitude","Longitude","Location","Roadway"]) ||
        deepFindArray(raw, ["views","url","latitude","longitude"]) ||
        [];

      let cams = arr.map(c => c);

      // filter to metro
      cams = cams.filter(c => {
        const p = cameraLatLon(c);
        return (p.lat != null && p.lon != null) ? inBbox(p.lat, p.lon) : true;
      });

      // favorites first
      if(AZNOW.FAVORITE_CAM_IDS && AZNOW.FAVORITE_CAM_IDS.length){
        const fav = new Set(AZNOW.FAVORITE_CAM_IDS.map(String));
        cams.sort((a,b) => {
          const ia = String(pick(a, ["Id","ID","CameraId","CameraID"]) ?? "");
          const ib = String(pick(b, ["Id","ID","CameraId","CameraID"]) ?? "");
          const af = fav.has(ia) ? 0 : 1;
          const bf = fav.has(ib) ? 0 : 1;
          if(af !== bf) return af - bf;
          return cameraName(a).localeCompare(cameraName(b));
        });
      } else {
        cams.sort((a,b) => cameraName(a).localeCompare(cameraName(b)));
      }

      state.cams = cams;

      // boot active cam
      state.camIdx = 0;
      if(state.cams.length){
        setActiveCamera(state.cams[0]);
        renderCamList(state.cams, 0);
      } else {
        $("camFallback").textContent = "NO CAMS FOUND";
      }

      startCameraRotation();
    }

    async function loadWeather(){
      const raw = await fetchJSON(apiUrl("weatherstations"));
      const arr = deepFindArray(raw, ["AirTemperature","WindSpeed","Latitude","Longitude","StationName","SurfaceCondition"]) || [];

      let stations = arr.map(s => s);

      stations = stations.filter(s => {
        const p = stationLatLon(s);
        return (p.lat != null && p.lon != null) ? inBbox(p.lat, p.lon) : true;
      });

      // pick nearest to Phoenix-ish center
      const center = { lat: 33.4484, lon: -112.0740 };
      let best = stations[0] || null;
      let bestD = Infinity;
      for(const st of stations){
        const p = stationLatLon(st);
        if(p.lat == null || p.lon == null) continue;
        const d = haversineKm(center.lat, center.lon, p.lat, p.lon);
        if(d < bestD){
          bestD = d;
          best = st;
        }
      }

      if(best) renderWeather(best);
      else {
        $("stationName").textContent = "—";
        $("temp").textContent = "—";
        $("wind").textContent = "—";
        $("surface").textContent = "—";
        $("grip").textContent = "—";
      }
    }

    async function loadEvents(){
      const raw = await fetchJSON(apiUrl("event"));
      const events = normalizeEvents(raw);

      // count badge
      $("incidentCount").textContent = events.length ? `${events.length} INCIDENT` : "0 INCIDENT";

      // alerts panel
      renderAlerts(events);

      // ticker summary (top line)
      const top = events[0];
      if(top){
        setTicker(buildBreakingMessage(top) + " • STAY SAFE — DRIVE SMART!");
      } else {
        setTicker("NO MAJOR EVENTS • TRAFFIC LOOKING CLEAN • STAY SAFE — DRIVE SMART!");
      }

      // new event detection
      const newOnes = [];
      for(const e of events){
        const id = eventId(e);
        if(!id) continue;
        if(!state.lastEventIds.has(id)) newOnes.push(e);
      }

      // refresh known IDs (keep it bounded)
      state.lastEventIds = new Set(events.slice(0, 50).map(eventId).filter(Boolean));

      if(newOnes.length){
        const e = newOnes[0];
        showBreaking(buildBreakingMessage(e));

        // jump cam to nearest event location
        const p = eventLatLon(e);
        if(p.lat != null && p.lon != null) jumpToNearestCamera(p.lat, p.lon);
      }
    }

    /******************************************************************
     * HTML escape for safety
     ******************************************************************/
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /******************************************************************
     * BOOT
     ******************************************************************/
    async function boot(){
      setDatePill();
      updateClock();
      setInterval(updateClock, 1000);

      if(!AZNOW.API_KEY || AZNOW.API_KEY.includes("PASTE_YOUR")){
        setLive(false);
        setTicker("ADD YOUR AZ511 API KEY IN AZNOW.API_KEY");
        $("camFallback").textContent = "PASTE API KEY";
        return;
      }

      try{
        setLive(true);
        setTicker("CONNECTING TO AZ511…");

        // init some numbers to avoid blank
        $("eta1").textContent = "32";
        $("eta2").textContent = "25";
        $("bestDep").textContent = "20";

        // cameras first so cam UI feels alive quickly
        await loadCameras();
        await Promise.allSettled([loadWeather(), loadEvents()]);

        // countdown UI
        countdown = Math.round(AZNOW.POLL_MS / 1000);
        $("updateClock").textContent = `00:${pad2(countdown % 60)}`;
        $("camNext").textContent = `00:${pad2(countdown % 60)}`;
        setInterval(tickCountdown, 1000);

        // poll loop
        setInterval(async () => {
          try{
            await Promise.allSettled([loadWeather(), loadEvents()]);
            setLive(true);
          } catch (e){
            console.error("Poll error:", e);
            setLive(false);
            setTicker("AZ511 FETCH ERROR • CHECK KEY / NETWORK / CORS");
          }
        }, AZNOW.POLL_MS);

      } catch (e){
        console.error("Boot error:", e);
        setLive(false);
        setTicker("FAILED TO CONNECT • CHECK KEY / NETWORK / CORS");
        $("camFallback").textContent = "CONNECT FAIL";
      }
    }

    boot();
  </script>
</body>
</html>
