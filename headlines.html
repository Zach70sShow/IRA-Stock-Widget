<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Headline Stream</title>
  <style>
    :root{
      --bg0:#070b0f;
      --bg1:#0a1218;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --accent: #33d1b5;
      --danger: #ff5b6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(51,209,181,.22), transparent 50%),
        radial-gradient(1200px 700px at 90% 10%, rgba(70,140,255,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }
    .wrap{
      height:100%;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .topbar{
      border-radius:28px;
      padding:18px 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
    }
    .time{
      font-size:64px;
      line-height:1;
      letter-spacing:.5px;
      font-weight:800;
      white-space:nowrap;
    }
    .titleBlock{display:flex;flex-direction:column;gap:4px}
    .h1{
      font-size:22px;
      letter-spacing:.18em;
      text-transform:uppercase;
      opacity:.9;
    }
    .h2{
      font-size:18px;
      color:var(--muted);
    }
    .panel{
      flex:1;
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: 0 12px 50px rgba(0,0,0,.38);
      position:relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 500px at 30% 0%, rgba(51,209,181,.14), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.06), transparent 60%),
        repeating-linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.06) 2px, transparent 2px, transparent 12px);
      opacity:.25;
      pointer-events:none;
    }
    .content{
      position:absolute; inset:0;
      padding:26px 28px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .metaRow{
      display:flex;
      align-items:center;
      gap:14px;
      z-index:2;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(51,209,181,.10);
      border:1px solid rgba(51,209,181,.35);
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,.88);
    }
    .src{
      font-size:22px;
      font-weight:700;
      color: var(--muted);
      max-width:60vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      z-index:2;
    }
    .headline{
      font-size:64px;
      line-height:1.05;
      font-weight:900;
      letter-spacing:-.02em;
      z-index:2;
      text-wrap:balance;
    }
    .sub{
      font-size:26px;
      color: var(--muted);
      z-index:2;
    }
    .footer{
      position:absolute;
      left:22px; bottom:16px;
      right:22px;
      display:flex;
      justify-content:space-between;
      color: rgba(255,255,255,.45);
      font-size:13px;
      z-index:2;
    }
    .errorLine{
      color: var(--danger);
      font-weight:800;
    }
    a{color:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="time" id="time">--:--</div>
      <div class="titleBlock">
        <div class="h1">HEADLINE STREAM</div>
        <div class="h2">Markets • Tech • AZ • NFL • World • Editing • Gaming</div>
      </div>
    </div>

    <div class="panel">
      <div class="content">
        <div class="metaRow">
          <div class="pill" id="tag">Loading</div>
          <div class="src" id="src">—</div>
        </div>
        <div class="headline" id="headline">Fetching headlines…</div>
        <div class="sub" id="summary">Option 3 (no AI summaries). Rotates every 90 seconds.</div>
      </div>
      <div class="footer">
        <div id="statusLeft">—</div>
        <div id="statusRight">—</div>
      </div>
    </div>
  </div>

  <script>
    // ✅ Same-origin API URL prevents old pathing/domain issues forever.
    const API = new URL("/api/headlines?limit=60&reddit=1", window.location.origin).toString();

    const ROTATE_MS = 90_000;   // 1.5 minutes
    const REFRESH_MS = 5 * 60_000; // refresh list every 5 minutes

    let items = [];
    let idx = 0;
    let lastFetch = 0;

    const $ = (id) => document.getElementById(id);

    function fmtTime(d){
      const h = d.getHours();
      const m = String(d.getMinutes()).padStart(2,"0");
      const h12 = ((h + 11) % 12) + 1;
      const ampm = h >= 12 ? "PM" : "AM";
      return `${h12}:${m} ${ampm}`;
    }

    function tickClock(){
      $("time").textContent = fmtTime(new Date());
    }

    async function fetchHeadlines(){
      const t0 = performance.now();
      $("statusLeft").textContent = "Updating feeds…";

      let res, text;
      try {
        res = await fetch(API, { cache: "no-store" });
        text = await res.text();
      } catch (err) {
        showError(`Network error: ${err?.message || err}`);
        return;
      }

      // If it’s HTML, show a helpful error instead of JSON.parse exploding.
      const looksLikeHTML = /^\s*</.test(text) && /<!doctype|<html/i.test(text);
      if (looksLikeHTML) {
        showError(`API returned HTML (wrong route). Status ${res.status}. First line: ${text.split("\n")[0].slice(0,120)}`);
        return;
      }

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        showError(`Invalid JSON. Status ${res.status}. First 120 chars: ${text.slice(0,120)}`);
        return;
      }

      if (!res.ok || !data?.ok) {
        showError(`API error. Status ${res.status}. ${data?.error || "Unknown error"}`);
        return;
      }

      items = Array.isArray(data.items) ? data.items : [];
      lastFetch = Date.now();

      const ms = Math.round(performance.now() - t0);
      $("statusLeft").textContent = `Loaded ${items.length} items • ${ms}ms`;
      $("statusRight").textContent = `Source: /api/headlines`;

      if (items.length) {
        idx = idx % items.length;
        render(items[idx]);
      } else {
        showError("No items returned (feeds may be blocking or empty).");
      }
    }

    function render(item){
      $("tag").textContent = item.tag || "NEWS";
      $("src").textContent = item.source || "—";
      $("headline").textContent = item.title || "—";

      // Option 3: no AI summary. Just show the URL host as “context”.
      try {
        const u = new URL(item.url);
        $("summary").textContent = `Read: ${u.hostname}`;
      } catch {
        $("summary").textContent = "Read: —";
      }

      $("statusRight").innerHTML = item.url
        ? `<a href="${item.url}" target="_blank" rel="noopener">Open</a>`
        : `—`;
    }

    function showError(msg){
      $("tag").textContent = "ERROR";
      $("src").textContent = "—";
      $("headline").textContent = "Couldn't load headlines";
      $("summary").innerHTML = `<span class="errorLine">${escapeHtml(msg)}</span>`;
      $("statusLeft").textContent = "Check /api/headlines route + Functions deploy";
      $("statusRight").textContent = "—";
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function rotate(){
      if (!items.length) return;
      idx = (idx + 1) % items.length;
      render(items[idx]);
    }

    // Clock
    tickClock();
    setInterval(tickClock, 1000);

    // Rotation
    setInterval(rotate, ROTATE_MS);

    // Refresh loop (keeps things fresh)
    setInterval(() => {
      if (Date.now() - lastFetch > REFRESH_MS - 5_000) fetchHeadlines();
    }, 30_000);

    // Initial load
    fetchHeadlines();
  </script>
</body>
</html>
